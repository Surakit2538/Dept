<!-- 
    Mobile-First Expense Tracker (V57 - Fix Init Error)
    Project: deptmoney-6682a
    Updates:
    1. Fixed: Removed JS reference to deleted 'api-endpoint-url' element in init() to prevent TypeError.
-->

<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Dept Money</title>

    <link rel="icon" type="image/png"
        href="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png">
    <link rel="apple-touch-icon" href="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png">
    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js & DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Noto Sans Thai -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- 3D Login Enhancement CSS -->
    <link rel="stylesheet" href="login-assets/login-3d.css">

    <style>
        :root {
            /* Premium Dark Theme Variables */
            --bg-base: #0a0a0c;
            /* Deep black background */
            --bg-card: #1c1c1e;
            /* Dark gray for cards */
            --bg-card-hover: #2c2c2e;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --accent-brand: #ffffff;
            /* White buttons / icons in some places */
            --accent-gradient-1: #4B6CB7;
            /* Blueish */
            --accent-gradient-2: #182848;

            /* Glassmorphism Variables */
            --glass-bg: rgba(28, 28, 30, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-blur: 24px;
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);

            /* Login Animation Gradient Variables */
            --bg-gradient-1: #0f172a;
            --bg-gradient-2: #1e1b4b;
            --bg-gradient-3: #172554;
        }

        body {
            font-family: 'Noto Sans Thai', sans-serif;
            background-color: var(--bg-base);
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            height: 100dvh;
            overflow: hidden;
            position: relative;
        }

        /* --- Login Animation (Modern Glassmorphism) --- */
        #login-screen {
            background: linear-gradient(-45deg, var(--bg-gradient-1), var(--bg-gradient-2), var(--bg-gradient-3), #020617);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            overflow: hidden;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Pure CSS Geometric Shapes for Background */
        .shape {
            position: absolute;
            filter: blur(60px);
            z-index: 0;
            animation: floatShape 20s infinite ease-in-out alternate;
            opacity: 0.6;
            border-radius: 50%;
        }

        .shape-1 {
            width: 300px;
            height: 300px;
            background: rgba(99, 102, 241, 0.15);
            /* Indigo 500 */
            top: -10%;
            left: -10%;
            animation-duration: 25s;
        }

        .shape-2 {
            width: 400px;
            height: 400px;
            background: rgba(168, 85, 247, 0.15);
            /* Purple 500 */
            bottom: -20%;
            right: -10%;
            animation-duration: 22s;
            animation-delay: -5s;
        }

        .shape-3 {
            width: 250px;
            height: 250px;
            background: rgba(59, 130, 246, 0.15);
            /* Blue 500 */
            bottom: 20%;
            left: 20%;
            animation-duration: 18s;
            animation-delay: -10s;
        }

        @keyframes floatShape {
            0% {
                transform: translateY(0) scale(1) rotate(0deg);
            }

            50% {
                transform: translateY(-30px) scale(1.1) rotate(180deg);
            }

            100% {
                transform: translateY(20px) scale(0.9) rotate(360deg);
            }
        }

        /* Glass Container Class */
        .glass-container {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 220px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            /* Thicker scrollbar */
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f8fafc;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            /* Darker thumb */
            border-radius: 10px;
            border: 2px solid #f8fafc;
            /* Padding effect */
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Force scrollbar visibility on some browsers */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #94a3b8 #f8fafc;
        }

        /* Ensure date input width matches others on mobile */
        input[type="date"] {
            width: 100%;
            box-sizing: border-box;
        }

        .bottom-nav-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            margin: 4px;
            color: #94a3b8;
            /* Slate-400 */
        }

        .bottom-nav-item.active {
            color: #4338ca;
            /* Indigo-700 */
            font-weight: bold;
            transform: translateY(-2px);
            background-color: transparent !important;
            box-shadow: none !important;
        }

        #nav-indicator {
            position: absolute;
            width: 48px;
            height: 48px;
            background-color: #e0e7ff;
            /* Indigo-100 */
            border-radius: 9999px;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
            z-index: -1;
            transition: left 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .bottom-nav-item.active i {
            transform: scale(1.1);
            transition: transform 0.2s;
        }

        .fade-in {
            animation: fadeIn 0.2s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Ensure date input width matches others */
        input[type="date"] {
            width: 100%;
            box-sizing: border-box;
        }

        /* Consistent input styling helper - STRICT RESET */
        .modal-input {
            display: block !important;
            width: 100% !important;
            max-width: 100% !important;
            height: 3rem !important;
            line-height: 3rem !important;
            /* Center text vertically */
            box-sizing: border-box !important;
            margin: 0 !important;
            padding: 0 1rem !important;
            font-size: 0.875rem !important;
            border-radius: 0.75rem !important;
            border: 1px solid #e2e8f0 !important;
            background-color: #f8fafc !important;
            color: #1e293b !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            outline: none !important;
        }

        /* Specific fix for Date input alignment in some browsers */
        input[type="date"].modal-input {
            display: inline-flex !important;
            align-items: center !important;
        }

        /* Status Badge Styles */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border: radius 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 9999px;
        }

        .status-badge.pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-badge.verified {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-badge.failed {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .icon-opt {
            transition: all 0.2s;
            cursor: pointer;
        }

        .icon-opt:hover {
            background-color: #f1f5f9;
        }

        .icon-opt.selected {
            background-color: #1e293b;
            color: white;
            border-color: #1e293b;
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        /* History Date Header */
        .date-header {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1.5rem 0 0.5rem;
        }

        .date-header span {
            background-color: #e2e8f0;
            color: #64748b;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            z-index: 10;
        }

        .date-header::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background-color: #e2e8f0;
            z-index: 0;
        }

        /* --- GLOBAL DARK THEME OVERRIDES --- */
        body,
        main,
        #main-content {
            background-color: var(--bg-base) !important;
            color: var(--text-primary) !important;
        }

        .bg-white {
            background-color: var(--bg-card) !important;
        }

        .bg-slate-50,
        .bg-\[\#f8fafc\] {
            background-color: var(--bg-base) !important;
        }

        .bg-slate-100 {
            background-color: #2c2c2e !important;
        }

        .bg-slate-200,
        .bg-\[\#e2e8f0\] {
            background-color: #3a3a3c !important;
        }

        .bg-white\/90 {
            background-color: rgba(28, 28, 30, 0.9) !important;
        }

        .bg-white\/95 {
            background-color: rgba(28, 28, 30, 0.95) !important;
        }

        .text-slate-800,
        .text-slate-700 {
            color: var(--text-primary) !important;
        }

        .text-slate-600 {
            color: #e5e5ea !important;
        }

        .text-slate-500 {
            color: var(--text-secondary) !important;
        }

        .border-slate-100,
        .border-slate-200,
        .border-slate-300 {
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        .border-b,
        .border-t,
        .border-r,
        .border {
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        .modal-input,
        input,
        select {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        input::placeholder,
        select::placeholder {
            color: var(--text-secondary) !important;
        }

        /* Nav & Headers */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Card Stack - Horizontal Scroll with Overlap */
        .card-stack-container {
            display: flex;
            align-items: flex-end;
            padding-top: 1rem;
            padding-bottom: 1.5rem;
            cursor: grab;
            user-select: none;
        }

        .card-stack-container.is-dragging {
            cursor: grabbing;
        }

        .card-stack-item {
            position: relative;
            flex-shrink: 0;
            transition: transform 0.38s cubic-bezier(0.22, 1, 0.36, 1),
                box-shadow 0.38s ease, background 0.38s ease;
            scroll-snap-align: center;
            opacity: 1;
            /* no dimming */
            transform: scale(0.86) translateY(10px);
            /* slightly small + pushed down */
            width: clamp(185px, 55vw, 260px);
            /* wider cards */
            height: 150px;
            margin-left: -44px;
            /* more overlap */
            background: #2c2c2e;
            border-color: rgba(255, 255, 255, 0.05);
        }

        .card-stack-item[data-is-me="true"] {
            background: linear-gradient(135deg, rgba(67, 56, 202, 0.55) 0%, rgba(109, 40, 217, 0.55) 100%);
            border-color: rgba(99, 102, 241, 0.2);
        }

        .card-stack-item:first-child {
            margin-left: 0;
        }

        /* Centered card: pops up, full color */
        .card-stack-item.centered {
            transform: scale(1.08) translateY(-6px) !important;
            z-index: 10 !important;
            box-shadow: 0 22px 44px -8px rgba(0, 0, 0, 0.85);
        }

        .card-stack-item[data-is-me="true"].centered {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 55%, #1c1c1e 100%);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .card-stack-item[data-is-me="false"].centered {
            background: linear-gradient(135deg, #374151 0%, #4b5563 55%, #1c1c1e 100%);
            border-color: rgba(255, 255, 255, 0.15);
        }

        @media (hover: hover) {
            .card-stack-item:not(.centered):hover {
                transform: scale(0.92) translateY(4px);
            }
        }

        header,
        nav,
        aside {
            background-color: var(--bg-card) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        .nav-btn {
            color: #94a3b8 !important;
            /* text-slate-400 so it's readable on dark bg */
        }

        .nav-btn:hover,
        .bottom-nav-item:hover,
        .icon-opt:hover {
            background-color: #334155 !important;
            color: #ffffff !important;
        }

        .bottom-nav-item.active {
            background-color: var(--text-primary) !important;
            color: var(--bg-base) !important;
            border-radius: 9999px !important;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1) !important;
        }

        .nav-btn.active {
            background-color: #4f46e5 !important;
            color: #ffffff !important;
        }

        .date-header span {
            background-color: #334155 !important;
            color: #cbd5e1 !important;
        }

        .date-header::before {
            background-color: #334155 !important;
        }

        /* Status Badge overrides */
        .status-badge.pending {
            background-color: #451a03 !important;
            color: #fef3c7 !important;
        }

        .status-badge.verified {
            background-color: #064e3b !important;
            color: #d1fae5 !important;
        }

        .status-badge.failed {
            background-color: #7f1d1d !important;
            color: #fee2e2 !important;
        }

        /* General text inversions for light colors */
        .bg-blue-50 {
            background-color: rgba(59, 130, 246, 0.1) !important;
            border-color: rgba(59, 130, 246, 0.2) !important;
            color: #93c5fd !important;
        }

        .text-blue-800 {
            color: #93c5fd !important;
        }

        .text-blue-700 {
            color: #93c5fd !important;
        }

        .bg-green-50 {
            background-color: rgba(34, 197, 94, 0.1) !important;
            border-color: rgba(34, 197, 94, 0.2) !important;
            color: #86efac !important;
        }

        .text-green-800 {
            color: #86efac !important;
        }

        .bg-red-50 {
            background-color: rgba(239, 68, 68, 0.1) !important;
            border-color: rgba(239, 68, 68, 0.2) !important;
            color: #fca5a5 !important;
        }

        .text-red-700 {
            color: #fca5a5 !important;
        }

        /* Fix login text display issues due to text override */
        #login-screen h1,
        #login-screen p,
        #login-screen .text-white {
            color: #ffffff !important;
        }
    </style>
</head>

<body class="flex flex-col md:flex-row">

    <!-- TOAST -->
    <div id="toast">แจ้งเตือน</div>



    <!-- LOGIN OVERLAY -->
    <div id="login-screen" class="fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div id="login-particles" class="absolute inset-0 pointer-events-none z-0"></div>

        <div id="login-container"
            class="glass-container w-full max-w-sm p-8 space-y-6 relative z-10 rounded-3xl transition-all duration-500">
            <div class="text-center">
                <img src="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png" alt="Logo"
                    class="w-20 h-20 mx-auto mb-4 object-contain drop-shadow-[0_4px_8px_rgba(0,0,0,0.3)]">

                <h1 class="interactive-title text-3xl font-extrabold text-white tracking-tight drop-shadow-md"
                    onclick="window.app.triggerGameEmoji(event)">Dept Money</h1>
                <p
                    class="text-xs mt-3 flex justify-center items-center gap-1.5 text-white/90 bg-white/10 backdrop-blur-md border border-white/20 py-1.5 px-4 rounded-full inline-flex mx-auto shadow-sm">
                    <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse shadow-[0_0_8px_#4ade80]"></span>
                    สถานะระบบ online
                </p>
            </div>

            <div class="space-y-4" id="login-options">
                <button onclick="window.app.loginWithLine()"
                    class="group w-full py-3.5 bg-[#06C755] hover:bg-[#05b34c] text-white rounded-xl font-bold shadow-[0_4px_15px_rgba(6,199,85,0.4)] active:scale-95 transition-all flex items-center justify-center gap-3 border border-[#06C755]/50"><i
                        class="fa-brands fa-line text-2xl"></i> เข้าสู่ระบบด้วย LINE</button>

                <button onclick="window.app.showAdminLogin()"
                    class="group w-full py-3.5 bg-white/10 hover:bg-white/20 backdrop-blur-sm border border-white/30 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-3"><i
                        class="fa-solid fa-shield-halved text-white/80 group-hover:scale-110 transition-transform"></i>
                    ผู้ดูแล (Admin)</button>

                <a href="https://lin.ee/1FMnsom" target="_blank"
                    class="w-full py-3.5 bg-white/5 hover:bg-white/10 border border-white/20 text-white/90 rounded-xl font-bold flex items-center justify-center gap-2 shadow-sm active:scale-95 transition-all text-sm"><i
                        class="fa-brands fa-line text-lg"></i> ติดต่อ LINE Official</a>
            </div>

            <div id="admin-login-form"
                class="hidden space-y-4 bg-white/10 backdrop-blur-md p-5 rounded-2xl border border-white/20 animate-fade-in shadow-[0_8px_32px_rgba(0,0,0,0.1)]">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="font-bold text-white text-sm drop-shadow-sm"><i class="fa-solid fa-lock mr-2"></i>Admin
                        Access</h3>
                    <button onclick="window.app.toggleAdminForm()"
                        class="text-white/60 text-xs hover:text-white transition-colors bg-white/5 px-2 py-1 rounded-md">ยกเลิก</button>
                </div>
                <input type="text" id="admin-user" placeholder="Username"
                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-sm text-white focus:ring-2 focus:ring-white/50 focus:bg-white/20 outline-none transition-all placeholder-white/50 shadow-inner">
                <input type="password" id="admin-pass" placeholder="Password"
                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-sm text-white focus:ring-2 focus:ring-white/50 focus:bg-white/20 outline-none transition-all placeholder-white/50 shadow-inner">
                <button onclick="window.app.loginAsAdmin()"
                    class="w-full py-3 bg-white/20 hover:bg-white/30 border border-white/30 text-white rounded-xl text-sm font-bold shadow-lg transition-all active:scale-95 drop-shadow-md">ยืนยัน</button>
            </div>

            <div class="text-center text-[10px] text-white/50 mt-5 font-medium tracking-wider">
                v5.7 &copy; Dept Money Project
                <div id="login-debug-status" class="text-red-300 font-bold mt-2 h-4 drop-shadow-sm"></div>
            </div>
        </div>
    </div>

    <!-- ONBOARDING MODAL -->
    <div id="onboarding-modal"
        class="hidden fixed inset-0 z-[90] bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-6 text-white">
                <h2 class="text-xl font-bold">ยินดีต้อนรับ! 👋</h2>
                <p class="text-sm text-slate-300 mt-2">กรุณากรอกข้อมูลของคุณเพื่อเริ่มใช้งาน</p>
            </div>

            <form id="onboarding-form" class="p-6 space-y-4">
                <!-- Real Name (Required) -->
                <div>
                    <label class="text-xs font-bold text-slate-700 mb-1 block">
                        ชื่อจริงภาษาไทย <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="onboard-real-name" required placeholder="เช่น: สมชาย"
                        class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <p class="text-xs text-slate-400 mt-1">สำหรับตรวจสอบสลิปโอนเงิน</p>
                </div>

                <!-- English Name (Required) -->
                <div>
                    <label class="text-xs font-bold text-slate-700 mb-1 block">
                        ชื่อภาษาอังกฤษ <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="onboard-english-name" required placeholder="เช่น: Somchai"
                        class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>

                <!-- PromptPay (Required) -->
                <div>
                    <label class="text-xs font-bold text-slate-700 mb-1 block">
                        พร้อมเพย์ <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="onboard-promptpay" required
                        placeholder="เบอร์มือถือ 10 หลัก หรือบัตรประชาชน 13 หลัก" pattern="[0-9]{10,13}"
                        class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none">
                    <p class="text-xs text-slate-400 mt-1">สมาชิกจะคัดลอกเพื่อโอนเงินให้คุณได้</p>
                </div>

                <button type="submit"
                    class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition-colors active:scale-95">
                    เริ่มใช้งาน
                </button>
            </form>
        </div>
    </div>

    <!-- MOBILE TOP BAR -->
    <header
        class="md:hidden fixed top-0 left-0 w-full h-16 bg-white/90 backdrop-blur-md border-b px-4 flex items-center justify-between z-50 shadow-sm">
        <div class="flex items-center gap-2">
            <img src="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png"
                class="w-8 h-8 rounded-lg">
            <span class="font-bold text-slate-800">Dept Money</span>
        </div>
        <div class="flex flex-col items-end justify-center">
            <div class="flex items-center gap-2">
                <span id="mobile-role-badge"
                    class="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full font-bold text-slate-500 border border-slate-200">GUEST</span>
                <img id="mobile-profile-pic" src="" alt="Profile"
                    class="w-7 h-7 rounded-full object-cover hidden border border-slate-200 shadow-sm">
                <button onclick="window.app.logout()"
                    class="text-red-400 hover:text-red-600 ml-1 p-1 active:scale-90 transition-transform">
                    <i class="fa-solid fa-right-from-bracket text-sm"></i>
                </button>
            </div>
            <span id="connection-status-mobile"
                class="text-[9px] text-slate-400 mt-0.5 flex items-center gap-1">Checking...</span>
        </div>
    </header>

    <!-- SIDEBAR (Desktop) -->
    <aside class="hidden md:flex w-64 bg-white border-r flex-col z-20 shadow-sm">
        <div class="p-6 border-b flex items-center gap-3">
            <img src="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png"
                class="w-8 h-8 rounded-lg">
            <span class="font-bold text-lg">Dept Money</span>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <button onclick="window.app.navigate('dashboard')"
                class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium hover:bg-slate-50"
                id="nav-dashboard">
                <i class="fa-solid fa-chart-pie w-5"></i> ภาพรวม
            </button>
            <button onclick="window.app.navigate('history')"
                class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium hover:bg-slate-50"
                id="nav-history">
                <i class="fa-solid fa-list-ul w-5"></i> รายการ
            </button>
            <button onclick="window.app.navigate('settlement')"
                class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium hover:bg-slate-50"
                id="nav-settlement">
                <i class="fa-solid fa-hand-holding-dollar w-5"></i> เคลียร์หนี้
            </button>
            <button onclick="window.app.navigate('settings')"
                class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium hover:bg-slate-50"
                id="nav-settings">
                <i class="fa-solid fa-users-gear w-5"></i> ตั้งค่า
            </button>
        </nav>
        <div class="p-4 border-t">
            <div id="desktop-profile-container" class="flex items-center gap-3 mb-4 px-2 hidden">
                <img id="desktop-profile-pic" src=""
                    class="w-8 h-8 rounded-full border border-slate-200 shadow-sm object-cover">
                <div class="flex flex-col truncate">
                    <span id="desktop-user-name" class="text-sm font-bold text-slate-800 truncate">User</span>
                </div>
            </div>
            <button onclick="window.app.logout()"
                class="w-full text-xs text-red-500 hover:text-red-600 flex items-center justify-center gap-2 py-2">
                <i class="fa-solid fa-right-from-bracket"></i> ออกจากระบบ
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto pt-16 pb-24 md:pt-0 md:pb-0 h-full relative z-10 bg-[#f8fafc]"
        id="main-content">

        <!-- DASHBOARD -->
        <section id="view-dashboard" class="p-4 md:p-8 max-w-5xl mx-auto space-y-6 fade-in">
            <div class="bg-[#1c1c1e] p-4 rounded-[20px] shadow-sm border border-white/5">
                <h2 class="font-bold text-slate-300 text-sm mb-3 pl-2">สรุปยอดประจำเดือน</h2>
                <div class="flex items-center justify-between px-2">
                    <button onclick="window.app.changeMonth(-1)"
                        class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-all active:scale-95 border border-white/5">
                        <i class="fa-solid fa-chevron-left text-slate-300 text-xs"></i>
                    </button>

                    <div class="text-center px-4 py-1.5 bg-white/5 rounded-full border border-white/5">
                        <div id="current-month-display" class="font-bold text-white text-xs">เดือนนี้</div>
                    </div>

                    <button onclick="window.app.changeMonth(1)"
                        class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-all active:scale-95 border border-white/5">
                        <i class="fa-solid fa-chevron-right text-slate-300 text-xs"></i>
                    </button>
                </div>
            </div>



            <div
                class="bg-gradient-to-br from-[#4B6CB7] via-[#8E54E9] to-[#182848] rounded-[24px] p-6 shadow-[0_15px_40px_rgba(75,108,183,0.4)] text-white relative overflow-hidden">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                <div class="absolute -left-10 -bottom-10 w-40 h-40 bg-[#ec4899]/30 rounded-full blur-2xl"></div>

                <div class="relative z-10">
                    <div class="flex justify-end items-center mb-6">
                        <i class="fa-brands fa-cc-mastercard text-2xl opacity-80"></i>
                    </div>
                    <p class="text-white/80 text-xs font-medium tracking-wide mb-1">ยอดรวมเดือนนี้</p>
                    <div class="flex justify-between items-end">
                        <h3 class="text-4xl font-bold tracking-tight transition-all duration-300" id="total-expense">0 ฿
                        </h3>
                        <i class="fa-solid fa-eye text-white/50 hover:text-white transition-colors cursor-pointer text-sm mb-2 select-none"
                            onclick="
                            const el = document.getElementById('total-expense');
                            el.classList.toggle('blur-md');
                            el.classList.toggle('opacity-50');
                            this.classList.toggle('fa-eye');
                            this.classList.toggle('fa-eye-slash');
                        "></i>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center px-1">
                <h3 class="font-bold text-white text-sm">Recent Transaction</h3>
                <button onclick="window.app.navigate('history')"
                    class="text-[10px] text-slate-400 hover:text-white transition-colors">View all</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                <div class="bg-[#1c1c1e] rounded-[20px] p-4 shadow-sm border border-white/5">
                    <h3 class="font-bold text-white text-sm mb-1">แนวโน้มรายเดือน</h3>
                    <p class="text-xs text-slate-400 mb-4">6 เดือนล่าสุด</p>
                    <div id="monthly-trend-bar-chart" class="flex items-end gap-2 h-[120px]"></div>
                </div>
                <div class="bg-[#1c1c1e] rounded-[20px] p-4 shadow-sm border border-white/5">
                    <h3 class="font-bold text-white text-sm mb-3">เดือนนี้ใครจ่ายไปเท่าไหร่?</h3>
                    <div id="payerChart"></div>
                </div>
            </div>
        </section>

        <!-- HISTORY -->
        <section id="view-history" class="hidden p-4 md:p-8 max-w-5xl mx-auto space-y-4">
            <div class="bg-[#1c1c1e] p-3 rounded-[20px] shadow-sm border border-white/5 mb-4">
                <div class="flex items-center justify-between gap-3 px-2">
                    <h2 class="text-sm font-bold text-slate-300">รายการใช้จ่าย</h2>

                    <div class="flex items-center gap-2">
                        <button onclick="window.app.changeMonth(-1)"
                            class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-all active:scale-95 border border-white/5">
                            <i class="fa-solid fa-chevron-left text-slate-300 text-xs"></i>
                        </button>

                        <div id="history-month-display"
                            class="font-bold text-white text-xs min-w-[80px] text-center bg-white/5 px-3 py-1.5 rounded-full border border-white/5">
                            เดือนนี้</div>

                        <button onclick="window.app.changeMonth(1)"
                            class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-all active:scale-95 border border-white/5">
                            <i class="fa-solid fa-chevron-right text-slate-300 text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div id="transaction-list-mobile" class="space-y-1 pb-20 md:pb-0"></div>
            <div id="empty-state" class="hidden py-10 text-center text-slate-400">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fa-regular fa-folder-open text-2xl text-slate-300"></i>
                </div>
                <p class="text-sm">ไม่พบข้อมูลในเดือนนี้</p>
            </div>
        </section>

        <!-- SETTLEMENT -->
        <section id="view-settlement" class="hidden p-4 md:p-8 max-w-5xl mx-auto space-y-4">
            <div class="bg-[#1c1c1e] p-3 rounded-[20px] shadow-sm border border-white/5 mb-4">
                <div class="flex items-center justify-between gap-3 px-2">
                    <h2 class="text-sm font-bold text-slate-300">สรุปยอดที่ต้องเคลียร์</h2>

                    <div class="flex items-center gap-2">
                        <button onclick="window.app.changeMonth(-1)"
                            class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-all active:scale-95 border border-white/5">
                            <i class="fa-solid fa-chevron-left text-slate-300 text-xs"></i>
                        </button>

                        <div id="settlement-month-display"
                            class="font-bold text-white text-xs min-w-[80px] text-center bg-white/5 px-3 py-1.5 rounded-full border border-white/5">
                            เดือนนี้</div>

                        <button onclick="window.app.changeMonth(1)"
                            class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-all active:scale-95 border border-white/5">
                            <i class="fa-solid fa-chevron-right text-slate-300 text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 text-blue-700 text-xs p-3 rounded-lg flex items-center gap-2 border border-blue-100">
                <i class="fa-solid fa-circle-info"></i>
                <span>สามารถกดดูรายละเอียดเพิ่มเติมได้</span>
            </div>

            <div id="settlement-status-grid"
                class="overflow-x-auto hide-scrollbar card-stack-container snap-x snap-mandatory -mx-4">
            </div>

            <h3 class="font-bold text-slate-700 text-sm border-b pb-2 mt-6">แผนการโอนเงิน</h3>
            <div id="settlement-plan" class="space-y-2"></div>

            <div id="settlement-admin-actions" class="hidden mt-8 pt-4 border-t border-slate-200">
                <button onclick="window.app.sendLineMessage()"
                    class="w-full bg-[#06C755] text-white py-3 rounded-xl font-bold flex justify-center items-center gap-2 shadow-lg hover:bg-[#05b34c] active:scale-[0.98] transition-all">
                    <i class="fa-brands fa-line text-2xl"></i> ส่ง Flex Message เข้า LINE
                </button>
                <p class="text-center text-[10px] text-slate-400 mt-2">* ใช้ Custom API (/api/send-line)</p>
            </div>
        </section>

        <!-- SETTINGS -->
        <section id="view-settings" class="hidden p-4 md:p-8 max-w-5xl mx-auto space-y-6">
            <h2 class="text-xl font-bold text-slate-800">ตั้งค่าระบบ</h2>

            <!-- ข้อมูลส่วนตัว -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 text-sm mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-user"></i>
                    ข้อมูลส่วนตัว
                </h3>

                <div class="space-y-3">
                    <!-- ชื่อในระบบ (LINE) -->
                    <div>
                        <label class="text-xs text-slate-500 flex items-center gap-1">
                            <i class="fa-brands fa-line text-green-500"></i>
                            ชื่อในระบบ (LINE)
                        </label>
                        <input type="text" id="line-name-display" disabled
                            class="w-full p-2 bg-slate-50 rounded-lg text-sm text-slate-600 cursor-not-allowed">
                    </div>

                    <!-- ชื่อจริง -->
                    <div>
                        <label class="text-xs text-slate-500 flex items-center gap-1">
                            <i class="fa-solid fa-id-card text-blue-500"></i>
                            ชื่อจริงภาษาไทย (สำหรับตรวจสอบสลิป)
                        </label>
                        <div class="flex gap-2">
                            <input type="text" id="real-name-display" placeholder="ยังไม่ได้ตั้งค่า"
                                class="flex-1 p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-100 outline-none">
                            <button onclick="window.app.updateRealName()"
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition-colors">
                                <i class="fa-solid fa-save"></i>
                                บันทึก
                            </button>
                        </div>



                        <p class="text-xs text-slate-400 mt-2">
                            💡 กรอกเฉพาะชื่อที่ปรากฏในสลิป (ไม่ต้องใส่คำนำหน้า)
                            <br>
                            ตัวอย่าง: "สมชาย" แทนที่จะเป็น "นาย สมชาย ใจดี"
                        </p>
                    </div>

                    <!-- ชื่อภาษาอังกฤษ -->
                    <div>
                        <label class="text-xs text-slate-500 flex items-center gap-1">
                            <i class="fa-solid fa-globe text-indigo-500"></i>
                            ชื่อภาษาอังกฤษ
                        </label>
                        <div class="flex gap-2">
                            <input type="text" id="english-name-display" placeholder="ตัวอย่าง: Somchai"
                                class="flex-1 p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-100 outline-none">
                            <button onclick="window.app.updateEnglishName()"
                                class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition-colors">
                                <i class="fa-solid fa-save"></i>
                                บันทึก
                            </button>
                        </div>
                        <p class="text-xs text-slate-400 mt-2">
                            ใช้สำหรับการตรวจสอบสลิป
                        </p>
                    </div>

                    <!-- พร้อมเพย์ -->
                    <div>
                        <label class="text-xs text-slate-500 flex items-center gap-1">
                            <i class="fa-solid fa-mobile-screen-button text-green-500"></i>
                            หมายเลขพร้อมเพย์
                        </label>
                        <div class="flex gap-2">
                            <input type="text" id="promptpay-display"
                                placeholder="เบอร์มือถือ 10 หลัก หรือบัตรประชาชน 13 หลัก"
                                class="flex-1 p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-green-100 outline-none">
                            <button onclick="window.app.updatePromptpay()"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 transition-colors">
                                <i class="fa-solid fa-save"></i>
                                บันทึก
                            </button>
                        </div>

                        <!-- คำอธิบาย -->
                        <div class="mt-2 bg-green-50 border border-green-200 rounded-lg p-3">
                            <p class="text-xs text-green-800 leading-relaxed">
                                <i class="fa-solid fa-circle-info mr-1"></i>
                                <strong>เก็บไว้ทำอะไร?</strong><br>
                                เพื่อความสะดวกในการโอนเงิน สมาชิกคนอื่นจะสามารถคัดลอกหมายเลขพร้อมเพย์ของคุณได้
                            </p>
                        </div>


                    </div>
                </div>
            </div>

            <div class="bg-[#1c1c1e] rounded-[20px] p-4 shadow-sm border border-white/5 space-y-4">
                <h3 class="font-bold text-slate-300 text-sm">จัดการรายชื่อสมาชิก</h3>
                <div class="flex gap-2">
                    <input type="text" id="new-member-name" placeholder="ชื่อภาษาอังกฤษ..."
                        class="flex-1 px-4 py-3 border border-indigo-500/30 rounded-xl text-sm bg-indigo-500/5 text-white placeholder-slate-500 outline-none focus:border-indigo-500 focus:bg-indigo-500/10 transition-all font-bold tracking-wide shadow-inner">
                    <button onclick="window.app.addMember()"
                        class="bg-indigo-600 text-white px-6 rounded-xl text-sm font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-all flex items-center justify-center gap-1">
                        <i class="fa-solid fa-plus"></i> เพิ่ม
                    </button>
                </div>
                <div id="member-list" class="flex flex-wrap gap-2 mt-2"></div>
            </div>

            <button id="btn-export-csv" onclick="window.app.exportCSV()"
                class="hidden w-full bg-[#1c1c1e] border border-white/5 text-slate-300 py-3 rounded-[20px] font-bold text-sm shadow-sm active:scale-[0.98] transition-all">
                <i class="fa-solid fa-file-csv text-emerald-500 mr-2"></i> Export ข้อมูลเป็น CSV
            </button>

            <div id="admin-danger-zone"
                class="hidden bg-[#1c1c1e] p-4 rounded-[20px] border border-red-500/20 space-y-4">
                <h3 class="font-bold text-red-400 text-sm flex items-center gap-2">
                    <i class="fa-solid fa-triangle-exclamation"></i> อันตราย (ลบข้อมูล)
                </h3>

                <div class="bg-red-900/10 p-3 rounded-lg border border-red-500/20 mt-4">
                    <div class="flex gap-2 mb-2">
                        <select id="delete-month-selector"
                            class="flex-1 bg-white/5 border border-red-500/20 text-xs rounded-lg px-2 py-2 outline-none text-red-200"></select>
                        <button onclick="window.app.clearMonthData()"
                            class="bg-red-500/20 hover:bg-red-500/40 text-red-400 px-3 py-2 rounded-lg text-xs font-bold shadow-sm border border-red-500/30 transition-colors">ลบเดือนนี้</button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- MOBILE NAV -->
    <nav
        class="md:hidden fixed bottom-4 left-0 right-0 mx-auto w-[92%] max-w-[400px] bg-[#1c1c1e]/90 backdrop-blur-xl border border-white/10 rounded-full h-16 flex justify-around items-center px-2 shadow-[0_10px_30px_rgba(0,0,0,0.5)] z-40">
        <div id="nav-indicator"></div>
        <button onclick="window.app.navigate('dashboard')"
            class="bottom-nav-item flex flex-col items-center justify-center gap-1 w-12 h-12 text-center"
            id="mob-nav-dashboard">
            <i class="fa-solid fa-chart-pie text-[18px]"></i>
        </button>
        <button onclick="window.app.navigate('history')"
            class="bottom-nav-item flex flex-col items-center justify-center gap-1 w-12 h-12 text-center"
            id="mob-nav-history">
            <i class="fa-solid fa-clock-rotate-left text-[18px]"></i>
        </button>
        <button onclick="window.app.navigate('settlement')"
            class="bottom-nav-item flex flex-col items-center justify-center gap-1 w-12 h-12 text-center"
            id="mob-nav-settlement">
            <i class="fa-solid fa-money-bill-transfer text-[18px]"></i>
        </button>
        <button onclick="window.app.navigate('settings')"
            class="bottom-nav-item flex flex-col items-center justify-center gap-1 w-12 h-12 text-center"
            id="mob-nav-settings">
            <i class="fa-solid fa-gear text-[18px]"></i>
        </button>
    </nav>

    <!-- MODAL: MEMBER DETAIL -->
    <div id="member-detail-modal"
        class="hidden fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 animate-fade-in">
        <div
            class="bg-[#0a0a0c] w-full max-w-md max-h-[90vh] rounded-t-[32px] md:rounded-[32px] flex flex-col shadow-2xl overflow-hidden transform transition-all border border-white/10">
            <div class="p-4 border-b border-white/5 flex justify-between items-center bg-[#1c1c1e]">
                <span id="member-detail-title" class="font-bold text-white text-lg ml-2">รายละเอียด</span>
                <button onclick="window.app.closeModal('member-detail-modal')"
                    class="w-8 h-8 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center text-white transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar" id="member-detail-list"></div>
            <div class="p-6 border-t border-white/5 bg-[#1c1c1e] flex justify-between items-end">
                <span class="text-xs text-slate-400 font-bold uppercase tracking-widest">ยอดรวมทั้งหมด</span>
                <span id="member-detail-total" class="text-2xl font-bold text-white">0
                    ฿</span>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD/EDIT TRANSACTION -->
    <!-- MODAL: ADD/EDIT TRANSACTION -->
    <div id="transaction-modal"
        class="hidden fixed inset-0 z-[70] bg-[#0A0C27]/90 backdrop-blur-md flex items-end md:items-center justify-center p-0 md:p-4 animate-fade-in">
        <div
            class="w-full max-w-[420px] h-[95vh] md:h-auto md:max-h-[90vh] rounded-t-[32px] md:rounded-[32px] flex flex-col shadow-2xl overflow-hidden transform transition-all border border-white/10 bg-gradient-to-br from-[#4B6CB7] via-[#8E54E9] to-[#182848] relative">

            <!-- Header Section -->
            <div class="px-6 pt-8 pb-6 flex-shrink-0 relative z-10 w-full mb-1">
                <div class="flex justify-between items-center mb-5">
                    <div
                        class="flex items-center gap-2 bg-white/10 rounded-full pr-3 p-1 backdrop-blur-sm border border-white/20">
                        <img src="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png"
                            class="w-6 h-6 rounded-full shadow-sm">
                        <span class="text-white font-bold text-xs tracking-wide shadow-sm">Dept Money</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span
                            class="text-white/90 text-xs font-bold bg-white/10 px-3 py-1.5 rounded-full border border-white/10 shadow-sm"><i
                                class="fa-solid fa-globe mr-1"></i> TH</span>
                        <button onclick="window.app.closeModal('transaction-modal')"
                            class="text-white hover:text-white/80 transition-all bg-white/10 hover:bg-white/20 w-8 h-8 rounded-full flex items-center justify-center border border-white/20 shadow-sm">
                            <i class="fa-solid fa-xmark text-sm"></i>
                        </button>
                    </div>
                </div>

                <h2 class="text-[28px] font-extrabold text-white mb-2 tracking-tight drop-shadow-md" id="modal-title">
                    บันทึกรายการ</h2>
                <p class="text-white/80 text-xs leading-relaxed max-w-[90%] font-medium drop-shadow-sm">
                    กรอกรายละเอียดค่าใช้จ่าย เพื่อให้ระบบสรุปยอดให้อัตโนมัติ
                </p>
            </div>

            <!-- Main Form Content (Card) -->
            <div
                class="bg-[#1C1C1E] flex-1 w-full rounded-t-[32px] overflow-y-auto custom-scrollbar relative shadow-[0_-10px_30px_rgba(0,0,0,0.3)] z-20 pb-[100px] border-t border-white/10">

                <div class="p-5 space-y-4 mt-2">
                    <!-- Amount Input -->
                    <!-- Dropdown Desktop Fix -->
                    <style>
                        select option {
                            background-color: #2C2C2E !important;
                            color: #FFFFFF !important;
                        }
                    </style>

                    <!-- Amount Input -->
                    <div class="flex flex-col mb-4">
                        <label
                            class="text-[10px] text-indigo-300 font-bold uppercase tracking-wider mb-2 ml-1">จำนวนเงิน
                            (บาท)</label>
                        <div
                            class="flex items-center bg-gradient-to-r from-indigo-500/10 to-purple-500/10 border border-indigo-500/30 rounded-2xl p-4 hover:border-indigo-500/50 transition-all focus-within:border-indigo-500 focus-within:ring-1 focus-within:ring-indigo-500 focus-within:bg-indigo-500/15">
                            <div
                                class="w-10 h-10 rounded-full bg-indigo-500/20 flex items-center justify-center shadow-inner shrink-0">
                                <i class="fa-solid fa-baht-sign text-indigo-400 text-lg"></i>
                            </div>
                            <input type="number" id="t-amount" placeholder="0.00"
                                oninput="window.app.recalculateCustomSplits('total')"
                                class="flex-1 text-3xl font-extrabold text-white outline-none !bg-transparent placeholder-white/20 ml-3 w-full">
                        </div>
                    </div>

                    <!-- Payer Input (Who Paid) -->
                    <div class="flex flex-col mb-4">
                        <label class="text-[10px] text-slate-400 font-bold uppercase mb-1.5 ml-1">ใครจ่ายเงิน</label>
                        <div
                            class="flex items-center bg-[#2C2C2E]/50 border border-white/10 rounded-2xl px-3 py-2.5 hover:border-white/30 transition-all focus-within:border-white/50 relative">
                            <div
                                class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center mr-3 shrink-0">
                                <i class="fa-solid fa-user text-purple-400 text-xs"></i>
                            </div>
                            <select id="t-payer"
                                class="flex-1 text-sm font-bold text-white outline-none !bg-transparent appearance-none cursor-pointer w-full !border-none">
                                <!-- Populated dynamically -->
                            </select>
                            <i class="fa-solid fa-chevron-down text-white/30 text-[10px] pointer-events-none pr-1"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <!-- Date Input -->
                        <div class="flex flex-col">
                            <label class="text-[10px] text-slate-400 font-bold uppercase mb-1.5 ml-1">วันที่</label>
                            <div
                                class="flex items-center bg-[#2C2C2E]/50 border border-white/10 rounded-2xl px-3 py-2.5 hover:border-white/30 transition-all focus-within:border-white/50">
                                <i class="fa-regular fa-calendar text-blue-400 text-sm mr-2.5 shrink-0"></i>
                                <input type="date" id="t-date"
                                    class="w-full text-xs font-bold text-white outline-none !bg-transparent cursor-pointer !border-none custom-date-input">
                            </div>
                        </div>

                        <!-- Type Input -->
                        <div class="flex flex-col">
                            <label class="text-[10px] text-slate-400 font-bold uppercase mb-1.5 ml-1">รูปแบบจ่าย</label>
                            <div
                                class="flex items-center bg-[#2C2C2E]/50 border border-white/10 rounded-2xl px-3 py-2.5 hover:border-white/30 transition-all focus-within:border-white/50">
                                <i class="fa-solid fa-money-bill-wave text-emerald-400 text-sm mr-2.5 shrink-0"></i>
                                <select id="t-payment-type" onchange="window.app.toggleInstallment()"
                                    class="flex-1 text-xs font-bold text-white outline-none !bg-transparent appearance-none cursor-pointer w-full !border-none">
                                    <option value="normal" class="bg-[#2C2C2E] text-white">จ่ายเต็ม</option>
                                    <option value="installment" class="bg-[#2C2C2E] text-white">ผ่อนชำระ</option>
                                    <option value="subscription" class="bg-[#2C2C2E] text-white">Subscription</option>
                                </select>
                                <i
                                    class="fa-solid fa-chevron-down text-white/30 text-[10px] pointer-events-none px-1"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Desc Input -->
                    <div class="flex flex-col mb-4 relative">
                        <label
                            class="text-[10px] text-slate-400 font-bold uppercase mb-1.5 ml-1 flex justify-between w-full">
                            <span>รายละเอียด</span>
                            <span
                                class="text-white/30 text-[8px] font-normal leading-tight">(ระบบเดาหมวดหมู่อัตโนมัติได้)</span>
                        </label>
                        <div
                            class="flex items-center bg-[#2C2C2E]/50 border border-white/10 rounded-2xl p-1.5 pr-4 hover:border-white/30 transition-all focus-within:border-white/50 focus-within:bg-[#2C2C2E]/80">
                            <button type="button"
                                onclick="document.getElementById('icon-dropdown-menu').classList.toggle('hidden')"
                                id="btn-icon-selector"
                                class="w-9 h-9 rounded-xl bg-orange-500/20 flex items-center justify-center mr-3 mt-0.5 shadow-inner transition-colors hover:bg-orange-500/30 shrink-0">
                                <span id="t-selected-icon-display"
                                    class="font-emoji text-[16px] drop-shadow-sm">🍽️</span>
                            </button>
                            <input type="text" id="t-desc" placeholder="เช่น ข้าวมันไก่, ค่าไฟ..."
                                oninput="autoAnalyzeIcon(this.value)"
                                class="flex-1 text-sm font-bold text-white outline-none !bg-transparent placeholder-white/20 w-full !border-none py-1.5">
                        </div>

                        <!-- Hidden Icon Menu for Manual Override (Dropdown) -->
                        <div id="icon-dropdown-menu"
                            class="hidden absolute top-[110%] left-0 w-full bg-[#1C1C1E] rounded-[24px] p-4 shadow-2xl z-[60] border border-white/10 transition-all flex flex-col gap-2 max-h-[220px] overflow-y-auto custom-scrollbar">
                            <span
                                class="w-full text-[10px] text-white/40 font-bold uppercase mb-1 sticky top-0 bg-[#1C1C1E] z-10 py-1">เลือกหมวดหมู่เพิ่มเติม</span>
                            <div class="flex flex-wrap gap-2 justify-start">
                                <!-- Original icons -->
                                <button type="button" onclick="selectIconManual('fa-utensils', '🍽️', 'orange')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">🍽️</button>
                                <button type="button" onclick="selectIconManual('fa-cart-shopping', '🛒', 'blue')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">🛒</button>
                                <button type="button" onclick="selectIconManual('fa-car', '🚗', 'red')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">🚗</button>
                                <button type="button" onclick="selectIconManual('fa-bolt', '⚡', 'yellow')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">⚡</button>
                                <button type="button" onclick="selectIconManual('fa-gift', '🎁', 'pink')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">🎁</button>
                                <button type="button" onclick="selectIconManual('fa-house', '🏠', 'green')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">🏠</button>
                                <button type="button" onclick="selectIconManual('fa-mug-hot', '☕', 'amber')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">☕</button>
                                <button type="button" onclick="selectIconManual('fa-gamepad', '🎮', 'purple')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">🎮</button>
                                <button type="button" onclick="selectIconManual('fa-mobile-screen', '📱', 'sky')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">📱</button>
                                <button type="button" onclick="selectIconManual('fa-bus', '🚌', 'teal')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">🚌</button>
                                <!-- New icons -->
                                <button type="button" onclick="selectIconManual('fa-pills', '💊', 'rose')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">💊</button>
                                <button type="button" onclick="selectIconManual('fa-plane', '✈️', 'indigo')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">✈️</button>
                                <button type="button" onclick="selectIconManual('fa-film', '🎬', 'fuchsia')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">🎬</button>
                                <button type="button" onclick="selectIconManual('fa-dumbbell', '🏋️', 'slate')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">🏋️</button>
                                <button type="button" onclick="selectIconManual('fa-gas-pump', '⛽', 'red')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">⛽</button>
                                <button type="button" onclick="selectIconManual('fa-paw', '🐾', 'amber')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">🐾</button>
                                <button type="button" onclick="selectIconManual('fa-scissors', '💇', 'pink')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">💇</button>
                                <button type="button" onclick="selectIconManual('fa-basket-shopping', '🛒', 'blue')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">🛒</button>
                                <button type="button" onclick="selectIconManual('fa-wine-glass', '🍷', 'red')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">🍷</button>
                                <button type="button" onclick="selectIconManual('fa-money-bill', '💰', 'emerald')"
                                    class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all font-emoji text-xl shadow-sm">💰</button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="t-icon" value="fa-utensils">

                    <script>
                        // Smart Auto-Detect Icon System
                        window.iconDict = [
                            { keywords: ['ข้าว', 'กิน', 'อาหาร', 'ก๋วยเตี๋ยว', 'น้ำ', 'ขนม', 'บุฟเฟ่ต์', 'ชาบู', 'หมูกระทะ', 'food', 'eat', 'dinner', 'kfc', 'mcdonald'], iconId: 'fa-utensils', emoji: '🍽️', color: 'orange' },
                            { keywords: ['กาแฟ', 'ชา', 'คาเฟ่', 'เครื่องดื่ม', 'starbucks', 'cafe', 'coffee', 'tea'], iconId: 'fa-mug-hot', emoji: '☕', color: 'amber' },
                            { keywords: ['ซื้อ', 'ของ', 'ช้อป', 'shopee', 'lazada', '7-11', 'เซเว่น', 'เสื้อ', 'กางเกง', 'รองเท้า', 'shopping', 'mall', 'ตลาด'], iconId: 'fa-cart-shopping', emoji: '🛒', color: 'blue' },
                            { keywords: ['รถ', 'เดินทาง', 'ทางด่วน', 'mrt', 'bts', 'grab', 'bolt', 'แท็กซี่', 'taxi', 'วิน', 'car'], iconId: 'fa-car', emoji: '🚗', color: 'red' },
                            { keywords: ['น้ำมัน', 'ปั๊ม', 'gas', 'oil'], iconId: 'fa-gas-pump', emoji: '⛽', color: 'red' },
                            { keywords: ['บัส', 'รถเมล์', 'ทัวร์', 'bus'], iconId: 'fa-bus', emoji: '🚌', color: 'teal' },
                            { keywords: ['ไฟ', 'ค่าไฟ', 'เน็ต', 'โทรศัพท์', 'ais', 'true', 'dtac', 'internet', 'electric'], iconId: 'fa-bolt', emoji: '⚡', color: 'yellow' },
                            { keywords: ['บ้าน', 'ค่าเช่า', 'หอ', 'คอนโด', 'ส่วนกลาง', 'house', 'rent', 'room'], iconId: 'fa-house', emoji: '🏠', color: 'green' },
                            { keywords: ['ของขวัญ', 'วันเกิด', 'ทำบุญ', 'ซอง', 'gift', 'donate'], iconId: 'fa-gift', emoji: '🎁', color: 'pink' },
                            { keywords: ['เกม', 'สตรีม', 'เติมเงิน', 'steam', 'game', 'play'], iconId: 'fa-gamepad', emoji: '🎮', color: 'purple' },
                            { keywords: ['มือถือ', 'ไอโฟน', 'ซ่อม', 'phone', 'mobile', 'ipad'], iconId: 'fa-mobile-screen', emoji: '📱', color: 'sky' },
                            { keywords: ['ยา', 'หาหมอ', 'พยาบาล', 'คลินิก', 'โรงพยาบาล', 'ป่วย'], iconId: 'fa-pills', emoji: '💊', color: 'rose' },
                            { keywords: ['บิน', 'ตั๋วเครื่องบิน', 'เที่ยว', 'เครื่องบิน', 'flight'], iconId: 'fa-plane', emoji: '✈️', color: 'indigo' },
                            { keywords: ['หนัง', 'โรงหนัง', 'netfilx', 'ภาพยนตร์', 'movie', 'cinema'], iconId: 'fa-film', emoji: '🎬', color: 'fuchsia' },
                            { keywords: ['ฟิตเนส', 'ยิม', 'ออกกำลังกาย', 'gym', 'fitness'], iconId: 'fa-dumbbell', emoji: '🏋️', color: 'slate' },
                            { keywords: ['สัตว์', 'แมว', 'หมา', 'หมาแมว', 'pet', 'dog', 'cat'], iconId: 'fa-paw', emoji: '🐾', color: 'amber' },
                            { keywords: ['ตัดผม', 'ซาลอน', 'ทำผม', 'hair', 'salon'], iconId: 'fa-scissors', emoji: '💇', color: 'pink' },
                            { keywords: ['ซุปเปอร์', 'โลตัส', 'บิ๊กซี', 'tops', 'supermarket'], iconId: 'fa-basket-shopping', emoji: '🛒', color: 'blue' },
                            { keywords: ['เหล้า', 'เบียร์', 'ปาร์ตี้', 'เหล้าเบียร์', 'party', 'beer', 'wine'], iconId: 'fa-wine-glass', emoji: '🍷', color: 'red' },
                            { keywords: ['แชร์', 'หนี้', 'โอน', 'เงิน', 'money', 'pay'], iconId: 'fa-money-bill', emoji: '💰', color: 'emerald' }
                        ];

                        window.isManualIconSelected = false;

                        function autoAnalyzeIcon(text) {
                            if (!text) {
                                // optional reset but let's keep it steady
                                return;
                            }
                            if (window.isManualIconSelected) return; // don't override if user manually picked

                            text = text.toLowerCase();
                            for (const category of window.iconDict) {
                                if (category.keywords.some(kw => text.includes(kw.toLowerCase()))) {
                                    applyIconUI(category.iconId, category.emoji, category.color);
                                    break;
                                }
                            }
                        }

                        function selectIconManual(iconId, emoji, color) {
                            window.isManualIconSelected = true;
                            applyIconUI(iconId, emoji, color);
                            document.getElementById('icon-dropdown-menu').classList.add('hidden');
                        }

                        function applyIconUI(iconId, emoji, color) {
                            document.getElementById('t-icon').value = iconId;
                            document.getElementById('t-selected-icon-display').innerText = emoji;

                            // Update container color safely by removing all known colors
                            const btn = document.getElementById('btn-icon-selector');
                            btn.className = `w-9 h-9 rounded-xl flex items-center justify-center mr-3 mt-0.5 shadow-inner transition-colors bg-${color}-500/20 hover:bg-${color}-500/30 shrink-0`;
                        }
                    </script>

                    <!-- Installment/Subscription Wrappers -->
                    <div id="t-installment-wrapper" class="hidden bg-orange-500/10 p-4 rounded-[16px]">
                        <label class="text-[10px] font-bold text-orange-400 uppercase mb-2 block ml-1">จำนวนงวด
                            (เดือน)</label>
                        <div class="flex items-center bg-black/20 rounded-xl px-4 py-2 shadow-inner">
                            <input type="number" id="t-installments" placeholder="ระบุจำนวนตัวเลข"
                                class="w-full text-sm font-bold text-white outline-none bg-transparent !border-none">
                            <i class="fa-solid fa-calendar-days text-orange-500/50"></i>
                        </div>
                    </div>

                    <div id="t-subscription-wrapper" class="hidden bg-purple-500/10 p-4 rounded-[16px]">
                        <div class="flex items-center gap-3 mb-1">
                            <input type="checkbox" id="t-subscription-recurring" checked
                                class="w-5 h-5 text-purple-600 rounded-md border-purple-300 focus:ring-purple-500 outline-none">
                            <label for="t-subscription-recurring"
                                class="text-sm font-bold text-purple-200 cursor-pointer">
                                สร้างรายการยอดนี้อัตโนมัติทุกเดือน
                            </label>
                        </div>
                    </div>

                    <!-- split section -->
                    <div class="bg-[#2C2C2E] p-4 rounded-[20px] border border-white/5 shadow-sm relative mb-6">
                        <div class="flex justify-between items-center mb-3 border-b border-white/5 pb-3">
                            <span
                                class="text-[11px] font-bold text-white/50 uppercase tracking-wide flex items-center gap-1.5"><i
                                    class="fa-solid fa-users text-indigo-400"></i> คนหาร (Split)</span>
                            <div class="flex bg-black/30 rounded-lg p-1 border border-white/5 shadow-inner">
                                <button onclick="window.app.setSplitMode('equal')" id="btn-split-equal"
                                    class="px-3 py-1 rounded-md text-[10px] font-bold bg-[#3A3A3C] text-indigo-300 shadow-sm transition-all border border-white/10">หารเท่า</button>
                                <button onclick="window.app.setSplitMode('custom')" id="btn-split-custom"
                                    class="px-3 py-1 rounded-md text-[10px] font-bold text-white/50 hover:text-white/80 transition-all">ระบุเอง</button>
                            </div>
                        </div>
                        <div id="split-participants" class="space-y-2 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Action Buttons -->
            <div
                class="absolute bottom-0 left-0 w-full px-5 py-5 bg-gradient-to-t from-[#1C1C1E] via-[#1C1C1E] to-transparent pt-12 rounded-b-[32px] md:rounded-b-[32px] z-30 pointer-events-none">
                <button id="btn-save-transaction" onclick="window.app.saveTransaction()"
                    class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-full font-bold shadow-[0_8px_20px_rgba(99,102,241,0.4)] hover:shadow-[0_8px_25px_rgba(99,102,241,0.6)] active:scale-[0.98] transition-all text-[16px] flex items-center justify-center gap-2 pointer-events-auto border border-white/10">
                    <i class="fa-solid fa-check-circle text-lg"></i> บันทึกรายการ
                </button>
            </div>
        </div>
    </div>

    <!-- Real Name Setup Modal (บังคับกรอก) -->
    <div id="real-name-setup-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100] hidden px-4">
        <div
            class="bg-[#1c1c1e] rounded-[32px] p-8 max-w-md w-full shadow-2xl border border-white/10 relative overflow-hidden">
            <!-- Header -->
            <div class="text-center mb-6 relative z-10">
                <div
                    class="w-20 h-20 bg-indigo-500/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-indigo-500/30">
                    <i class="fa-solid fa-user-pen text-indigo-400 text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2">ตั้งค่าชื่อจริง</h3>
            </div>

            <!-- Explanation -->
            <div class="bg-indigo-900/20 border border-indigo-500/20 rounded-[20px] p-5 mb-6 relative z-10">
                <p class="text-sm text-indigo-300 leading-relaxed font-medium">
                    <span class="text-lg mr-2">💡</span><strong>ทำไมต้องกรอกชื่อจริง?</strong><br>
                    <span class="opacity-80 mt-1 block">เมื่อคุณอัปโหลดสลิปโอนเงินเพื่อยืนยันการชำระ
                        ระบบจะใช้ชื่อจริงนี้ตรวจสอบกับชื่อในสลิปอัตโนมัติ เพื่อความแม่นยำ</span>
                </p>
            </div>

            <!-- Input -->
            <div class="mb-8 relative z-10">
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">
                    ชื่อจริงบนสลิปของคุณ
                </label>
                <input type="text" id="real-name-input" placeholder="เช่น สมชาย, ปิยะนุช"
                    class="w-full px-5 py-4 bg-white/5 border border-white/10 rounded-2xl text-lg font-bold text-white focus:border-indigo-500 focus:bg-indigo-500/5 focus:outline-none transition-all placeholder:font-normal placeholder:text-slate-600">
                <p class="text-[10px] text-slate-500 mt-2 flex items-start gap-1">
                    <i class="fa-solid fa-circle-info mt-0.5"></i> กรอกเฉพาะชื่อที่ปรากฏในสลิป (ไม่ต้องใส่ นาย, นาง)
                </p>
            </div>

            <!-- Actions -->
            <div class="flex gap-3 relative z-10">
                <button onclick="window.app.saveRealName()"
                    class="flex-1 bg-white text-black py-4 rounded-2xl font-bold hover:bg-slate-200 transition-colors shadow-lg active:scale-[0.98] text-lg">
                    บันทึกข้อมูล
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Add Member Modal -->
    <div id="quick-add-member-modal"
        class="hidden fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#1c1c1e] w-full max-w-sm rounded-[32px] shadow-2xl p-8 border border-white/10">
            <h3 class="text-xl font-bold text-white mb-6">เพิ่มสมาชิกแบบด่วน</h3>

            <form onsubmit="window.app.quickAddMember(event)">
                <div class="mb-6">
                    <label
                        class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">ชื่อสมาชิก</label>
                    <input type="text" id="quick-add-name" required placeholder="เช่น BANK"
                        class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-2xl text-lg font-bold text-white focus:border-indigo-500 focus:bg-indigo-500/5 focus:outline-none transition-all placeholder:font-normal placeholder:text-slate-600 uppercase">
                    <p class="text-[10px] text-slate-500 mt-2">* กรอกชื่อเล่นภาษาอังกฤษ (ไม่ต้อง login LINE ก็ได้)</p>
                </div>

                <div class="flex gap-3">
                    <button type="button" onclick="window.app.closeModal('quick-add-member-modal')"
                        class="flex-1 px-4 py-3 border border-white/10 rounded-2xl text-sm font-bold text-slate-400 hover:bg-white/5 transition-colors">
                        ยกเลิก
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-3 bg-white text-black rounded-2xl text-sm font-bold hover:bg-slate-200 transition-colors shadow-lg active:scale-[0.98]">
                        เพิ่ม
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Account Linking Modal -->
    <div id="account-linking-modal"
        class="hidden fixed inset-0 z-[95] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#1c1c1e] w-full max-w-md rounded-[32px] shadow-2xl overflow-hidden border border-white/10">
            <div
                class="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 text-white text-center relative overflow-hidden">
                <div class="absolute inset-0 opacity-20 mix-blend-overlay"
                    style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'1\' fill-rule=\'evenodd\'%3E%3Ccircle cx=\'3\' cy=\'3\' r=\'3\'/%3E%3Ccircle cx=\'13\' cy=\'13\' r=\'3\'/%3E%3C/g%3E%3C/svg%3E');">
                </div>
                <div
                    class="relative z-10 w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm border border-white/30">
                    <i class="fa-solid fa-link text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold relative z-10">เชื่อมต่อบัญชี</h2>
                <p class="text-sm text-white/80 mt-2 relative z-10 font-medium">พบรายชื่อที่อาจเป็นคุณ</p>
            </div>

            <div class="p-6">
                <p class="text-sm text-slate-400 mb-4 text-center font-bold">คุณคือบุคคลต่อไปนี้ใช่หรือไม่?</p>
                <div id="unlinked-members-list" class="space-y-3 max-h-[40vh] overflow-y-auto custom-scrollbar">
                    <!-- Dynamic List -->
                </div>
            </div>

            <div class="p-4 bg-[#0a0a0c] border-t border-white/5">
                <button onclick="window.app.skipLinking()"
                    class="w-full py-4 text-slate-400 text-sm font-bold hover:text-white hover:bg-white/5 rounded-2xl transition-all">
                    ไม่ใช่ฉัน / สร้างบัญชีใหม่
                </button>
            </div>
        </div>
    </div>

    <!-- PromptPay QR Modal -->
    <div id="qr-code-modal"
        class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-[#1c1c1e] w-full max-w-sm rounded-[32px] shadow-2xl overflow-hidden relative border border-white/10">
            <button onclick="document.getElementById('qr-code-modal').classList.add('hidden')"
                class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/10 text-white flex items-center justify-center hover:bg-white/20 transition-colors z-10">
                <i class="fa-solid fa-xmark"></i>
            </button>

            <div class="pt-8 pb-6 px-6 text-center">
                <div class="flex items-center justify-center gap-2 mb-2">
                    <img src="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1769281620/PromptPay-logo_dd6p5v.png"
                        style="height: 24px" class="object-contain" alt="PromptPay">
                </div>
                <h3 class="text-lg font-bold text-white mt-4" id="qr-receiver-name">Receiver Name</h3>
                <p class="text-slate-400 text-xs mb-6" id="qr-promptpay-id">xxx-xxx-xxxx</p>

                <div class="bg-white p-4 rounded-3xl inline-block shadow-inner mb-4">
                    <img id="qr-image" src="" alt="QR Code"
                        class="w-48 h-48 object-contain opacity-0 transition-opacity duration-300"
                        onload="this.classList.remove('opacity-0')">
                </div>

                <div class="text-3xl font-bold text-white mb-1">
                    <span id="qr-amount">0.00</span> ฿
                </div>
                <p class="text-[10px] text-slate-500">สแกนเพื่อจ่ายเงิน</p>

                <div class="mt-6 flex justify-center">
                    <button onclick="document.getElementById('qr-code-modal').classList.add('hidden')"
                        class="px-6 py-3 bg-white/10 text-white rounded-full text-sm font-bold hover:bg-white/20 transition-colors border border-white/10 w-full">
                        ปิดหน้าต่าง
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button (FAB) -->
    <button onclick="window.app.openModal('transaction-modal')"
        class="fixed bottom-[90px] md:bottom-10 shadow-[0_8px_30px_rgba(99,102,241,0.4)] right-6 w-14 h-14 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-full flex items-center justify-center text-white hover:scale-110 active:scale-95 transition-all z-40 group border border-white/10">
        <i class="fa-solid fa-plus text-xl group-hover:rotate-90 transition-transform duration-300"></i>
    </button>

    <!-- Slip Upload Modal -->
    <div id="slip-upload-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 z-50 hidden animate-fade-in">
        <div
            class="bg-[#0a0a0c] w-full max-w-md rounded-t-[32px] md:rounded-[32px] p-6 shadow-2xl border border-white/10 relative">
            <!-- Modal Handle for mobile -->
            <div class="absolute top-2 left-1/2 -translate-x-1/2 w-12 h-1.5 bg-white/20 rounded-full md:hidden"></div>

            <div class="flex justify-between items-center mb-6 pt-2 md:pt-0">
                <h3 class="text-lg font-bold text-white">ยืนยันการโอนเงิน</h3>
                <button onclick="window.app.closeSlipUploadModal()"
                    class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white/20 transition-colors">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="bg-[#1c1c1e] p-4 rounded-[20px] border border-white/5 mb-6 shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-slate-400">คุณต้องโอนให้</span>
                    <span id="slip-to" class="font-bold text-white text-sm"></span>
                </div>
                <div class="flex justify-between items-baseline">
                    <span class="text-xs text-slate-400">จำนวนเงิน</span>
                    <div class="text-right">
                        <span id="slip-amount" class="font-bold text-red-400 text-2xl"></span>
                        <span class="text-red-400 text-sm font-bold ml-1">฿</span>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">
                    อัปโหลดสลิปโอนเงิน
                </label>
                <div class="border-2 border-dashed border-white/20 bg-[#1c1c1e] rounded-[24px] p-8 text-center hover:border-indigo-500/50 hover:bg-indigo-500/5 transition-all cursor-pointer group"
                    onclick="document.getElementById('slip-file-input').click()">
                    <div
                        class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-indigo-500/20 transition-colors">
                        <i
                            class="fa-solid fa-cloud-upload text-2xl text-slate-400 group-hover:text-indigo-400 transition-colors"></i>
                    </div>
                    <p class="text-sm font-bold text-white">คลิกเพื่อเลือกรูปสลิป</p>
                    <p class="text-[10px] text-slate-500 mt-1">รองรับ JPG, PNG, WEBP</p>
                </div>
                <input type="file" id="slip-file-input" accept="image/*" class="hidden"
                    onchange="window.app.handleSlipFileSelected(this.files[0])">

                <div id="slip-preview"
                    class="hidden mt-3 bg-emerald-900/20 border border-emerald-500/20 p-3 rounded-xl flex items-center gap-2">
                    <i class="fa-solid fa-check-circle text-emerald-500"></i>
                    <span id="slip-filename" class="text-xs text-emerald-400 truncate max-w-[250px]"></span>
                </div>
            </div>

            <button id="btn-verify-slip" onclick="window.app.verifySettlementSlip()" disabled
                class="w-full bg-white text-black py-4 rounded-[20px] font-bold disabled:bg-white/10 disabled:text-white/30 disabled:cursor-not-allowed hover:bg-slate-200 transition-colors shadow-lg active:scale-[0.98] text-lg flex items-center justify-center gap-2">
                <i class="fa-solid fa-check"></i>
                ตรวจสอบสลิป
            </button>
        </div>
    </div>

    <!-- Slip Verification Result Modal -->
    <div id="slip-result-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[60] hidden animate-fade-in px-4">
        <div
            class="bg-[#1c1c1e] rounded-[32px] p-8 max-w-sm w-full shadow-2xl border border-white/10 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-white/5 to-transparent"></div>

            <div class="relative z-10">
                <div
                    class="result-icon text-7xl mb-6 mx-auto flex items-center justify-center w-24 h-24 rounded-full bg-white/5 border border-white/10 shadow-inner drop-shadow-lg">
                </div>
                <h3 class="result-title text-2xl font-bold text-white mb-2"></h3>
                <div class="result-message text-sm text-slate-400 mb-8"></div>

                <button onclick="window.app.closeResultModal()"
                    class="w-full bg-white/10 text-white py-4 rounded-full font-bold hover:bg-white/20 transition-colors border border-white/10 active:scale-95 shadow-sm">
                    ปิด
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        Chart.register(ChartDataLabels);

        const firebaseConfig = {
            apiKey: "AIzaSyDD_3oEFAFgZyUdW2n6S36P_Ln47DIeNpc",
            authDomain: "deptmoney-6682a.firebaseapp.com",
            projectId: "deptmoney-6682a",
            storageBucket: "deptmoney-6682a.firebasestorage.app",
            messagingSenderId: "6714403201",
            appId: "1:6714403201:web:a98a2cefcebef5c63b6080"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDocs, updateDoc, deleteDoc, writeBatch, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const fApp = initializeApp(firebaseConfig);
        const db = getFirestore(fApp);

        const app = {
            data: {
                userRole: 'guest',
                members: [],
                transactions: [],
                splitMode: 'equal',
                currentView: 'dashboard',
                currentMonth: new Date().toISOString().slice(0, 7),
                editingId: null,
                selectedGroupId: null,
                settlementPlan: [],
                // เก็บค่า API Endpoint
                apiEndpoint: localStorage.getItem('dept_money_api_endpoint') || '/api/send-line'
            },
            charts: { monthlyTrend: null, payer: null },

            // LIFF Config
            liffId: "2008948704-db2goT00",

            async init() {
                this.initBackground();
                this.updateMonthDisplay();
                this.selectIcon('fa-utensils');
                this.initLiff();

                // Refresh mobile nav indicator on resize
                window.addEventListener('resize', () => {
                    const indicator = document.getElementById('nav-indicator');
                    if (indicator && indicator.dataset.targetId) {
                        const target = document.getElementById(indicator.dataset.targetId);
                        if (target) {
                            const parentWidth = target.offsetParent ? target.offsetParent.offsetWidth : 0;
                            if (parentWidth > 0) {
                                indicator.style.left = `${target.offsetLeft}px`;
                                indicator.style.width = `${target.offsetWidth}px`;
                            }
                        }
                    }
                });

                onSnapshot(collection(db, "members"), (snap) => {
                    const superAdminId = 'U0d739eea39c312e11c487e22861920d1';
                    this.data.rawMembers = snap.docs.map(d => ({ ...d.data(), id: d.id, ref: d.ref }));

                    this.data.members = this.data.rawMembers.map(m => (m.name || "").toUpperCase()).sort((a, b) => {
                        if (a === 'GAME') return -1;
                        if (b === 'GAME') return 1;
                        return a.localeCompare(b);
                    });

                    if (this.data.currentUser) {
                        const me = this.data.rawMembers.find(m => (m.name || "").toUpperCase() === this.data.currentUser.toUpperCase());
                        if (me) {
                            let targetRole = me.role || 'member';
                            if (me.lineUserId === superAdminId) targetRole = 'admin';

                            if (targetRole !== this.data.userRole) {
                                console.log("Role auto-sync:", targetRole);
                                this.completeLogin(targetRole, me.name);
                            }
                        }
                    }

                    this.renderMemberList();
                    this.populatePayerSelector();
                });

                onSnapshot(collection(db, "transactions"), (snap) => {
                    this.data.transactions = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                    this.refreshCurrentView();
                    // document.getElementById('loading-overlay').classList.add('hidden');
                    const statusEl = document.getElementById('connection-status-mobile');
                    if (statusEl) statusEl.innerHTML = `<span class="text-green-500 font-bold"><i class="fa-solid fa-circle text-[6px]"></i> Online</span>`;
                });

                // Safety Timeout Removed
            },

            updateDebug(msg) {
                const el = document.getElementById('login-debug-status');
                if (el) el.textContent = msg;
                console.log(msg);
            },

            async initLiff() {
                this.updateDebug("LIFF initializing...");
                try {
                    await liff.init({ liffId: this.liffId });
                    if (liff.isLoggedIn()) {
                        this.updateDebug("LIFF Logged In. Fetching Profile...");
                        const profile = await liff.getProfile();
                        this.handleLineLoginSuccess(profile);
                    } else {
                        this.updateDebug("LIFF Ready. Waiting for login.");
                    }
                } catch (err) {
                    this.updateDebug("LIFF Error: " + err.message);
                }
            },

            async loginWithLine() {
                try {
                    this.updateDebug("Click Login...");

                    if (typeof liff === 'undefined') {
                        throw new Error("LIFF SDK not loaded");
                    }

                    // Wait for init to finish (success or fail)
                    if (!liff.id) {
                        this.updateDebug("Waiting for LIFF Ready...");
                        await liff.ready;
                    }

                    this.updateDebug("Checking Login Status...");
                    if (!liff.isLoggedIn()) {
                        try {
                            this.updateDebug("Redirecting to LINE...");
                            // Enable auto login redirect with explicit scopes
                            liff.login({
                                redirectUri: window.location.href,
                                scope: 'profile openid'
                            });
                        } catch (e) {
                            throw new Error("liff.login failed: " + e.message);
                        }
                    } else {
                        this.updateDebug("Already Logged In. Fetching...");
                        const profile = await liff.getProfile();
                        this.handleLineLoginSuccess(profile);
                    }
                } catch (e) {
                    console.error(e);
                    this.updateDebug("Critical Error: " + e.message);
                    alert("Login Error: " + e.message);
                }
            },

            async handleLineLoginSuccess(profile) {
                try {
                    this.updateDebug("Got Profile: " + profile.displayName);
                    // document.getElementById('loading-overlay').classList.remove('hidden');
                    const userId = profile.userId;
                    const isSuperAdmin = userId === 'U0d739eea39c312e11c487e22861920d1';
                    const displayName = profile.displayName.toUpperCase().trim();

                    // --- INSTANT LOGIN CHECK (Memory First) ---
                    this.updateDebug("Checking Cache...");

                    let existingById = (this.data.rawMembers || []).find(m => m.lineUserId === userId);
                    let usedCache = true;

                    if (!this.data.rawMembers || this.data.rawMembers.length === 0) {
                        this.updateDebug("Cache empty. Fallback to DB...");
                        usedCache = false;
                        const q = query(collection(db, "members"), where("lineUserId", "==", userId));
                        const snap = await getDocs(q);
                        if (!snap.empty) existingById = { ...snap.docs[0].data(), id: snap.docs[0].id, ref: snap.docs[0].ref };
                    }

                    if (existingById) {
                        this.updateDebug("User Found (" + (usedCache ? "Cache" : "DB") + ")");
                        const ref = existingById.ref || doc(db, "members", existingById.id);
                        let updates = {};
                        if (existingById.name !== displayName) updates.name = displayName;
                        if (existingById.pictureUrl !== profile.pictureUrl) updates.pictureUrl = profile.pictureUrl || '';

                        if (Object.keys(updates).length > 0) {
                            this.updateDebug(`Profile update queued for ${existingById.name}`);
                            updateDoc(ref, updates).catch(console.error);
                        }
                        let role = (existingById && existingById.role && existingById.role.toLowerCase() === 'admin') ? 'admin' : 'member';
                        if (isSuperAdmin) role = 'admin';
                        this.completeLogin(role, displayName, profile.pictureUrl);
                    } else {
                        this.updateDebug("ID Not Found. Checking Name...");
                        let existingByName = (this.data.rawMembers || []).find(m => m.name === displayName);
                        if (!usedCache && !existingByName) {
                            const qName = query(collection(db, "members"), where("name", "==", displayName));
                            const snapName = await getDocs(qName);
                            if (!snapName.empty) existingByName = { ...snapName.docs[0].data(), id: snapName.docs[0].id, ref: snapName.docs[0].ref };
                        }
                        if (existingByName) {
                            this.updateDebug("Found Legacy Name. Linking ID...");
                            const ref = existingByName.ref || doc(db, "members", existingByName.id);
                            let updates = { lineUserId: userId };
                            if (existingByName.pictureUrl !== profile.pictureUrl) updates.pictureUrl = profile.pictureUrl || '';
                            await updateDoc(ref, updates);
                            let role = (existingByName.role === 'admin') ? 'admin' : 'member';
                            if (isSuperAdmin) role = 'admin';
                            this.completeLogin(role, displayName, profile.pictureUrl);
                        } else {
                            // Check for ANY unlinked members (candidates)
                            const unlinkedMembers = this.data.rawMembers.filter(m => !m.lineUserId);

                            if (unlinkedMembers.length > 0) {
                                this.updateDebug("Found Unlinked Members. Showing Selection...");
                                // Save profile for linking later
                                this.data.pendingLineProfile = profile;
                                this.showAccountLinkingModal(unlinkedMembers);
                            } else {
                                this.updateDebug("Creating New User...");
                                await addDoc(collection(db, "members"), { name: displayName, lineUserId: userId, pictureUrl: profile.pictureUrl || '', role: 'member', joinedAt: new Date().toISOString() });
                                this.completeLogin(isSuperAdmin ? 'admin' : 'member', displayName, profile.pictureUrl);
                            }
                        }
                    }
                } catch (e) {
                    console.error(e);
                    this.updateDebug("Login Error: " + e.message);
                    alert("Login failed: " + e.message);
                    // document.getElementById('loading-overlay').classList.add('hidden');
                }
            },

            async completeLogin(role, name, pictureUrl = '') {
                console.log('🔐 completeLogin called with:', { role, name, pictureUrl });

                this.data.userRole = role;
                this.data.currentUser = name; // Store current user
                this.data.userPictureUrl = pictureUrl;
                const loginScreen = document.getElementById('login-screen');
                if (loginScreen) loginScreen.classList.add('hidden');

                const appScreen = document.getElementById('app-screen');
                if (appScreen) appScreen.classList.remove('hidden');

                // Update UI with user info
                const nameDisplay = document.getElementById('user-name-display');
                if (nameDisplay) nameDisplay.textContent = name;

                const badge = document.getElementById('mobile-role-badge');
                if (badge) {
                    badge.textContent = name || role.toUpperCase();
                    if (role === 'admin') {
                        badge.className = "text-[10px] bg-slate-800 px-2 py-1 rounded-full font-bold text-white";
                    }
                }

                // Apply Profile Pictures and update desktop sidebar name
                const desktopName = document.getElementById('desktop-user-name');
                if (desktopName) desktopName.textContent = name;

                const dtContainer = document.getElementById('desktop-profile-container');
                if (dtContainer) dtContainer.classList.remove('hidden');

                if (pictureUrl) {
                    const mobilePic = document.getElementById('mobile-profile-pic');
                    if (mobilePic) {
                        mobilePic.src = pictureUrl;
                        mobilePic.classList.remove('hidden');
                    }
                    const desktopPic = document.getElementById('desktop-profile-pic');
                    if (desktopPic) {
                        desktopPic.src = pictureUrl;
                    }
                }

                if (role === 'admin') {
                    document.body.classList.add('is-admin');
                    const dz = document.getElementById('admin-danger-zone');
                    if (dz) dz.classList.remove('hidden');
                    const sa = document.getElementById('settlement-admin-actions');
                    if (sa) sa.classList.remove('hidden');
                    const ec = document.getElementById('btn-export-csv');
                    if (ec) ec.classList.remove('hidden');
                }

                // === ONBOARDING CHECK ===
                // เช็คว่ากรอกข้อมูลครบทั้ง 3 ฟิลด์หรือยัง
                // ⭐ ดึงข้อมูล member ล่าสุดจาก Firebase ก่อนเช็ค
                console.log('🔍 Starting onboarding check for:', name);

                try {
                    const q = query(collection(db, 'members'), where('name', '==', name));
                    const snapshot = await getDocs(q);

                    if (!snapshot.empty) {
                        const freshMember = {
                            id: snapshot.docs[0].id,
                            ...snapshot.docs[0].data(),
                            ref: snapshot.docs[0].ref
                        };

                        console.log('Fresh member data:', freshMember);

                        // เช็ค role จาก Firebase ไม่ใช่ role ที่ถูก override
                        const isRealAdmin = freshMember.role && freshMember.role.toLowerCase() === 'admin';
                        console.log('Is real admin (from Firebase)?', isRealAdmin);

                        if (!isRealAdmin) {  // เฉพาะ non-admin ต้องผ่าน onboarding
                            const isComplete = this.checkOnboardingComplete(freshMember);
                            console.log('Onboarding complete?', isComplete);

                            if (!isComplete) {
                                console.log('⚠️ Onboarding incomplete - showing modal');
                                this.data.lineUserId = freshMember.lineUserId; // เก็บไว้ใช้ใน completeOnboarding
                                this.showOnboardingModal(freshMember);
                                return; // หยุดไม่ไป dashboard
                            }

                            console.log('✅ Onboarding complete - proceeding to dashboard');
                        } else {
                            console.log('👑 Real admin - skipping onboarding');
                        }
                    }
                } catch (error) {
                    console.error('Error fetching member data:', error);
                }


                // กรอกครบแล้วหรือเป็น admin → ไปหน้า Dashboard
                this.navigate('dashboard');
                this.showToast(`ยินดีต้อนรับ ${name}`);
            },

            showRealNameSetupModal() {
                document.getElementById('real-name-setup-modal').classList.remove('hidden');
                document.getElementById('real-name-input').focus();
            },

            async saveRealName() {
                const realName = document.getElementById('real-name-input').value.trim();

                if (!realName) {
                    alert('กรุณากรอกชื่อจริง');
                    return;
                }

                // Validate: ต้องมีอักษร
                if (!/[ก-๙a-zA-Z]/.test(realName)) {
                    alert('กรุณากรอกชื่อที่ถูกต้อง');
                    return;
                }

                try {
                    // อัปเดต Firestore
                    const member = this.data.rawMembers.find(m => m.name === this.data.currentUser);
                    if (member && member.ref) {
                        await updateDoc(member.ref, {
                            realName: realName,
                            realNameSetAt: new Date(),
                            realNameUpdatedAt: new Date()
                        });

                        // อัปเดต local data
                        member.realName = realName;

                        // ปิด Modal
                        document.getElementById('real-name-setup-modal').classList.add('hidden');

                        // แสดง Success
                        this.showToast('✅ บันทึกชื่อจริงเรียบร้อย');

                        // ไปหน้า Dashboard
                        this.navigate('dashboard');
                    } else {
                        alert('ไม่พบข้อมูลสมาชิก');
                    }
                } catch (error) {
                    console.error('Error saving real name:', error);
                    alert('เกิดข้อผิดพลาด: ' + error.message);
                }
            },

            async quickAddMember(e) {
                e.preventDefault();
                const nameInput = document.getElementById('quick-add-name');
                const name = nameInput.value.trim().toUpperCase();

                if (!name) {
                    alert('กรุณากรอกชื่อ');
                    return;
                }

                // Check duplicate
                const existing = this.data.rawMembers.find(m => m.name === name);
                if (existing) {
                    alert('ชื่อนี้มีอยู่แล้ว');
                    return;
                }

                try {
                    // Add to Firebase
                    await addDoc(collection(db, 'members'), {
                        name: name,
                        createdAt: new Date().toISOString(),
                        createdBy: this.data.currentUser || 'system',
                        quickAdded: true,
                        role: 'member'
                    });

                    this.showToast(`✅ เพิ่มสมาชิก ${name} แล้ว`);
                    this.closeModal('quick-add-member-modal');
                    nameInput.value = ''; // Reset form

                    // Note: The onSnapshot listener in init() will automatically update the list

                } catch (error) {
                    console.error('Error adding member:', error);
                    alert('เกิดข้อผิดพลาด: ' + error.message);
                }
            },

            showAccountLinkingModal(unlinkedMembers) {
                const list = document.getElementById('unlinked-members-list');
                list.innerHTML = '';

                unlinkedMembers.forEach(member => {
                    const div = document.createElement('div');
                    div.className = 'p-4 bg-[#0a0a0c] border border-white/5 rounded-2xl flex justify-between items-center hover:bg-white/5 hover:border-white/10 transition-all cursor-pointer group';
                    div.onclick = () => this.linkAccount(member);

                    div.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-[#1c1c1e] border border-white/10 flex items-center justify-center text-slate-400 font-bold text-lg group-hover:text-white group-hover:border-white/20 transition-all shadow-inner">
                                ${member.name.charAt(0)}
                            </div>
                            <div>
                                <h4 class="font-bold text-white text-base group-hover:text-indigo-400 transition-colors">${member.name}</h4>
                                <p class="text-[10px] text-slate-500 mt-0.5">สร้างเมื่อ: ${member.createdAt ? new Date(member.createdAt).toLocaleDateString('th-TH') : 'ไม่ระบุ'}</p>
                            </div>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-indigo-500/20 transition-colors">
                            <i class="fa-solid fa-chevron-right text-slate-500 text-xs group-hover:text-indigo-400"></i>
                        </div>
                    `;
                    list.appendChild(div);
                });

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('account-linking-modal').classList.remove('hidden');
            },

            async linkAccount(member) {
                const profile = this.data.pendingLineProfile;
                if (!profile) return window.location.reload();

                const confirmed = confirm(`ยืนยันว่าคุณคือ "${member.name}" ใช่หรือไม่?`);
                if (!confirmed) return;

                try {
                    // Update Firebase Member Profile
                    const displayName = profile.displayName.toUpperCase().trim();
                    const oldName = member.name;

                    const memberRef = member.ref || doc(db, "members", member.id);
                    await updateDoc(memberRef, {
                        name: displayName,
                        oldName: oldName,
                        lineUserId: profile.userId,
                        lineDisplayName: profile.displayName,
                        pictureUrl: profile.pictureUrl || '',
                        linkedAt: new Date().toISOString()
                    });

                    // ♻️ MIGRATE TRANSACTIONS TO NEW NAME
                    console.log(`Migrating transactions from ${oldName} to ${displayName}...`);

                    const batch = writeBatch(db);
                    let batchCount = 0;

                    // 1. หา Transaction ที่เป็น Payer
                    const payerQuery = query(collection(db, "transactions"), where("payer", "==", oldName));
                    const payerSnaps = await getDocs(payerQuery);

                    payerSnaps.forEach(doc => {
                        batch.update(doc.ref, { payer: displayName });
                        batchCount++;
                    });

                    // 2. หา Transaction ที่มีส่วนหาร (Splits)
                    // เราต้องดึงทั้งหมดมาเช็ค เพราะ Firestore query ใน map keys ยาก
                    const allTransSnaps = await getDocs(collection(db, "transactions"));

                    allTransSnaps.forEach(doc => {
                        const t = doc.data();

                        // Check Splits
                        if (t.splits && t.splits[oldName] !== undefined) {
                            const newSplits = { ...t.splits };
                            newSplits[displayName] = newSplits[oldName];
                            delete newSplits[oldName];

                            batch.update(doc.ref, { splits: newSplits });
                            batchCount++;
                        }
                    });

                    if (batchCount > 0) {
                        await batch.commit();
                        console.log(`Updated ${batchCount} transactions.`);
                    }

                    // Proceed to login with NEW name
                    document.getElementById('account-linking-modal').classList.add('hidden');
                    const picUrl = profile.pictureUrl || '';
                    this.completeLogin('member', displayName, picUrl);

                } catch (e) {
                    console.error(e);
                    alert("เชื่อมต่อไม่สำเร็จ: " + e.message);
                }
            },



            async skipLinking() {
                const profile = this.data.pendingLineProfile;
                if (!profile) return window.location.reload();

                // Confirm skip
                if (!confirm("คุณต้องการสร้างบัญชีใหม่ใช่หรือไม่?")) return;

                try {
                    const displayName = profile.displayName.toUpperCase().trim();
                    const userId = profile.userId;

                    // Create new user as usual
                    await addDoc(collection(db, "members"), {
                        name: displayName,
                        lineUserId: userId,
                        pictureUrl: profile.pictureUrl || '',
                        role: 'member',
                        joinedAt: new Date().toISOString()
                    });

                    document.getElementById('account-linking-modal').classList.add('hidden');
                    const picUrl = profile.pictureUrl || '';
                    this.completeLogin('member', displayName, picUrl);
                } catch (e) {
                    console.error(e);
                    alert("สร้างบัญชีไม่สำเร็จ: " + e.message);
                }
            },


            logout() {
                console.log('🚪 Logging out...');

                // Check if LIFF is available and logged in
                if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                    try {
                        // Logout from LINE LIFF
                        liff.logout();
                        console.log('✅ LIFF logout successful');
                    } catch (e) {
                        console.error('❌ LIFF logout error:', e);
                    }
                }

                // Clear local data
                this.data.userRole = 'guest';
                this.data.currentUser = null;

                // Reload to show login screen
                setTimeout(() => {
                    window.location.reload();
                }, 300); // Small delay to ensure logout completes
            },

            initBackground() {
                const container = document.getElementById('login-particles');
                if (!container) return;
                for (let i = 0; i < 15; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    const size = Math.random() * 40 + 10 + 'px';
                    p.style.width = size;
                    p.style.height = size;
                    p.style.left = Math.random() * 100 + '%';
                    p.style.animationDuration = (Math.random() * 20 + 20) + 's';
                    p.style.animationDelay = (Math.random() * 5) + 's';
                    container.appendChild(p);
                }
            },

            navigate(viewId) {
                this.data.currentView = viewId;
                document.querySelectorAll('section[id^="view-"]').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-slate-100', 'text-slate-900'));
                const nav = document.getElementById(`nav-${viewId}`);
                if (nav) nav.classList.add('bg-slate-100', 'text-slate-900');
                document.querySelectorAll('.bottom-nav-item').forEach(b => b.classList.remove('active'));
                const mobNav = document.getElementById(`mob-nav-${viewId}`);
                if (mobNav) {
                    mobNav.classList.add('active');
                    // Move the animated background indicator
                    const indicator = document.getElementById('nav-indicator');
                    if (indicator) {
                        const updateIndicator = () => {
                            if (!mobNav.offsetParent) return; // Menu is currently hidden
                            indicator.style.left = `${mobNav.offsetLeft}px`;
                            indicator.style.width = `${mobNav.offsetWidth}px`;
                        };
                        updateIndicator();
                        setTimeout(updateIndicator, 150); // Refresh after potential unhide or layout shift
                        // Save last nav button to re-calculate on window resize
                        indicator.dataset.targetId = mobNav.id;
                    }
                }
                this.refreshCurrentView();
            },

            refreshCurrentView() {
                if (this.data.currentView === 'dashboard') this.renderDashboard();
                if (this.data.currentView === 'history') this.renderHistory();
                if (this.data.currentView === 'settlement') this.calculateSettlement();
                if (this.data.currentView === 'settings') this.loadSettingsData();
            },

            loadSettingsData() {
                // Populate month selectors for admin
                this.populateMonthSelectors();

                // โหลดข้อมูลส่วนตัว
                const lineNameDisplay = document.getElementById('line-name-display');
                const realNameDisplay = document.getElementById('real-name-display');

                if (lineNameDisplay) {
                    lineNameDisplay.value = this.data.currentUser || '';
                }

                if (realNameDisplay) {
                    const member = this.data.rawMembers.find(m => m.name === this.data.currentUser);
                    realNameDisplay.value = member?.realName || '';

                    // โหลด English Name
                    const englishNameDisplay = document.getElementById('english-name-display');
                    if (englishNameDisplay) {
                        englishNameDisplay.value = member?.englishName || '';
                    }

                    // โหลด Promptpay แบบ masked
                    const promptpayDisplay = document.getElementById('promptpay-display');
                    if (promptpayDisplay) {
                        const promptpay = member?.promptpay || '';
                        promptpayDisplay.value = promptpay ? this.maskPromptpay(promptpay) : '';
                    }
                }
            },

            async updateRealName() {
                const realName = document.getElementById('real-name-display').value.trim();

                if (!realName) {
                    alert('กรุณากรอกชื่อจริง');
                    return;
                }

                // Validate
                if (!/[ก-๙a-zA-Z]/.test(realName)) {
                    alert('กรุณากรอกชื่อที่ถูกต้อง');
                    return;
                }

                try {
                    const member = this.data.rawMembers.find(m => m.name === this.data.currentUser);
                    if (member && member.ref) {
                        await updateDoc(member.ref, {
                            realName: realName,
                            realNameUpdatedAt: new Date()
                        });

                        // อัปเดต local data
                        member.realName = realName;

                        this.showToast('✅ อัปเดตชื่อจริงเรียบร้อย');
                    } else {
                        alert('ไม่พบข้อมูลสมาชิก');
                    }
                } catch (error) {
                    console.error('Error updating real name:', error);
                    alert('เกิดข้อผิดพลาด: ' + error.message);
                }
            },

            async updateEnglishName() {
                const englishName = document.getElementById('english-name-display').value.trim();

                // อนุญาตให้เป็นค่าว่างได้ (ไม่บังคับ)
                if (englishName && !/^[a-zA-Z\s]+$/.test(englishName)) {
                    alert('กรุณากรอกเฉพาะตัวอักษรภาษาอังกฤษเท่านั้น');
                    return;
                }

                try {
                    const member = this.data.rawMembers.find(m => m.name === this.data.currentUser);
                    if (member && member.ref) {
                        await updateDoc(member.ref, {
                            englishName: englishName || '',
                            englishNameUpdatedAt: new Date()
                        });

                        // อัปเดต local data
                        member.englishName = englishName;

                        this.showToast('✅ อัปเดตชื่อภาษาอังกฤษเรียบร้อย');
                    } else {
                        alert('ไม่พบข้อมูลสมาชิก');
                    }
                } catch (error) {
                    console.error('Error updating English name:', error);
                    alert('เกิดข้อผิดพลาด: ' + error.message);
                }
            },

            async updatePromptpay() {
                const promptpayInput = document.getElementById('promptpay-display').value.trim();

                // ถ้ากรอกมา ให้ validate
                if (promptpayInput) {
                    // ลบ mask ออก (ถ้ามี)
                    let promptpay = promptpayInput.replace(/[^0-9]/g, '');

                    // Validation: ตรวจสอบว่าเป็นตัวเลขเท่านั้น
                    if (!/^\d+$/.test(promptpay)) {
                        alert('กรุณากรอกเฉพาะตัวเลขเท่านั้น');
                        return;
                    }

                    // Validation: ความยาว (เบอร์มือถือ 10 หลัก หรือ บัตรประชาชน 13 หลัก)
                    if (promptpay.length !== 10 && promptpay.length !== 13) {
                        alert('กรุณากรอกเบอร์มือถือ 10 หลัก หรือเลขบัตรประชาชน 13 หลัก');
                        return;
                    }

                    try {
                        const member = this.data.rawMembers.find(m => m.name === this.data.currentUser);
                        if (member && member.ref) {
                            await updateDoc(member.ref, {
                                promptpay: promptpay,
                                promptpayUpdatedAt: new Date()
                            });

                            // อัปเดต local data
                            member.promptpay = promptpay;

                            // แสดงผลแบบ mask
                            document.getElementById('promptpay-display').value = this.maskPromptpay(promptpay);

                            this.showToast('✅ อัปเดตหมายเลขพร้อมเพย์เรียบร้อย');
                        } else {
                            alert('ไม่พบข้อมูลสมาชิก');
                        }
                    } catch (error) {
                        console.error('Error updating promptpay:', error);
                        alert('เกิดข้อผิดพลาด: ' + error.message);
                    }
                } else {
                    // ถ้าเป็นค่าว่าง = ต้องการลบข้อมูล
                    try {
                        const member = this.data.rawMembers.find(m => m.name === this.data.currentUser);
                        if (member && member.ref) {
                            await updateDoc(member.ref, {
                                promptpay: '',
                                promptpayUpdatedAt: new Date()
                            });

                            member.promptpay = '';
                            this.showToast('✅ ลบหมายเลขพร้อมเพย์เรียบร้อย');
                        }
                    } catch (error) {
                        console.error('Error deleting promptpay:', error);
                        alert('เกิดข้อผิดพลาด: ' + error.message);
                    }
                }
            },

            maskPromptpay(number) {
                if (!number) return '';

                if (number.length === 10) {
                    // เบอร์มือถือ: 081-234-XXXX
                    return number.substring(0, 6) + 'XXXX';
                } else if (number.length === 13) {
                    // บัตรประชาชน: X-XXXX-XXXXX-XX-X
                    return 'X-XXXX-XXXXX-' + number.substring(11, 13) + '-X';
                }
                return number;
            },

            showPromptPayQR(amount, receiverName) {
                // Find receiver
                const receiver = this.data.rawMembers.find(m => m.name === receiverName);
                if (!receiver || !receiver.promptpay) {
                    alert(`⚠️ ${receiverName} ยังไม่ได้ตั้งค่า PromptPay`);
                    return;
                }

                const pp = receiver.promptpay.replace(/[^0-9]/g, '');
                if (pp.length !== 10 && pp.length !== 13) {
                    alert(`⚠️ เบอร์ PromptPay ของ ${receiverName} ไม่ถูกต้อง (${pp})`);
                    return;
                }

                // Generate QR: https://promptpay.io/{id}/{amount}
                // Amount should be number
                // Example: https://promptpay.io/0812345678/500.25
                const qrUrl = `https://promptpay.io/${pp}/${Number(amount).toFixed(2)}`;

                document.getElementById('qr-receiver-name').textContent = receiverName;
                document.getElementById('qr-promptpay-id').textContent = this.maskPromptpay(pp);
                document.getElementById('qr-amount').textContent = Number(amount).toLocaleString();
                document.getElementById('qr-image').src = qrUrl;
                document.getElementById('qr-image').classList.add('opacity-0'); // Reset animation

                document.getElementById('qr-code-modal').classList.remove('hidden');
            },

            // Slip Upload Functions
            openSlipUploadModal(from, to, amount) {
                this.data.currentSettlement = { from, to, amount };

                document.getElementById('slip-amount').textContent = `${amount.toLocaleString()} บาท`;
                document.getElementById('slip-to').textContent = to;

                // Reset
                this.data.selectedSlipFile = null;
                document.getElementById('slip-preview').classList.add('hidden');
                document.getElementById('btn-verify-slip').disabled = true;

                document.getElementById('slip-upload-modal').classList.remove('hidden');
            },

            closeSlipUploadModal() {
                document.getElementById('slip-upload-modal').classList.add('hidden');
            },

            handleSlipFileSelected(file) {
                if (!file) return;

                // Validate file type
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    alert('กรุณาเลือกไฟล์รูปภาพ (JPG, PNG, WEBP)');
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('ไฟล์ใหญ่เกิน 5MB');
                    return;
                }

                this.data.selectedSlipFile = file;

                // Show preview
                document.getElementById('slip-filename').textContent = file.name;
                document.getElementById('slip-preview').classList.remove('hidden');
                document.getElementById('btn-verify-slip').disabled = false;
            },

            async verifySettlementSlip() {
                if (!this.data.selectedSlipFile) {
                    alert('กรุณาเลือกรูปสลิป');
                    return;
                }

                const { from, to, amount } = this.data.currentSettlement;

                // Show loading
                const btn = document.getElementById('btn-verify-slip');
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> กำลังตรวจสอบ...';

                try {
                    const formData = new FormData();
                    formData.append('settlementId', 'temp-' + Date.now()); // TODO: Use real settlement ID
                    formData.append('from', from);
                    formData.append('to', to);
                    formData.append('amount', amount);
                    formData.append('month', this.data.currentMonth);
                    formData.append('file', this.data.selectedSlipFile);

                    const response = await fetch('/api/verify-settlement-slip', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    // Reset button
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> ตรวจสอบสลิป';

                    // Close upload modal
                    this.closeSlipUploadModal();

                    if (result.success) {
                        this.showSlipVerificationResult(result.slip, true);
                        // Refresh settlement
                        this.calculateSettlement();
                    } else {
                        this.showSlipVerificationResult(null, false, result.message);
                    }

                } catch (error) {
                    console.error('Error verifying slip:', error);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> ตรวจสอบสลิป';
                    alert('เกิดข้อผิดพลาด: ' + error.message);
                }
            },

            showSlipVerificationResult(slip, success, errorMessage = '') {
                const modal = document.getElementById('slip-result-modal');
                const icon = modal.querySelector('.result-icon');
                const title = modal.querySelector('.result-title');
                const message = modal.querySelector('.result-message');

                if (success) {
                    icon.textContent = '✅';
                    title.textContent = 'ยืนยันสำเร็จ!';
                    message.innerHTML = `
                        <div class="text-left space-y-1 mt-4">
                            <p><strong>ผู้โอน:</strong> ${slip.sender.displayName}</p>
                            <p><strong>ผู้รับ:</strong> ${slip.receiver.displayName}</p>
                            <p><strong>จำนวนเงิน:</strong> ${slip.amount.toLocaleString()} บาท</p>
                            <p><strong>วันที่:</strong> ${this.formatSlipDate(slip.transDate)}</p>
                            <p><strong>เวลา:</strong> ${slip.transTime}</p>
                        </div>
                    `;
                } else {
                    icon.textContent = '❌';
                    title.textContent = 'สลิปไม่ถูกต้อง';
                    message.textContent = errorMessage || 'เกิดข้อผิดพลาด';
                }

                modal.classList.remove('hidden');
            },

            closeResultModal() {
                document.getElementById('slip-result-modal').classList.add('hidden');
            },

            formatSlipDate(dateStr) {
                // dateStr = "20260124"
                const year = parseInt(dateStr.substring(0, 4));
                const month = parseInt(dateStr.substring(4, 6));
                const day = parseInt(dateStr.substring(6, 8));

                const thaiMonths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
                    'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];

                return `${day} ${thaiMonths[month - 1]} ${year + 543}`;
            },

            renderHistory() {
                const list = document.getElementById('transaction-list-mobile');
                const empty = document.getElementById('empty-state');
                list.innerHTML = "";

                const filtered = this.data.transactions
                    .filter(t => t.date.startsWith(this.data.currentMonth))
                    .sort((a, b) => new Date(b.date) - new Date(a.date) || (b.timestamp || 0) - (a.timestamp || 0));

                if (filtered.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                empty.classList.add('hidden');

                let lastDate = '';

                filtered.forEach(t => {
                    const dateObj = new Date(t.date);
                    const day = dateObj.getDate();
                    const month = dateObj.toLocaleString('th-TH', { month: 'short' });
                    const dateStr = dateObj.toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

                    const isInstallment = t.paymentType === 'installment';
                    const iconClass = t.icon || 'fa-utensils';

                    // Grouping by Date
                    if (t.date !== lastDate) {
                        const header = document.createElement('div');
                        header.className = "date-header";
                        header.innerHTML = `<span>${dateStr}</span>`;
                        list.appendChild(header);
                        lastDate = t.date;
                    }

                    const div = document.createElement('div');
                    div.className = "bg-[#1c1c1e] p-4 rounded-[20px] shadow-sm border border-white/5 flex items-center justify-between mb-2";

                    let html = `
                        <div class="flex items-center gap-4">
                            <div class="flex flex-col items-center justify-center bg-white/5 rounded-full w-12 h-12 text-white border border-white/10 shrink-0">
                                <i class="fa-solid ${iconClass} text-lg"></i>
                            </div>
                            <div>
                                <div class="font-bold text-white text-sm flex items-center gap-2">
                                    ${t.desc}
                                </div>
                                <div class="text-[10px] text-slate-400 mt-0.5">
                                    ${t.payer} จ่ายให้
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="font-bold text-white text-sm">-${Number(t.amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ฿</span>
                            <div class="flex gap-2">
                    `;

                    // Edit Icon
                    // Edit button removed - แก้ปัญหาการแจ้งเตือนซ้ำเมื่อแก้ไขรายการที่มีสลิปแล้ว
                    // html += `
                    // <button onclick="window.app.editTransaction('${t.id}')" class="text-xs text-blue-300 hover:text-blue-500 p-1">
                    //     <i class="fa-solid fa-pen"></i>
                    // </button>
                    // `;

                    // Delete Icon (Admin Only)
                    if (this.data.userRole === 'admin') {
                        html += `
                            <button onclick="window.app.deleteTransaction('${t.id}')" class="text-xs text-red-300 hover:text-red-500 p-1">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        `;
                    }

                    html += `</div></div>`;
                    div.innerHTML = html;
                    list.appendChild(div);
                });
            },

            calculateSettlement() {
                const transactions = this.data.transactions.filter(t => t.date.startsWith(this.data.currentMonth));
                const balances = {};
                this.data.members.forEach(m => balances[m] = 0);

                transactions.forEach(t => {
                    const payer = t.payer;
                    if (balances[payer] !== undefined) balances[payer] += Number(t.amount);
                    if (t.splits) {
                        Object.entries(t.splits).forEach(([name, amount]) => {
                            if (balances[name] !== undefined) balances[name] -= Number(amount);
                        });
                    }
                });

                const debtors = [], creditors = [];
                Object.entries(balances).forEach(([name, amount]) => {
                    const val = Math.round(amount * 100) / 100;
                    if (val < -1) debtors.push({ name, amount: Math.abs(val) });
                    if (val > 1) creditors.push({ name, amount: val });
                });

                debtors.sort((a, b) => b.amount - a.amount);
                creditors.sort((a, b) => b.amount - a.amount);

                const plan = [];
                let i = 0, j = 0;

                while (i < debtors.length && j < creditors.length) {
                    const debtor = debtors[i];
                    const creditor = creditors[j];
                    const amount = Math.min(debtor.amount, creditor.amount);

                    if (amount > 0) {
                        plan.push({ from: debtor.name, to: creditor.name, amount });
                    }

                    debtor.amount -= amount;
                    creditor.amount -= amount;

                    if (debtor.amount < 0.01) i++;
                    if (creditor.amount < 0.01) j++;
                }

                this.renderSettlementPlan(plan);
            },

            renderSettlementPlan(plan) {
                const container = document.getElementById('settlement-plan');
                if (!container) return; // Might be hidden or different view

                if (plan.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fa-solid fa-check-circle text-4xl text-emerald-400 mb-3"></i>
                            <p class="text-slate-500">ไม่มีรายการต้องเคลียร์</p>
                        </div>
                    `;
                    return;
                }

                const currentUser = this.data.currentUser;

                container.innerHTML = plan.map(p => {
                    const isMe = p.from === currentUser;
                    const isReceiving = p.to === currentUser;

                    let highlightClass = "";
                    if (isMe) highlightClass = "bg-red-50 border-red-100 ring-1 ring-red-200";
                    else if (isReceiving) highlightClass = "bg-emerald-50 border-emerald-100 ring-1 ring-emerald-200";
                    else highlightClass = "bg-white border-slate-100";

                    return `
                    <div class="flex items-center justify-between p-4 rounded-xl border shadow-sm ${highlightClass} transition-all hover:shadow-md">
                        <div class="flex items-center gap-4">
                            <div class="flex flex-col items-center justify-center min-w-[3rem]">
                                <span class="font-bold text-sm ${isMe ? 'text-red-600' : 'text-slate-700'}">${p.from}</span>
                                <i class="fa-solid fa-arrow-down text-slate-300 text-xs my-1"></i>
                                <span class="font-bold text-sm ${isReceiving ? 'text-emerald-600' : 'text-slate-700'}">${p.to}</span>
                            </div>
                        </div>
                        
                        <div class="flex flex-col items-end gap-2">
                            <span class="font-bold text-xl text-slate-900">${p.amount.toLocaleString()} ฿</span>
                            
                            <div class="flex gap-2">
                                ${isMe ? `
                                    <button onclick="window.app.showPromptPayQR(${p.amount}, '${p.to}')" 
                                        class="px-3 py-1.5 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 flex items-center gap-1.5 shadow-sm active:scale-95 transition-all">
                                        <i class="fa-solid fa-qrcode"></i> Scan
                                    </button>
                                    <button onclick="window.app.openSlipUploadModal('${p.from}', '${p.to}', ${p.amount})" 
                                        class="px-3 py-1.5 bg-emerald-500 text-white text-xs font-bold rounded-lg hover:bg-emerald-600 flex items-center gap-1.5 shadow-sm active:scale-95 transition-all">
                                        <i class="fa-solid fa-upload"></i> Slip
                                    </button>
                                ` : ''}
                                
                                ${!isMe ? `
                                    <button onclick="window.app.showPromptPayQR(${p.amount}, '${p.to}')" 
                                        class="px-2 py-1.5 bg-slate-100 text-slate-400 text-xs rounded-lg hover:bg-slate-200 hover:text-slate-600 transition-colors" title="ดู QR Code">
                                        <i class="fa-solid fa-qrcode"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            },

            showAdminLogin() { document.getElementById('admin-login-form').classList.toggle('hidden'); },
            toggleAdminForm() { document.getElementById('admin-login-form').classList.toggle('hidden'); },

            loginAsAdmin() {
                const u = document.getElementById('admin-user').value;
                const p = document.getElementById('admin-pass').value;
                if (u.toLowerCase() === 'admin' && p === '0000') this.completeLogin('admin');
                else alert('รหัสผ่านไม่ถูกต้อง');
            },

            // === ONBOARDING FUNCTIONS ===

            async ensureMemberExists(lineUser) {
                const { userId, displayName } = lineUser;

                // Check if member exists
                const q = query(collection(db, 'members'), where('lineUserId', '==', userId));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    // Auto-create member
                    const memberName = this.generateMemberName(displayName);
                    const newMemberRef = doc(collection(db, 'members'));

                    await setDoc(newMemberRef, {
                        name: memberName,
                        lineUserId: userId,
                        lineDisplayName: displayName,
                        createdAt: new Date()
                    });

                    console.log('✅ Auto-created member:', memberName);

                    // Return the new member data
                    return {
                        id: newMemberRef.id,
                        name: memberName,
                        lineUserId: userId,
                        lineDisplayName: displayName,
                        ref: newMemberRef
                    };
                }

                const memberDoc = snapshot.docs[0];
                return {
                    id: memberDoc.id,
                    ...memberDoc.data(),
                    ref: memberDoc.ref
                };
            },

            generateMemberName(displayName) {
                // Extract meaningful name from LINE display name
                const cleaned = displayName.replace(/[^a-zA-Zก-๙]/g, '').toUpperCase();
                return cleaned.substring(0, 10) || 'USER' + Date.now();
            },

            checkOnboardingComplete(member) {
                if (!member) {
                    console.log('❌ No member data');
                    return false;
                }

                // Check if all required fields exist
                const hasRealName = member.realName && member.realName.trim().length > 0;
                const hasEnglishName = member.englishName && member.englishName.trim().length > 0;
                const hasPromptpay = member.promptpay && member.promptpay.trim().length > 0;

                console.log('Field check:', {
                    hasRealName,
                    hasEnglishName,
                    hasPromptpay,
                    realName: member.realName,
                    englishName: member.englishName,
                    promptpay: member.promptpay
                });

                return hasRealName && hasEnglishName && hasPromptpay;
            },

            showOnboardingModal(member) {
                document.getElementById('onboarding-modal').classList.remove('hidden');

                // Pre-fill with existing data if any
                document.getElementById('onboard-real-name').value = member?.realName || '';
                document.getElementById('onboard-english-name').value = member?.englishName || '';
                document.getElementById('onboard-promptpay').value = member?.promptpay || '';
            },

            async completeOnboarding(e) {
                e.preventDefault();

                const realName = document.getElementById('onboard-real-name').value.trim();
                const englishName = document.getElementById('onboard-english-name').value.trim();
                const promptpay = document.getElementById('onboard-promptpay').value.trim();

                // Validate PromptPay format
                const cleanPromptpay = promptpay.replace(/[^0-9]/g, '');
                if (!/^[0-9]{10,13}$/.test(cleanPromptpay)) {
                    alert('กรุณากรอกพร้อมเพย์ให้ถูกต้อง (10 หรือ 13 หลัก)');
                    return;
                }

                try {
                    // Get current member
                    const member = this.data.rawMembers.find(m => m.lineUserId === this.data.lineUserId);

                    if (!member || !member.ref) {
                        alert('ไม่พบข้อมูลสมาชิก');
                        return;
                    }

                    // Update member in Firebase
                    await updateDoc(member.ref, {
                        realName,
                        englishName,
                        promptpay: cleanPromptpay,
                        onboardingCompletedAt: new Date()
                    });

                    // Update local data
                    member.realName = realName;
                    member.englishName = englishName;
                    member.promptpay = cleanPromptpay;

                    // Hide modal
                    document.getElementById('onboarding-modal').classList.add('hidden');
                    this.showToast('✅ บันทึกข้อมูลเรียบร้อย!');

                    // Go to dashboard
                    this.navigate('dashboard');
                } catch (error) {
                    console.error('Error completing onboarding:', error);
                    alert('เกิดข้อผิดพลาด: ' + error.message);
                }
            },



            triggerGameEmoji(e) {
                const el = e.target;
                el.style.transform = "scale(1.2)";
                setTimeout(() => el.style.transform = "scale(1)", 200);
            },

            populateMonthSelectors() {
                const date = new Date();
                const currentMonthVal = date.toISOString().slice(0, 7);
                let html = "";
                for (let i = 0; i < 12; i++) {
                    const val = date.toISOString().slice(0, 7);
                    let label = date.toLocaleString('th-TH', { month: 'long', year: 'numeric' });
                    if (val === currentMonthVal) {
                        label = "เดือนปัจจุบัน";
                    }
                    html += `<option value="${val}">${label}</option>`;
                    date.setMonth(date.getMonth() - 1);
                }
                document.querySelectorAll('.global-month-selector, #delete-month-selector').forEach(s => s.innerHTML = html);
            },

            setMonth(val) {
                this.data.currentMonth = val;
                this.updateMonthDisplay();
                this.refreshCurrentView();
            },

            changeMonth(delta) {
                console.log('changeMonth called with delta:', delta);
                const date = new Date(this.data.currentMonth + '-01');
                date.setMonth(date.getMonth() + delta);
                const newMonth = date.toISOString().slice(0, 7);
                console.log('New month:', newMonth);
                this.setMonth(newMonth);
            },

            updateMonthDisplay() {
                console.log('updateMonthDisplay called, currentMonth:', this.data.currentMonth);
                const selectedDate = new Date(this.data.currentMonth + '-01');
                const currentDate = new Date();
                const currentMonth = currentDate.toISOString().slice(0, 7);

                let displayText;

                // ถ้าเป็นเดือนปัจจุบัน แสดง "เดือนนี้"
                if (this.data.currentMonth === currentMonth) {
                    displayText = 'เดือนนี้';
                } else {
                    // ถ้าไม่ใช่ แสดงชื่อเดือน + ปี
                    const thaiMonths = [
                        'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน',
                        'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม',
                        'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
                    ];
                    const month = thaiMonths[selectedDate.getMonth()];
                    const year = selectedDate.getFullYear() + 543; // แปลงเป็น พ.ศ.
                    displayText = `${month} ${year}`;
                }

                console.log('Display text:', displayText);

                // อัปเดตทุก display
                const displays = [
                    'current-month-display',    // Dashboard
                    'history-month-display',     // History
                    'settlement-month-display'   // Settlement
                ];

                displays.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = displayText;
                        console.log(`Updated ${id}:`, displayText);
                    } else {
                        console.warn(`Element ${id} not found`);
                    }
                });
            },

            populatePayerSelector() {
                const sel = document.getElementById('t-payer');
                sel.innerHTML = this.data.members.map(m => `<option value="${m}">${m}</option>`).join('');
            },

            renderMemberList() {
                const list = document.getElementById('member-list');
                list.innerHTML = "";
                this.data.members.forEach(m => {
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-2 bg-[#2c2c2e] border border-white/10 px-4 py-2 rounded-xl shadow-sm";
                    div.innerHTML = `
                        <span class="text-sm font-bold text-white tracking-wide">${m}</span>
                        ${(m !== 'GAME' && this.data.userRole === 'admin') ? `<button onclick="window.app.deleteMember('${m}')" class="text-[10px] w-5 h-5 flex items-center justify-center rounded-full bg-red-500/20 text-red-500 hover:bg-red-500 hover:text-white transition-colors ml-1"><i class="fa-solid fa-xmark"></i></button>` : ''}
                    `;
                    list.appendChild(div);
                });
            },

            async toggleAdminRole(name, currentRole) {
                if (this.data.userRole !== 'admin') return;
                const newRole = currentRole === 'admin' ? 'member' : 'admin';
                if (!confirm(`ยืนยันเปลี่ยนสิทธิ์ ${name} เป็น ${newRole}?`)) return;

                try {
                    const target = (this.data.rawMembers || []).find(m => m.name === name);
                    if (target) {
                        const ref = target.ref || doc(db, "members", target.id);
                        await updateDoc(ref, { role: newRole });
                        this.showToast(`บันทึกสิทธิ์ ${name} เรียบร้อย`);
                    }
                } catch (e) {
                    console.error(e);
                    alert("เกิดข้อผิดพลาด: " + e.message);
                }
            },

            async addMember() {
                const input = document.getElementById('new-member-name');
                const name = input.value.trim().toUpperCase();
                if (!name || this.data.members.includes(name)) return;
                await addDoc(collection(db, "members"), { name });
                input.value = "";
            },

            async calculateSettlement() {
                const filtered = this.data.transactions.filter(t => t.date.startsWith(this.data.currentMonth));
                const balances = {};
                this.data.members.forEach(m => balances[m] = 0);

                filtered.forEach(t => {
                    const payer = (t.payer || "").toUpperCase();
                    if (balances.hasOwnProperty(payer)) balances[payer] += Number(t.amount);
                    if (t.splits) {
                        Object.keys(t.splits).forEach(k => {
                            const memberKey = k.toUpperCase();
                            if (balances.hasOwnProperty(memberKey)) balances[memberKey] -= Number(t.splits[k]);
                        });
                    }
                });

                // Fetch verified settlements (ใช้ครั้งเดียวสำหรับทั้ง balance และ display)
                const verifiedSnapshot = await getDocs(
                    query(collection(db, 'settlements'),
                        where('month', '==', this.data.currentMonth),
                        where('status', '==', 'verified'))
                );

                const verifiedSettlements = [];
                verifiedSnapshot.forEach(doc => {
                    const s = doc.data();
                    verifiedSettlements.push({
                        from: s.from,
                        to: s.to,
                        amount: s.amount,
                        status: 'verified',
                        slip: s.slip
                    });

                    // หัก verified settlements ออกจาก balances
                    if (balances.hasOwnProperty(s.from)) balances[s.from] += s.amount;
                    if (balances.hasOwnProperty(s.to)) balances[s.to] -= s.amount;
                });

                // Render member status grid
                const grid = document.getElementById('settlement-status-grid');
                grid.innerHTML = "";

                // Helper for Profile Pic
                const getPic = (name, size = "w-6 h-6", text = "text-[10px]") => {
                    const member = this.data.rawMembers.find(m => m.name === name);
                    if (member && member.pictureUrl) return `<img src="${member.pictureUrl}" class="${size} rounded-full object-cover border border-white/10 shadow-sm shrink-0">`;
                    return `<div class="${size} rounded-full bg-slate-700 text-white flex items-center justify-center font-bold ${text} border border-white/10 shadow-sm shrink-0">${name.substring(0, 1)}</div>`;
                };

                // Sort members: Always Current User first, expand in place
                const currentUser = (this.data.currentUser || "").toUpperCase();
                const activeCard = (this.data.activeMemberCard || currentUser).toUpperCase();
                const sortedMembers = [...this.data.members].sort((a, b) => {
                    if (a === currentUser) return -1;
                    if (b === currentUser) return 1;
                    return 0;
                });

                sortedMembers.forEach((name, index) => {
                    const amount = balances[name] || 0;
                    const div = document.createElement('div');
                    const isCurrentUser = name === (this.data.currentUser || "").toUpperCase();
                    const isActive = name === activeCard;

                    // Card color driven by CSS via data-is-me attribute (changes on scroll, not click)
                    div.dataset.isMe = isCurrentUser ? 'true' : 'false';
                    div.className = `card-stack-item ${isActive ? 'centered' : ''} p-4 rounded-[22px] shadow-xl flex flex-col justify-between cursor-pointer border relative overflow-hidden`;

                    // onclick: always show member details immediately on click
                    div.dataset.memberName = name;
                    div.onclick = (e) => {
                        // Prevent firing if user was dragging (desktop)
                        if (grid._wasDragging) { grid._wasDragging = false; return; }
                        window.app.showMemberDetails(name);
                    };
                    const formattedAmt = Math.abs(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                    const decorHtml = `<div class="absolute top-0 right-0 w-28 h-28 bg-white/10 rounded-full blur-2xl -mr-8 -mt-8 pointer-events-none"></div>`;

                    let badgeHtml = isCurrentUser
                        ? `<span class="text-[8px] font-bold bg-white/15 text-white px-1.5 py-0.5 rounded-full"><i class="fa-solid fa-user mr-0.5"></i>ฉัน</span>`
                        : `<span class="text-[8px] font-bold bg-white/10 text-white/70 px-1.5 py-0.5 rounded-full"><i class="fa-solid fa-clock-rotate-left mr-0.5"></i>ดูประวัติ</span>`;


                    let textHtml = amount >= 0.01
                        ? `ต้องได้รับ`
                        : (amount <= -0.01 ? `ต้องจ่าย` : `เคลียร์พอดี`);
                    let amtColor = amount >= 0.01 ? 'text-emerald-300' : (amount <= -0.01 ? 'text-rose-300' : 'text-white/80');
                    let amtIcon = amount >= 0.01
                        ? '<i class="fa-solid fa-arrow-up text-[10px] mr-0.5"></i>'
                        : (amount <= -0.01 ? '<i class="fa-solid fa-arrow-down text-[10px] mr-0.5"></i>' : '');

                    div.innerHTML = `
                        ${decorHtml}
                        <div class="flex items-center justify-between relative z-10">
                            <div class="flex items-center gap-2">
                                ${getPic(name, 'w-8 h-8', 'text-sm')}
                                <span class="text-xs font-extrabold text-white">${name}</span>
                            </div>
                            ${badgeHtml}
                        </div>
                        <div class="relative z-10">
                            <p class="text-[9px] font-semibold text-white/50 mb-0.5 uppercase tracking-widest">${textHtml}</p>
                            <span class="text-[20px] font-extrabold ${amtColor} flex items-center gap-0.5 leading-none">
                                ${amtIcon}${formattedAmt} <span class="text-[10px] font-bold text-white/40 ml-0.5">฿</span>
                            </span>
                        </div>
                    `;

                    grid.appendChild(div);
                });
                // No manual spacer needed — container ::before/::after handles first/last card centering

                // Define cards array from the DOM now that all are appended
                const cards = Array.from(grid.querySelectorAll('.card-stack-item'));

                // Add spacer divs so first/last card can scroll to center
                // spacerBefore = (containerW - cardW) / 2  so first card centers
                // spacerAfter  = containerW / 2            guaranteed last card reaches center
                const firstCard = cards[0];
                const cardW = firstCard ? firstCard.offsetWidth : 200;
                const containerW = grid.clientWidth || window.innerWidth;
                const spacerBeforeW = Math.max(Math.round((containerW - cardW) / 2), 8);
                const spacerAfterW = Math.max(Math.round(containerW / 2), 80);

                const spacerBefore = document.createElement('div');
                spacerBefore.style.cssText = `flex-shrink:0;width:${spacerBeforeW}px;min-width:${spacerBeforeW}px;`;
                grid.insertBefore(spacerBefore, grid.firstChild);

                const spacerAfter = document.createElement('div');
                spacerAfter.style.cssText = `flex-shrink:0;width:${spacerAfterW}px;min-width:${spacerAfterW}px;`;
                grid.appendChild(spacerAfter);

                // Centering logic: works on both mobile and desktop
                {
                    let animationFrameId = null;

                    const updateCenterCard = () => {
                        const gridRect = grid.getBoundingClientRect();
                        const gridCenter = gridRect.left + gridRect.width / 2;
                        let minDiff = Infinity;
                        let centeredCard = null;

                        cards.forEach(c => {
                            const rect = c.getBoundingClientRect();
                            const cardCenter = rect.left + rect.width / 2;
                            const diff = Math.abs(gridCenter - cardCenter);
                            if (diff < minDiff) { minDiff = diff; centeredCard = c; }
                        });

                        cards.forEach(c => c.classList.remove('centered'));
                        if (centeredCard) centeredCard.classList.add('centered');
                    };

                    grid.addEventListener('scroll', () => {
                        if (animationFrameId) cancelAnimationFrame(animationFrameId);
                        animationFrameId = requestAnimationFrame(updateCenterCard);
                    }, { passive: true });

                    // Mouse drag scroll (desktop)
                    let isDown = false, startX, scrollLeft;
                    grid.addEventListener('mousedown', e => {
                        isDown = true; grid._wasDragging = false;
                        grid.classList.add('is-dragging');
                        startX = e.pageX - grid.offsetLeft; scrollLeft = grid.scrollLeft;
                    });
                    window.addEventListener('mouseup', () => { isDown = false; grid.classList.remove('is-dragging'); });
                    grid.addEventListener('mousemove', e => {
                        if (!isDown) return; e.preventDefault();
                        const walk = (e.pageX - grid.offsetLeft - startX) * 1.5;
                        if (Math.abs(walk) > 4) grid._wasDragging = true; // only flag if actual drag
                        grid.scrollLeft = scrollLeft - walk;
                    });

                    setTimeout(updateCenterCard, 60);
                }

                // Calculate debtors and creditors
                const debtors = [], creditors = [];
                this.data.members.forEach(m => {
                    const b = Math.round(balances[m]);
                    if (b < -1) debtors.push({ name: m, amount: Math.abs(b) });
                    if (b > 1) creditors.push({ name: m, amount: b });
                });

                this.data.settlementPlan = [];
                const planContainer = document.getElementById('settlement-plan');
                planContainer.innerHTML = "";

                // Verified settlements — dark theme card with green accent
                verifiedSettlements.forEach(vs => {
                    const item = document.createElement('div');
                    item.className = 'bg-[#1c1c1e] p-4 rounded-[20px] border border-emerald-500/25 shadow-sm';
                    item.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2 font-bold text-white">
                                ${getPic(vs.from)} <span class="text-sm">${vs.from}</span>
                                <i class="fa-solid fa-arrow-right text-[10px] mx-1 text-slate-500"></i>
                                ${getPic(vs.to)} <span class="text-sm">${vs.to}</span>
                            </div>
                            <div class="font-extrabold text-emerald-400 text-sm">${vs.amount.toLocaleString()} ฿</div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[11px] bg-emerald-500/15 text-emerald-400 border border-emerald-500/30 px-2.5 py-1 rounded-full font-bold flex items-center gap-1">
                                <i class="fa-solid fa-circle-check"></i> ยืนยันแล้ว
                            </span>
                            <span class="text-[11px] text-slate-500 flex items-center gap-1">
                                <i class="fa-solid fa-calendar-check"></i> ${this.formatSlipDate(vs.slip.transDate)}
                            </span>
                        </div>
                    `;
                    planContainer.appendChild(item);
                });

                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    const d = debtors[i];
                    const c = creditors[j];
                    const pay = Math.min(d.amount, c.amount);

                    // เช็คว่า settlement นี้ verified แล้วหรือยัง
                    const isVerified = verifiedSettlements.some(
                        vs => vs.from === d.name && vs.to === c.name && Math.abs(vs.amount - pay) < 1
                    );

                    // ถ้ายังไม่ verified ถึงจะแสดง
                    if (!isVerified) {
                        this.data.settlementPlan.push({ from: d.name, to: c.name, amount: pay, status: 'pending' });

                        // สร้าง Settlement Item Card
                        const item = document.createElement('div');
                        item.className = 'bg-[#1c1c1e] p-4 rounded-[20px] border border-white/5 shadow-sm';

                        const isCurrentUserPayer = d.name === this.data.currentUser;

                        item.innerHTML = `
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2 font-bold text-white">
                                    ${getPic(d.name)} <span class="text-sm">${d.name}</span>
                                    <i class="fa-solid fa-arrow-right text-[10px] mx-1 text-slate-500"></i>
                                    ${getPic(c.name)} <span class="text-sm">${c.name}</span>
                                </div>
                                <div class="font-extrabold text-white text-sm">${pay.toLocaleString()} ฿</div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-[11px] bg-amber-500/15 text-amber-400 border border-amber-500/30 px-2.5 py-1 rounded-full font-bold flex items-center gap-1">
                                    <i class="fa-solid fa-clock"></i> รอโอนเงิน
                                </span>
                                <div class="flex gap-2">
                                    <button onclick="window.app.showPromptPayQR(${pay}, '${c.name}')"
                                        class="text-[11px] bg-white/8 text-slate-300 border border-white/10 px-3 py-1 rounded-lg font-bold hover:bg-white/15 transition-colors flex items-center gap-1 active:scale-95">
                                        <i class="fa-solid fa-qrcode"></i> Scan
                                    </button>
                                    ${isCurrentUserPayer ? `
                                    <button onclick="window.app.openSlipUploadModal('${d.name}', '${c.name}', ${pay})"
                                        class="text-[11px] bg-indigo-600 text-white px-3 py-1 rounded-lg font-bold hover:bg-indigo-700 transition-colors flex items-center gap-1 active:scale-95">
                                        <i class="fa-solid fa-cloud-arrow-up"></i> อัปโหลด
                                    </button>` : ''}
                                </div>
                            </div>
                        `;


                        planContainer.appendChild(item);
                    }

                    d.amount -= pay;
                    c.amount -= pay;

                    if (d.amount <= 0.01) i++;
                    if (c.amount <= 0.01) j++;
                }

                if (!planContainer.innerHTML) {
                    planContainer.innerHTML = `<div class="text-center py-4 text-slate-300 text-xs italic"> ไม่มีมียอดค้างชำระ</div> `;
                }
            },

            showMemberDetails(member) {
                const target = member.toUpperCase();
                const filtered = this.data.transactions.filter(t => t.date.startsWith(this.data.currentMonth))
                    .filter(t => (t.payer || "").toUpperCase() === target || Object.keys(t.splits || {}).some(k => k.toUpperCase() === target))
                    .sort((a, b) => new Date(b.date) - new Date(a.date) || (b.timestamp || 0) - (a.timestamp || 0));
                const list = document.getElementById('member-detail-list');
                list.innerHTML = '';          // clear previous content
                let totalSpent = 0;           // reset total

                if (filtered.length === 0) {
                    list.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-10 gap-3 text-center">
                            <div class="w-14 h-14 rounded-full bg-white/5 flex items-center justify-center">
                                <i class="fa-solid fa-receipt text-2xl text-slate-500"></i>
                            </div>
                            <p class="text-sm font-bold text-slate-400">ไม่มีรายการค่าใช้จ่าย</p>
                            <p class="text-xs text-slate-600">ยังไม่มีรายการของเดือนนี้</p>
                        </div>
                    `;
                } else {
                    filtered.forEach(t => {
                        let myShare = 0;
                        const matchKey = Object.keys(t.splits || {}).find(k => k.toUpperCase() === target);
                        if (matchKey) myShare = Number(t.splits[matchKey]);
                        totalSpent += myShare;
                        const isPayer = (t.payer || "").toUpperCase() === target;
                        const myShareStr = myShare.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        const fullAmtStr = Number(t.amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        list.innerHTML += `<div class="bg-[#2c2c2e] p-3 rounded-xl border border-white/5 flex justify-between items-center gap-2"><div class="flex flex-col flex-1 min-w-0"><span class="text-[10px] font-bold text-slate-400 uppercase">${new Date(t.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' })}</span><span class="text-xs font-bold text-white mb-0.5 truncate">${t.desc}</span><span class="text-[9px] text-slate-400">${isPayer ? 'คุณจ่ายเอง' : 'คนจ่ายคือ ' + t.payer} | ยอดเต็ม ${fullAmtStr} ฿</span></div><div class="text-right flex flex-col justify-center shrink-0"><div class="text-sm font-bold text-white">-${myShareStr} ฿</div><div class="text-[8px] font-bold text-slate-400 uppercase tracking-tighter mt-1">ส่วนของคุณ</div></div></div>`;
                    });
                }
                document.getElementById('member-detail-title').textContent = `รายละเอียด ${target} `;
                document.getElementById('member-detail-total').textContent = `${totalSpent.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ฿`;
                document.getElementById('member-detail-modal').classList.remove('hidden');
            },

            renderDashboard() {
                const filtered = this.data.transactions.filter(t => t.date.startsWith(this.data.currentMonth));
                const total = filtered.reduce((acc, t) => acc + Number(t.amount), 0);
                document.getElementById('total-expense').textContent = total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' บาท';
                this.renderMonthlyTrendChart();
                const payers = {};
                filtered.forEach(t => { const p = (t.payer || "N/A").toUpperCase(); payers[p] = (payers[p] || 0) + Number(t.amount); });
                this.renderPayerChart(payers);
            },

            renderMonthlyTrendChart() {
                const container = document.getElementById('monthly-trend-bar-chart');
                if (!container) return;
                container.innerHTML = '';

                const months = [], amounts = [];
                const selectedDate = new Date(this.data.currentMonth + '-01');
                const thaiMonthNames = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];

                for (let i = 5; i >= 0; i--) {
                    const d = new Date(selectedDate);
                    d.setMonth(selectedDate.getMonth() - i);
                    const key = d.toISOString().slice(0, 7);
                    months.push(thaiMonthNames[d.getMonth()]);
                    const total = this.data.transactions
                        .filter(t => t.date.startsWith(key))
                        .reduce((a, t) => a + Number(t.amount), 0);
                    amounts.push(total);
                }

                const maxAmt = Math.max(...amounts, 1);

                amounts.forEach((amt, i) => {
                    const pct = Math.max(Math.round((amt / maxAmt) * 100), 8);
                    const isHighlight = i === 5;
                    const label = amt >= 1000
                        ? (amt >= 1000000 ? (amt / 1000000).toFixed(1) + 'M' : (amt / 1000).toFixed(1) + 'K')
                        : (Math.round(amt) || '0');
                    const col = document.createElement('div');
                    col.className = 'flex flex-col items-center justify-end flex-1 h-full gap-1.5';
                    col.innerHTML = `
                        <span class="text-[10px] font-bold ${isHighlight ? 'text-white' : 'text-slate-400'} leading-tight text-center">${label}</span>
                        <div class="w-full rounded-full" style="height: ${pct}%; background: ${isHighlight ? 'linear-gradient(to bottom, #a5b4fc, #4f46e5)' : 'rgba(99,102,241,0.22)'}; min-height: 10%;"></div>
                        <span class="text-[10px] font-semibold ${isHighlight ? 'text-indigo-400' : 'text-slate-500'}">${months[i]}</span>
                    `;
                    container.appendChild(col);
                });
            },

            renderPayerChart(data) {
                const container = document.getElementById('payerChart');
                if (!container) return;
                // Replace content with a custom HTML donut chart
                container.innerHTML = '';

                const entries = Object.entries(data).sort((a, b) => b[1] - a[1]);
                if (entries.length === 0) {
                    container.innerHTML = '<p class="text-center text-slate-500 text-xs py-8">ไม่มีข้อมูล</p>';
                    return;
                }

                const total = entries.reduce((s, [, v]) => s + v, 0);
                const colors = ['#6366f1', '#a855f7', '#ec4899', '#0ea5e9', '#10b981', '#f59e0b', '#ef4444'];

                // Build SVG donut
                const radius = 54;
                const cx = 70, cy = 70;
                const circumference = 2 * Math.PI * radius;
                let cumulativePct = 0;
                const segments = entries.map(([name, val], i) => {
                    const pct = val / total;
                    const dash = pct * circumference;
                    const gap = circumference - dash;
                    const offset = -cumulativePct * circumference;
                    cumulativePct += pct;
                    return `<circle cx="${cx}" cy="${cy}" r="${radius}" fill="none" stroke="${colors[i % colors.length]}" stroke-width="14" stroke-dasharray="${dash.toFixed(2)} ${gap.toFixed(2)}" stroke-dashoffset="${offset.toFixed(2)}" stroke-linecap="round" transform="rotate(-90 ${cx} ${cy})"/>`;
                }).join('');

                const totalStr = total >= 1000 ? (total / 1000).toFixed(1) + 'K' : Math.round(total);

                const legendHtml = entries.map(([name, val], i) => `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="w-2.5 h-2.5 rounded-full shrink-0" style="background:${colors[i % colors.length]}"></span>
                            <span class="text-xs font-semibold text-slate-300 truncate max-w-[90px]">${name}</span>
                        </div>
                        <span class="text-xs font-bold text-white">${val.toLocaleString()} ฿</span>
                    </div>
                `).join('');

                container.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="shrink-0 relative" style="width:140px;height:140px">
                            <svg width="140" height="140" viewBox="0 0 140 140">
                                <circle cx="${cx}" cy="${cy}" r="${radius}" fill="none" stroke="rgba(255,255,255,0.07)" stroke-width="14"/>
                                ${segments}
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-[11px] text-slate-400 font-semibold">รวม</span>
                                <span class="text-base font-extrabold text-white leading-tight">${totalStr}</span>
                                <span class="text-[10px] text-slate-500">฿</span>
                            </div>
                        </div>
                        <div class="flex-1 flex flex-col gap-2 overflow-hidden">${legendHtml}</div>
                    </div>
                `;
            },

            openModal(id) {
                this.data.editingId = null;
                this.data.selectedGroupId = null;
                document.getElementById('modal-title').textContent = "บันทึกรายการ";
                document.getElementById('t-amount').value = "";
                document.getElementById('t-desc').value = "";
                document.getElementById('t-payment-type').value = "normal";
                // Set default date to today
                document.getElementById('t-date').value = new Date().toISOString().slice(0, 10);
                // Set default payer to current user
                document.getElementById('t-payer').value = this.data.currentUser || '';
                this.toggleInstallment();
                this.selectIcon('fa-utensils');
                document.getElementById(id).classList.remove('hidden');
                this.renderSplitParticipants();
            },

            closeModal(id) { document.getElementById(id).classList.add('hidden'); },

            toggleInstallment() {
                const type = document.getElementById('t-payment-type').value;
                const installmentWrapper = document.getElementById('t-installment-wrapper');
                const subscriptionWrapper = document.getElementById('t-subscription-wrapper');

                // ซ่อน/แสดง UI ตาม type
                installmentWrapper.classList.toggle('hidden', type !== 'installment');
                subscriptionWrapper.classList.toggle('hidden', type !== 'subscription');
            },

            selectIcon(iconName) {
                document.getElementById('t-icon').value = iconName;
                document.querySelectorAll('.icon-opt').forEach(btn => {
                    if (btn.dataset.icon === iconName) {
                        btn.classList.add('selected');
                        btn.classList.remove('bg-white');
                    } else {
                        btn.classList.remove('selected');
                        btn.classList.add('bg-white');
                    }
                });
            },

            setSplitMode(m) {
                this.data.splitMode = m;
                document.getElementById('btn-split-equal').className = m === 'equal' ? 'px-3 py-1.5 rounded-md text-[10px] font-bold bg-slate-800 text-white transition-all' : 'px-3 py-1.5 rounded-md text-[10px] font-bold text-slate-400 transition-all';
                document.getElementById('btn-split-custom').className = m === 'custom' ? 'px-3 py-1.5 rounded-md text-[10px] font-bold bg-slate-800 text-white transition-all' : 'px-3 py-1.5 rounded-md text-[10px] font-bold text-slate-400 transition-all';
                this.renderSplitParticipants();
            },

            renderSplitParticipants(involvedMembers = []) {
                const container = document.getElementById('split-participants');
                container.innerHTML = this.data.members.map(m => {
                    // Check logic: if editing (involvedMembers passed), check if in list. If new, check all.
                    const isChecked = this.data.editingId ? involvedMembers.includes(m) : true; // Default checked for all
                    return `
            <div class="flex items-center justify-between text-xs py-2 border-b border-slate-100 last:border-0">
                <label class="flex items-center gap-3 cursor-pointer select-none">
                    <input type="checkbox" ${isChecked ? 'checked' : ''} value="${m}"
                        onchange="window.app.recalculateCustomSplits('checkbox')"
                        class="participant-check rounded text-slate-800 w-4 h-4 focus:ring-slate-800">
                        <span class="text-slate-700 font-bold">${m}</span>
                </label>
                        ${this.data.splitMode === 'custom' ? `
                            <input type="number" step="0.01" data-member="${m}" 
                                oninput="window.app.onCustomAmountInput(this)"
                                class="participant-amount w-24 p-1.5 border border-slate-200 rounded-lg text-right text-xs focus:ring-2 focus:ring-blue-100 outline-none transition-colors placeholder-slate-300" 
                                placeholder="Auto">
                        ` : ''
                        }
                    </div>
            `}).join('');

                // Initial calculation
                if (this.data.splitMode === 'custom') {
                    // If editing, fill existing values
                    if (this.data.editingId) {
                        const t = this.data.transactions.find(x => x.id === this.data.editingId);
                        if (t && t.splits) {
                            Object.entries(t.splits).forEach(([name, amount]) => {
                                const input = document.querySelector(`.participant - amount[data - member="${name}"]`);
                                if (input) {
                                    input.value = amount;
                                    input.dataset.userSet = 'true';
                                }
                            });
                        }
                    }
                    this.recalculateCustomSplits('init');
                }
            },

            // editTransaction - DISABLED to prevent settlement issues
            // When user edits a transaction after slip verification, it causes notification issues
            // Kept for reference, can be re-enabled if needed in the future
            /*
            editTransaction(id) {
                const t = this.data.transactions.find(x => x.id === id);
                if (!t) return;
                this.data.editingId = id;
                this.data.selectedGroupId = t.groupId || null;

                document.getElementById('modal-title').textContent = t.groupId ? "แก้ไขรายการ (ผ่อนชำระ)" : "แก้ไขรายการ";
                document.getElementById('t-date').value = t.date;
                document.getElementById('t-payment-type').value = t.paymentType || 'normal';
                document.getElementById('t-desc').value = t.desc.split(' (')[0]; // Remove installment count text if any
                document.getElementById('t-amount').value = t.amount;
                document.getElementById('t-payer').value = t.payer;
                this.selectIcon(t.icon || 'fa-utensils');
                this.toggleInstallment();

                // If editing installment, disable payment type change (too complex to switch back and forth)
                if (t.groupId) {
                    document.getElementById('t-payment-type').disabled = true;
                } else {
                    document.getElementById('t-payment-type').disabled = false;
                }

                document.getElementById('transaction-modal').classList.remove('hidden');

                // Pass existing participants to renderSplitParticipants
                const existingParticipants = t.splits ? Object.keys(t.splits) : [];
                this.renderSplitParticipants(existingParticipants);

                // Set split mode
                // TODO: Store split mode in transaction? For now guess strictly
                // If it was custom, we expect precise splits. But let's verify.
                // Assuming default is equal unless proven otherwise.
                // Or user can switch manually.
            },
            */

            async deleteTransaction(id) {
                if (!confirm('ต้องการลบรายการนี้ใช่ไหม?')) return;

                try {
                    const t = this.data.transactions.find(x => x.id === id);
                    if (t.groupId) {
                        if (confirm('รายการนี้เป็นการผ่อนชำระ ต้องการลบทุกงวดที่เกี่ยวข้องเลยไหม?\n(CANCEL = ลบเฉพาะงวดนี้, OK = ลบทั้งหมด)')) {
                            // Delete Group
                            const batch = writeBatch(db);
                            const groupT = this.data.transactions.filter(x => x.groupId === t.groupId);
                            groupT.forEach(gt => batch.delete(doc(db, "transactions", gt.id)));
                            await batch.commit();
                            this.showToast('ลบรายการผ่อนชำระทั้งหมดแล้ว');
                            return;
                        }
                    }

                    // Delete Single
                    await deleteDoc(doc(db, "transactions", id));
                    this.showToast('ลบรายการแล้ว');
                } catch (e) {
                    console.error(e);
                    alert('ลบไม่สำเร็จ: ' + e.message);
                }
            },

            onCustomAmountInput(input) {

                // Mark this input as manually set by user
                if (input.value && input.value.trim() !== '') {
                    input.dataset.userSet = 'true';
                    input.classList.add('font-bold', 'text-slate-800', 'bg-white');
                    input.classList.remove('text-slate-500', 'bg-slate-50');
                } else {
                    delete input.dataset.userSet; // If cleared, go back to auto
                    input.classList.remove('font-bold', 'text-slate-800', 'bg-white');
                }
                this.recalculateCustomSplits('input');
            },

            recalculateCustomSplits(source) {
                if (this.data.splitMode !== 'custom') return;

                const totalAmount = Number(document.getElementById('t-amount').value) || 0;
                const inputs = document.querySelectorAll('.participant-amount');
                const checks = document.querySelectorAll('.participant-check');

                let manualSum = 0;
                const autoCandidates = [];

                // 1. Identify User Set vs Auto
                inputs.forEach((input, index) => {
                    const checkbox = checks[index];

                    if (!checkbox.checked) {
                        input.value = '';
                        input.disabled = true;
                        input.classList.add('opacity-30', 'bg-slate-100');
                        delete input.dataset.userSet;
                        return;
                    }

                    input.disabled = false;
                    input.classList.remove('opacity-30', 'bg-slate-100');

                    // If user set this value or currently typing
                    if (input.dataset.userSet === 'true') {
                        manualSum += Number(input.value) || 0;
                    } else {
                        autoCandidates.push(input);
                    }
                });

                // 2. Calculate Remaining
                let remaining = totalAmount - manualSum;
                // Avoid tiny floating point errors
                remaining = Math.round(remaining * 100) / 100;

                // 3. Distribute to Auto Candidates
                if (autoCandidates.length > 0) {
                    // Reset styles for auto inputs
                    autoCandidates.forEach(input => {
                        input.classList.add('text-slate-500', 'bg-slate-50');
                        input.classList.remove('font-bold', 'text-slate-800', 'bg-white');
                    });

                    if (remaining < 0) {
                        // Error State: Over usage
                        autoCandidates.forEach(input => {
                            input.value = 0;
                            input.classList.add('text-red-400');
                        });
                        // Optional: Show warning someplace
                    } else {
                        const share = Math.floor((remaining / autoCandidates.length) * 100) / 100;
                        let currentDistributed = 0;

                        // Distribute equally
                        autoCandidates.forEach((input, i) => {
                            input.classList.remove('text-red-400');

                            // Last person gets the dust
                            if (i === autoCandidates.length - 1) {
                                const finalAmount = remaining - currentDistributed;
                                input.value = finalAmount.toFixed(2);
                            } else {
                                input.value = share.toFixed(2);
                                currentDistributed += share;
                            }
                        });
                    }
                }
            },


            async saveTransaction() {
                // document.getElementById('loading-overlay').classList.remove('hidden');
                const amount = Number(document.getElementById('t-amount').value);
                const desc = document.getElementById('t-desc').value || "ไม่ระบุ";
                const payer = document.getElementById('t-payer').value;
                const type = document.getElementById('t-payment-type').value;
                const date = document.getElementById('t-date').value;
                const icon = document.getElementById('t-icon').value;
                if (!amount || !date) {
                    // document.getElementById('loading-overlay').classList.add('hidden');
                    return alert('เพิ่มรายการ');
                }

                const splits = {};
                const checked = Array.from(document.querySelectorAll('.participant-check:checked')).map(c => c.value);
                if (this.data.splitMode === 'equal') {
                    const share = amount / checked.length;
                    checked.forEach(m => splits[m] = share);
                } else {
                    document.querySelectorAll('.participant-amount').forEach(i => {
                        const val = Number(i.value);
                        if (val > 0) splits[i.dataset.member] = val;
                    });
                }

                const batch = writeBatch(db);

                if (this.data.editingId) {
                    if (this.data.selectedGroupId) {
                        const groupItems = this.data.transactions.filter(item => item.groupId === this.data.selectedGroupId);
                        groupItems.forEach(item => {
                            let newDesc = desc;
                            const suffixMatch = item.desc.match(/\(\d+\/\d+\)$/);
                            if (suffixMatch) newDesc += ` ${suffixMatch[0]} `;
                            batch.update(doc(db, "transactions", item.id), { desc: newDesc, payer, icon, splits });
                        });
                    } else {
                        batch.update(doc(db, "transactions", this.data.editingId), { desc, payer, amount, splits, date, icon });
                    }
                } else {
                    // สร้างรายการใหม่
                    if (type === 'installment') {
                        const installments = Number(document.getElementById('t-installments').value) || 1;
                        const groupId = "grp_" + Date.now();
                        const baseDate = new Date(date);

                        for (let i = 0; i < installments; i++) {
                            const currentInstallmentDate = new Date(baseDate);
                            currentInstallmentDate.setMonth(baseDate.getMonth() + i);
                            const txn = {
                                date: currentInstallmentDate.toISOString().slice(0, 10),
                                desc: `${desc} (${i + 1}/${installments})`,
                                amount: amount / installments,
                                payer,
                                splits: Object.fromEntries(Object.entries(splits).map(([k, v]) => [k, v / installments])),
                                paymentType: 'installment',
                                icon,
                                groupId,
                                timestamp: Date.now() + i
                            };
                            batch.set(doc(collection(db, "transactions")), txn);
                        }
                    } else if (type === 'subscription') {
                        // Subscription - สร้างเฉพาะเดือนปัจจุบัน + template (ใช้ Cloud Functions สร้างเดือนถัดไป)
                        const recurring = document.getElementById('t-subscription-recurring').checked;
                        const groupId = `sub_${Date.now()} `;

                        // สร้างรายการเดือนปัจจุบัน
                        const txn = {
                            date,
                            desc: `${desc} ${recurring ? '📅' : ''} `,
                            amount,
                            payer,
                            splits,
                            paymentType: 'subscription',
                            icon,
                            subscriptionRecurring: recurring,
                            subscriptionStartDate: date,
                            groupId: groupId,
                            timestamp: Date.now()
                        };

                        batch.set(doc(collection(db, "transactions")), txn);

                        // บันทึก template สำหรับ Cloud Functions (ถ้าเปิดใช้)
                        if (recurring) {
                            const billingDay = new Date(date).getDate();
                            const subRef = doc(collection(db, "subscription_templates"));
                            batch.set(subRef, {
                                desc,
                                amount,
                                payer,
                                splits,
                                icon,
                                billingDay,
                                groupId,
                                active: true,
                                createdAt: new Date(),
                                createdBy: this.data.currentUser,
                                lastGeneratedMonth: date.slice(0, 7) // "2026-02"
                            });
                        }
                    } else {
                        // จ่ายเต็ม (normal)
                        const txn = {
                            date,
                            desc,
                            amount,
                            payer,
                            splits,
                            paymentType: 'normal',
                            icon,
                            timestamp: Date.now()
                        };
                        batch.set(doc(collection(db, "transactions")), txn);
                    }
                }

                try {
                    await batch.commit();
                    this.closeModal('transaction-modal');
                } catch (e) {
                    alert("เกิดข้อผิดพลาด: " + e.message);
                }
                // document.getElementById('loading-overlay').classList.add('hidden');
            },

            async deleteTransaction(id) {
                if (this.data.userRole !== 'admin') return;
                const t = this.data.transactions.find(x => x.id === id);
                if (!t) return;

                if (t.groupId) {
                    const deleteChoice = confirm('ยืนยันต้องการลบรายการที่เกี่ยวข้องทั้งหมดหรือไม่?\n\nOK: ลบทั้งหมด\nCancel: ยกเลิก');
                    if (!deleteChoice) return;

                    // document.getElementById('loading-overlay').classList.remove('hidden');
                    const batch = writeBatch(db);

                    // Find all items with same groupId (across ALL time)
                    // Note: We use this.data.transactions which contains ALL loaded transactions.
                    // If your app loads all data at init, this works. If it limits query, this needs a backend query.
                    // Assuming current logic loads all:
                    const groupItems = this.data.transactions.filter(item => item.groupId === t.groupId);
                    groupItems.forEach(item => batch.delete(doc(db, "transactions", item.id.trim())));

                    try {
                        await batch.commit();

                        // ลบ settlements ที่เกี่ยวข้องกับ group นี้
                        const groupTransactionIds = groupItems.map(item => item.id);
                        const settlementsQuery = query(
                            collection(db, 'settlements'),
                            where('status', '==', 'verified')
                        );

                        const settlementsSnapshot = await getDocs(settlementsQuery);
                        const settlementBatch = writeBatch(db);
                        let deletedCount = 0;

                        settlementsSnapshot.forEach(doc => {
                            const settlement = doc.data();
                            // เช็คว่ามี transaction ID ใดใน group หรือไม่
                            const hasGroupTransaction = settlement.transactionIds?.some(
                                tId => groupTransactionIds.includes(tId)
                            );
                            if (hasGroupTransaction) {
                                settlementBatch.delete(doc.ref);
                                deletedCount++;
                            }
                        });

                        if (deletedCount > 0) {
                            await settlementBatch.commit();
                            console.log(`Deleted ${deletedCount} related settlements`);
                        }
                    } catch (e) { alert("เกิดข้อผิดพลาด: " + e.message); }
                    // document.getElementById('loading-overlay').classList.add('hidden');
                } else if (t.desc.match(/\(\d+\/\d+\)$/)) {
                    const confirmLegacy = confirm("ยืนยันต้องการลบรายการผ่อนที่เหลือทั้งหมดหรือไม่?\n\nOK: ลบทั้งหมดรวมงวดหน้า\nCancel: ลบแค่งวดนี้");
                    // document.getElementById('loading-overlay').classList.remove('hidden');
                    const batch = writeBatch(db);
                    if (confirmLegacy) {
                        const baseName = t.desc.split(' (')[0];
                        const itemsToDelete = this.data.transactions.filter(item => item.desc.startsWith(baseName) && item.desc.match(/\(\d+\/\d+\)$/) && item.date >= t.date);
                        itemsToDelete.forEach(item => batch.delete(doc(db, "transactions", item.id.trim())));
                    } else {
                        batch.delete(doc(db, "transactions", id.trim()));
                    }
                    try { await batch.commit(); } catch (e) { alert("เกิดข้อผิดพลาด: " + e.message); }
                    // document.getElementById('loading-overlay').classList.add('hidden');
                } else {
                    if (confirm('ยืนยันลบรายการนี้?')) {
                        // document.getElementById('loading-overlay').classList.remove('hidden');
                        try {
                            await deleteDoc(doc(db, "transactions", id.trim()));

                            // ลบ verified settlements ที่เกี่ยวข้องกับ transaction นี้เท่านั้น
                            const settlementsQuery = query(
                                collection(db, 'settlements'),
                                where('transactionIds', 'array-contains', id),
                                where('status', '==', 'verified')
                            );

                            const settlementsSnapshot = await getDocs(settlementsQuery);
                            const batch = writeBatch(db);
                            settlementsSnapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });

                            if (!settlementsSnapshot.empty) {
                                await batch.commit();
                                console.log(`Deleted ${settlementsSnapshot.size} related settlements`);
                            }
                        } catch (e) { alert("เกิดข้อผิดพลาด: " + e.message); }
                        // document.getElementById('loading-overlay').classList.add('hidden');
                    }
                }
            },

            async clearMonthData() {
                if (this.data.userRole !== 'admin') return;
                const m = document.getElementById('delete-month-selector').value;
                if (confirm(`ยืนยันลบข้อมูลทั้งหมดของเดือน ${m}?\n(ไม่สามารถกู้คืนได้ และจะลบรายการผ่อนที่เกี่ยวข้องด้วย)`)) {
                    const itemsInMonth = this.data.transactions.filter(t => t.date.startsWith(m));
                    const batch = writeBatch(db);

                    // Collect Group IDs to delete entirely
                    const groupIdsToDelete = new Set();
                    const individualIdsToDelete = new Set();

                    itemsInMonth.forEach(t => {
                        if (t.groupId) groupIdsToDelete.add(t.groupId);
                        else individualIdsToDelete.add(t.id);
                    });

                    // Add individual items
                    individualIdsToDelete.forEach(id => batch.delete(doc(db, "transactions", id)));

                    // Add ALL items belonging to the found groups (even if outside this month)
                    if (groupIdsToDelete.size > 0) {
                        const allRelatedGroupItems = this.data.transactions.filter(t => t.groupId && groupIdsToDelete.has(t.groupId));
                        allRelatedGroupItems.forEach(t => batch.delete(doc(db, "transactions", t.id)));
                    }

                    // ลบ settlements ของเดือนนี้ด้วย
                    const settlementsQuery = query(
                        collection(db, 'settlements'),
                        where('month', '==', m)
                    );

                    const settlementsSnapshot = await getDocs(settlementsQuery);
                    settlementsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    console.log(`Will delete ${settlementsSnapshot.size} settlements from ${m} `);

                    await batch.commit();
                    alert(`ลบข้อมูลเดือน ${m} เรียบร้อย\n - Transactions: ${itemsInMonth.length} รายการ\n - Settlements: ${settlementsSnapshot.size} รายการ`);
                    await this.loadTransactions();
                }
            },

            async cleanUpOldData() {
                if (this.data.userRole !== 'admin') {
                    alert('เฉพาะ Admin เท่านั้นที่สามารถล้างข้อมูลได้');
                    return;
                }

                // คำนวณวันที่ cutoff (2 เดือนที่แล้ว)
                const today = new Date();
                const twoMonthsAgo = new Date(today);
                twoMonthsAgo.setMonth(today.getMonth() - 2);
                const cutoffMonth = twoMonthsAgo.toISOString().slice(0, 7); // "2025-11"

                // นับจำนวนข้อมูลที่จะลบ
                const oldTransactions = this.data.transactions.filter(t => t.date < `${cutoffMonth}-01`);

                if (oldTransactions.length === 0) {
                    alert('ไม่มีข้อมูลเก่าที่ต้องล้าง');
                    return;
                }

                // ขอยืนยัน
                const confirmMsg = `พบข้อมูลเก่ากว่า ${cutoffMonth} จำนวน ${oldTransactions.length} รายการ\n\n` +
                    `ยืนยันต้องการลบข้อมูลเหล่านี้หรือไม่ ?\n` +
                    `(ไม่สามารถกู้คืนได้)`;

                if (!confirm(confirmMsg)) return;

                try {
                    // แสดง loading
                    const loadingEl = document.getElementById('loading-overlay');
                    if (loadingEl) loadingEl.classList.remove('hidden');

                    const batch = writeBatch(db);

                    // ลบ transactions เก่า
                    oldTransactions.forEach(t => {
                        batch.delete(doc(db, 'transactions', t.id));
                    });

                    // หา settlements เก่าและลบด้วย
                    const settlementsQuery = query(
                        collection(db, 'settlements'),
                        where('month', '<', cutoffMonth)
                    );

                    const settlementsSnapshot = await getDocs(settlementsQuery);
                    settlementsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    // Commit
                    await batch.commit();

                    // ซ่อน loading
                    if (loadingEl) loadingEl.classList.add('hidden');

                    // แจ้งผลลัพธ์
                    alert(`ล้างข้อมูลเสร็จสิ้น!\n\n` +
                        `- ลบ transactions: ${oldTransactions.length} รายการ\n` +
                        `- ลบ settlements: ${settlementsSnapshot.size} รายการ`);

                    // โหลดข้อมูลใหม่
                    await this.loadTransactions();

                } catch (e) {
                    alert('เกิดข้อผิดพลาด: ' + e.message);
                    const loadingEl = document.getElementById('loading-overlay');
                    if (loadingEl) loadingEl.classList.add('hidden');
                }
            },

            exportCSV() {
                if (this.data.transactions.length === 0) return alert("ไม่มีข้อมูลสำหรับการ Export");

                const rows = [
                    ["Date", "Description", "Payer", "Amount", "Type", "Splits"]
                ];

                this.data.transactions.forEach(t => {
                    const splitDetails = t.splits ? JSON.stringify(t.splits).replace(/"/g, "'") : "";
                    rows.push([
                        t.date,
                        `"${t.desc}"`,
                        t.payer,
                        t.amount,
                        t.paymentType || 'normal',
                        `"${splitDetails}"`
                    ]);
                });

                let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `dept_money_export_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            saveApiConfig() {
                // Feature Removed
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg;
                t.className = "show";
                setTimeout(() => t.className = t.className.replace("show", ""), 3000);
            },

            // --- FUNCTION TO CALL YOUR BACKEND API ---
            async sendLineMessage() {
                if (!this.data.settlementPlan || this.data.settlementPlan.length === 0) {
                    return alert("ไม่พบข้อมูลหนี้ที่ต้องเคลียร์ กรุณาตรวจสอบอีกครั้ง");
                }

                const apiUrl = this.data.apiEndpoint; // e.g. /api/send-line or full URL
                const monthName = new Date(this.data.currentMonth).toLocaleString('th-TH', { month: 'long', year: 'numeric' });

                // Show loading
                // document.getElementById('loading-overlay').classList.remove('hidden');

                try {
                    // Create payload matching your backend requirement
                    const payload = {
                        month: monthName,
                        debts: this.data.settlementPlan // array of {from, to, amount}
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        this.showToast("ส่ง Flex Message เข้า LINE เรียบร้อยแล้ว");
                    } else {
                        throw new Error(result.message || "Server returned error");
                    }

                } catch (e) {
                    console.error(e);
                    alert("เกิดข้อผิดพลาดในการส่งข้อมูลผ่าน API:\n" + e.message + "\n\n(กรุณาตรวจสอบการตั้งค่า API หรือติดต่อผู้ดูแล)");
                } finally {
                    // document.getElementById('loading-overlay').classList.add('hidden');
                }
            }
        };

        window.app = app;
        window.addEventListener('DOMContentLoaded', () => {
            app.init();

            // === ONBOARDING FORM EVENT LISTENER ===
            const onboardingForm = document.getElementById('onboarding-form');
            if (onboardingForm) {
                onboardingForm.addEventListener('submit', (e) => {
                    app.completeOnboarding(e);
                });
            }
        });


        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW fail', err));
            });
        }
    </script>

    <!-- 3D Login Enhancement Script -->
    <script src="login-assets/login-3d.js"></script>
</body>


</html>