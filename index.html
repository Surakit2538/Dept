<!-- 
    Mobile-First Expense Tracker (V40 - Advanced Edit & Smart Delete)
    Project: deptmoney-6682a
    Fixes & Features:
    1. Edit Function: Added pencil icon to history. Supports icon selection.
    2. Global Installment Edit: Editing one installment updates all related installments in the group.
    3. Smart Delete: Deleting an installment offers to delete all remaining future installments in the group.
    4. Icon Support: Choose between various icons for each transaction.
-->

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Dept Money</title>
    
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png"> 
    <link rel="apple-touch-icon" href="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js & DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Noto Sans Thai -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans Thai', sans-serif;
            background-color: #f8fafc;
            color: #334155;
            -webkit-tap-highlight-color: transparent;
            height: 100dvh;
            overflow: hidden;
            position: relative;
        }
        
        .particle {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            pointer-events: none;
            animation: floatUp linear infinite;
            z-index: 0;
        }

        @keyframes floatUp {
            0% { transform: translateY(100vh) scale(0.5); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-10vh) scale(1.2); opacity: 0; }
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 220px;
        }

        @media (min-width: 768px) {
            .chart-container { height: 350px; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        .bottom-nav-item.active { color: #1e293b; }
        .bottom-nav-item.active::after {
            content: '';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background-color: #1e293b;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        .fade-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col md:flex-row">

    <div id="bg-particles" class="fixed inset-0 pointer-events-none z-0 overflow-hidden"></div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-[200] bg-black/30 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-4 rounded-full shadow-lg flex flex-col items-center justify-center gap-2">
            <i class="fa-solid fa-circle-notch fa-spin text-slate-800 text-2xl"></i>
            <span class="text-xs text-slate-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</span>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[60] bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 space-y-6">
            <div class="text-center">
                <img src="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png" alt="Logo" class="w-16 h-16 mx-auto mb-2">
                <h1 class="text-xl font-bold text-slate-800">Dept Money</h1>
            </div>
            <div class="space-y-3">
                <button onclick="window.app.completeLogin('member')" class="w-full py-3 bg-white border border-slate-200 rounded-xl font-bold text-slate-700 shadow-sm active:scale-95 transition-all">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Member)</button>
                <button onclick="window.app.showAdminLogin()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-all">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (Admin)</button>
                <a href="https://lin.ee/1FMnsom" target="_blank" class="w-full py-3 bg-[#06C755] text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-md">
                    <i class="fa-brands fa-line text-xl"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ LINE Official
                </a>
            </div>
            <div id="admin-login-form" class="hidden space-y-3 bg-slate-50 p-4 rounded-xl border border-slate-200">
                <input type="text" id="admin-user" placeholder="Username" class="w-full px-3 py-2 border rounded-lg text-sm">
                <input type="password" id="admin-pass" placeholder="Password" class="w-full px-3 py-2 border rounded-lg text-sm">
                <button onclick="window.app.loginAsAdmin()" class="w-full py-2 bg-slate-800 text-white rounded-lg text-sm font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- MOBILE TOP BAR -->
    <header class="md:hidden fixed top-0 left-0 w-full h-16 bg-white/80 backdrop-blur-md border-b px-4 flex items-center justify-between z-50">
        <div class="flex items-center gap-2">
            <img src="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png" class="w-8 h-8">
            <span class="font-bold text-slate-800">Dept Money</span>
        </div>
        <div id="mobile-role-badge" class="text-[10px] bg-slate-100 px-2 py-1 rounded-full font-bold text-slate-500">GUEST</div>
    </header>

    <!-- SIDEBAR (Desktop) -->
    <aside class="hidden md:flex w-64 bg-white border-r flex-col z-20 shadow-sm">
        <div class="p-6 border-b flex items-center gap-3">
            <img src="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png" class="w-8 h-8">
            <span class="font-bold text-lg">Dept Money</span>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <button onclick="window.app.navigate('dashboard')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium hover:bg-slate-50" id="nav-dashboard">
                <i class="fa-solid fa-chart-pie"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
            </button>
            <button onclick="window.app.navigate('history')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium hover:bg-slate-50" id="nav-history">
                <i class="fa-solid fa-list-ul"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </button>
            <button onclick="window.app.navigate('settlement')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium hover:bg-slate-50" id="nav-settlement">
                <i class="fa-solid fa-hand-holding-dollar"></i> ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡∏µ‡πâ
            </button>
            <button onclick="window.app.navigate('settings')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium hover:bg-slate-50" id="nav-settings">
                <i class="fa-solid fa-users-gear"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
            </button>
        </nav>
        <div class="p-4 border-t">
            <button onclick="location.reload()" class="w-full text-xs text-red-500 hover:underline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto pt-16 pb-20 md:pt-0 md:pb-0 h-full relative z-10" id="main-content">
        
        <!-- DASHBOARD -->
        <section id="view-dashboard" class="p-4 md:p-8 max-w-5xl mx-auto space-y-6 fade-in">
            <div class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border">
                <h2 class="font-bold text-slate-700 text-sm">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                <select onchange="window.app.setMonth(this.value)" class="global-month-selector bg-slate-50 border text-sm rounded-lg px-2 py-1 outline-none font-medium"></select>
            </div>

            <div class="bg-gradient-to-r from-slate-800 to-slate-700 rounded-2xl p-6 shadow-lg text-white">
                <p class="text-slate-300 text-xs font-medium uppercase tracking-wider">‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>
                <h3 class="text-4xl font-bold mt-1" id="total-expense">0 ‡∏ø</h3>
            </div>

            <button onclick="window.app.openModal('transaction-modal')" class="w-full bg-white border p-4 rounded-xl shadow-sm flex items-center justify-center gap-2 text-slate-700 font-bold active:scale-[0.98] transition-all">
                <i class="fa-solid fa-plus-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            </button>

            <div class="grid grid-cols-1 gap-4">
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <h3 class="font-bold text-slate-700 text-sm mb-4">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h3>
                    <div class="chart-container">
                        <canvas id="monthlyTrendChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <h3 class="font-bold text-slate-700 text-sm mb-4">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    <div class="chart-container">
                        <canvas id="payerChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- HISTORY -->
        <section id="view-history" class="hidden p-4 md:p-8 max-w-5xl mx-auto space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
                <select onchange="window.app.setMonth(this.value)" class="global-month-selector bg-white border text-sm rounded-lg px-2 py-1 outline-none font-medium"></select>
            </div>
            <div id="transaction-list-mobile" class="space-y-3"></div>
            <div id="empty-state" class="hidden py-10 text-center text-slate-400">
                <i class="fa-regular fa-folder-open text-3xl mb-2"></i>
                <p class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>
            </div>
        </section>

        <!-- SETTLEMENT -->
        <section id="view-settlement" class="hidden p-4 md:p-8 max-w-5xl mx-auto space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</h2>
                <select onchange="window.app.setMonth(this.value)" class="global-month-selector bg-white border text-sm rounded-lg px-2 py-1 outline-none font-medium"></select>
            </div>
            
            <p class="text-[10px] text-slate-400"><i class="fa-solid fa-circle-info"></i> ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            
            <div id="settlement-status-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4"></div>

            <h3 class="font-bold text-slate-700 text-sm border-b pb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <div id="settlement-plan" class="space-y-2"></div>

            <div id="settlement-admin-actions" class="hidden mt-6">
                <button onclick="window.app.sendLineNotify()" class="w-full bg-[#06C755] text-white py-3 rounded-xl font-bold flex justify-center items-center gap-2 shadow-lg">
                    <i class="fa-brands fa-line text-2xl"></i> ‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ LINE
                </button>
            </div>
        </section>

        <!-- SETTINGS -->
        <section id="view-settings" class="hidden p-4 md:p-8 max-w-5xl mx-auto space-y-6">
            <h2 class="text-xl font-bold text-slate-800">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div class="bg-white rounded-xl p-4 shadow-sm border space-y-4">
                <h3 class="font-bold text-slate-700 text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                <div class="flex gap-2">
                    <input type="text" id="new-member-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©..." class="flex-1 px-3 py-2 border rounded-lg text-sm">
                    <button onclick="window.app.addMember()" class="bg-slate-800 text-white px-4 rounded-lg text-sm font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
                <div id="member-list" class="flex flex-wrap gap-2"></div>
            </div>
            
            <button id="btn-export-csv" onclick="window.app.exportCSV()" class="hidden w-full bg-white border text-slate-700 py-3 rounded-xl font-bold text-sm shadow-sm">
                Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô CSV
            </button>

            <div id="admin-danger-zone" class="hidden bg-red-50 p-4 rounded-xl border border-red-100 space-y-3">
                <h3 class="font-bold text-red-700 text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin Only)</h3>
                <div class="flex gap-2">
                    <select id="delete-month-selector" class="flex-1 bg-white border text-sm rounded-lg px-2 outline-none"></select>
                    <button onclick="window.app.clearMonthData()" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-bold">‡∏•‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
                </div>
            </div>
        </section>

    </main>

    <!-- MOBILE NAV -->
    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur border-t h-16 grid grid-cols-4 z-40">
        <button onclick="window.app.navigate('dashboard')" class="bottom-nav-item flex flex-col items-center justify-center gap-1 text-slate-400" id="mob-nav-dashboard">
            <i class="fa-solid fa-chart-pie"></i><span class="text-[10px]">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span>
        </button>
        <button onclick="window.app.navigate('history')" class="bottom-nav-item flex flex-col items-center justify-center gap-1 text-slate-400" id="mob-nav-history">
            <i class="fa-solid fa-list"></i><span class="text-[10px]">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </button>
        <button onclick="window.app.navigate('settlement')" class="bottom-nav-item flex flex-col items-center justify-center gap-1 text-slate-400" id="mob-nav-settlement">
            <i class="fa-solid fa-money-bill-transfer"></i><span class="text-[10px]">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</span>
        </button>
        <button onclick="window.app.navigate('settings')" class="bottom-nav-item flex flex-col items-center justify-center gap-1 text-slate-400" id="mob-nav-settings">
            <i class="fa-solid fa-gear"></i><span class="text-[10px]">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
        </button>
    </nav>

    <!-- MODAL: MEMBER DETAIL -->
    <div id="member-detail-modal" class="hidden fixed inset-0 z-[80] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md max-h-[80vh] rounded-2xl flex flex-col shadow-2xl overflow-hidden">
            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                <span id="member-detail-title" class="font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
                <button onclick="window.app.closeModal('member-detail-modal')" class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center text-slate-500">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar" id="member-detail-list"></div>
            <div class="p-4 border-t bg-slate-50 flex justify-between items-center">
                <span class="text-xs text-slate-500 font-bold uppercase tracking-widest">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                <span id="member-detail-total" class="text-lg font-bold text-slate-800 underline decoration-slate-300">0 ‡∏ø</span>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD/EDIT TRANSACTION -->
    <div id="transaction-modal" class="hidden fixed inset-0 z-[70] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md max-h-[85vh] rounded-2xl flex flex-col shadow-2xl overflow-hidden">
            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                <span id="modal-title" class="font-bold text-slate-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                <button onclick="window.app.closeModal('transaction-modal')" class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center text-slate-500">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="t-date" class="w-full border rounded-lg p-2 text-sm outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</label>
                        <select id="t-payment-type" onchange="window.app.toggleInstallment()" class="w-full border rounded-lg p-2 text-sm outline-none">
                            <option value="normal">‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°</option>
                            <option value="installment">‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</option>
                        </select>
                    </div>
                </div>
                <div id="t-installment-wrapper" class="hidden bg-orange-50 p-3 rounded-lg border border-orange-100">
                    <label class="text-[10px] font-bold text-orange-400 uppercase">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î</label>
                    <input type="number" id="t-installments" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3" class="w-full border rounded p-2 text-sm">
                </div>
                
                <!-- ICON SELECTION -->
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                    <div class="flex gap-2 mt-1 overflow-x-auto pb-2 custom-scrollbar" id="icon-picker">
                        <button type="button" onclick="window.app.selectIcon('fa-utensils')" class="icon-opt p-2 border rounded-lg bg-white" data-icon="fa-utensils">üç¥</button>
                        <button type="button" onclick="window.app.selectIcon('fa-shopping-cart')" class="icon-opt p-2 border rounded-lg bg-white" data-icon="fa-shopping-cart">üõí</button>
                        <button type="button" onclick="window.app.selectIcon('fa-car')" class="icon-opt p-2 border rounded-lg bg-white" data-icon="fa-car">üöó</button>
                        <button type="button" onclick="window.app.selectIcon('fa-bolt')" class="icon-opt p-2 border rounded-lg bg-white" data-icon="fa-bolt">‚ö°</button>
                        <button type="button" onclick="window.app.selectIcon('fa-gift')" class="icon-opt p-2 border rounded-lg bg-white" data-icon="fa-gift">üéÅ</button>
                        <button type="button" onclick="window.app.selectIcon('fa-house')" class="icon-opt p-2 border rounded-lg bg-white" data-icon="fa-house">üè†</button>
                        <button type="button" onclick="window.app.selectIcon('fa-coffee')" class="icon-opt p-2 border rounded-lg bg-white" data-icon="fa-coffee">‚òï</button>
                        <button type="button" onclick="window.app.selectIcon('fa-gamepad')" class="icon-opt p-2 border rounded-lg bg-white" data-icon="fa-gamepad">üéÆ</button>
                    </div>
                    <input type="hidden" id="t-icon" value="fa-utensils">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                    <input type="text" id="t-desc" placeholder="‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á, ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü..." class="w-full border rounded-lg p-2 text-sm outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</label>
                    <input type="number" id="t-amount" placeholder="0.00" class="w-full border rounded-lg p-3 text-xl font-bold bg-slate-50">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢</label>
                    <select id="t-payer" class="w-full border rounded-lg p-2 text-sm bg-white"></select>
                </div>
                <div class="bg-slate-50 p-3 rounded-xl border">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</span>
                        <div class="flex bg-white rounded-lg p-0.5 border">
                            <button onclick="window.app.setSplitMode('equal')" id="btn-split-equal" class="px-3 py-1 rounded-md text-[10px] font-bold bg-slate-800 text-white">‡∏´‡∏≤‡∏£‡πÄ‡∏ó‡πà‡∏≤</button>
                            <button onclick="window.app.setSplitMode('custom')" id="btn-split-custom" class="px-3 py-1 rounded-md text-[10px] font-bold text-slate-400">‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î</button>
                        </div>
                    </div>
                    <div id="split-participants" class="space-y-2 max-h-32 overflow-y-auto pr-1 custom-scrollbar"></div>
                </div>
            </div>
            <div class="p-4 border-t">
                <button id="btn-save-transaction" onclick="window.app.saveTransaction()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        Chart.register(ChartDataLabels);

        const firebaseConfig = {
            apiKey: "AIzaSyDD_3oEFAFgZyUdW2n6S36P_Ln47DIeNpc",
            authDomain: "deptmoney-6682a.firebaseapp.com",
            projectId: "deptmoney-6682a",
            storageBucket: "deptmoney-6682a.firebasestorage.app",
            messagingSenderId: "6714403201",
            appId: "1:6714403201:web:a98a2cefcebef5c63b6080"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDocs, updateDoc, deleteDoc, writeBatch, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const fApp = initializeApp(firebaseConfig);
        const db = getFirestore(fApp);

        const app = {
            data: {
                userRole: 'guest',
                members: [],
                transactions: [],
                splitMode: 'equal',
                currentView: 'dashboard',
                currentMonth: new Date().toISOString().slice(0, 7),
                editingId: null,
                selectedGroupId: null
            },
            charts: { monthlyTrend: null, payer: null },

            async init() {
                this.initBackground();
                this.populateMonthSelectors();
                this.selectIcon('fa-utensils');
                
                onSnapshot(collection(db, "members"), (snap) => {
                    this.data.members = snap.docs.map(d => d.data().name.toUpperCase()).sort();
                    this.renderMemberList();
                    this.populatePayerSelector();
                });

                onSnapshot(collection(db, "transactions"), (snap) => {
                    this.data.transactions = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                    this.refreshCurrentView();
                    document.getElementById('loading-overlay').classList.add('hidden');
                });
            },

            initBackground() {
                const container = document.getElementById('bg-particles');
                for(let i=0; i<15; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    p.style.width = p.style.height = (Math.random()*20 + 5) + 'px';
                    p.style.left = Math.random()*100 + 'vw';
                    p.style.animationDuration = (Math.random()*10 + 10) + 's';
                    p.style.animationDelay = Math.random()*5 + 's';
                    container.appendChild(p);
                }
            },

            navigate(viewId) {
                this.data.currentView = viewId;
                document.querySelectorAll('section[id^="view-"]').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-slate-100', 'text-slate-900'));
                const nav = document.getElementById(`nav-${viewId}`);
                if(nav) nav.classList.add('bg-slate-100', 'text-slate-900');
                document.querySelectorAll('.bottom-nav-item').forEach(b => b.classList.remove('active'));
                const mobNav = document.getElementById(`mob-nav-${viewId}`);
                if(mobNav) mobNav.classList.add('active');
                this.refreshCurrentView();
            },

            refreshCurrentView() {
                if (this.data.currentView === 'dashboard') this.renderDashboard();
                if (this.data.currentView === 'history') this.renderHistory();
                if (this.data.currentView === 'settlement') this.calculateSettlement();
            },

            showAdminLogin() { document.getElementById('admin-login-form').classList.toggle('hidden'); },
            loginAsAdmin() {
                const u = document.getElementById('admin-user').value;
                const p = document.getElementById('admin-pass').value;
                if(u.toLowerCase() === 'admin' && p === '0000') this.completeLogin('admin');
                else alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            },
            completeLogin(role) {
                this.data.userRole = role;
                document.getElementById('login-screen').classList.add('hidden');
                const badge = document.getElementById('mobile-role-badge');
                badge.textContent = role.toUpperCase();
                if(role === 'admin') {
                    badge.className = "text-[10px] bg-slate-800 px-2 py-1 rounded-full font-bold text-white";
                    document.getElementById('admin-danger-zone').classList.remove('hidden');
                    document.getElementById('settlement-admin-actions').classList.remove('hidden');
                    document.getElementById('btn-export-csv').classList.remove('hidden');
                }
                this.navigate('dashboard');
            },

            populateMonthSelectors() {
                const date = new Date();
                let html = "";
                for(let i=0; i<12; i++) {
                    const val = date.toISOString().slice(0, 7);
                    const label = date.toLocaleString('th-TH', { month: 'long', year: 'numeric' });
                    html += `<option value="${val}">${label}</option>`;
                    date.setMonth(date.getMonth() - 1);
                }
                document.querySelectorAll('.global-month-selector, #delete-month-selector').forEach(s => s.innerHTML = html);
            },

            setMonth(val) {
                this.data.currentMonth = val;
                document.querySelectorAll('.global-month-selector').forEach(s => s.value = val);
                this.refreshCurrentView();
            },

            populatePayerSelector() {
                const sel = document.getElementById('t-payer');
                sel.innerHTML = this.data.members.map(m => `<option value="${m}">${m}</option>`).join('');
            },

            renderMemberList() {
                const container = document.getElementById('member-list');
                container.innerHTML = this.data.members.map(m => `<span class="px-3 py-1 bg-slate-100 border rounded-full text-xs font-bold text-slate-600">${m}</span>`).join('');
            },

            async addMember() {
                const input = document.getElementById('new-member-name');
                const name = input.value.trim().toUpperCase();
                if(!name || this.data.members.includes(name)) return;
                await addDoc(collection(db, "members"), { name });
                input.value = "";
            },

            calculateSettlement() {
                const filtered = this.data.transactions.filter(t => t.date.startsWith(this.data.currentMonth));
                const balances = {};
                this.data.members.forEach(m => balances[m] = 0);
                filtered.forEach(t => {
                    const payer = (t.payer || "").toUpperCase();
                    if(balances.hasOwnProperty(payer)) balances[payer] += Number(t.amount);
                    if(t.splits) {
                        Object.keys(t.splits).forEach(k => {
                            const memberKey = k.toUpperCase();
                            if(balances.hasOwnProperty(memberKey)) balances[memberKey] -= Number(t.splits[k]);
                        });
                    }
                });
                const grid = document.getElementById('settlement-status-grid');
                grid.innerHTML = "";
                this.data.members.forEach(m => {
                    const bal = Math.round(balances[m]);
                    let color = "bg-slate-50 text-slate-400";
                    let icon = "fa-circle-check", status = "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß";
                    if(bal > 1) { color = "bg-emerald-50 text-emerald-700 border-emerald-100"; icon = "fa-hand-holding-dollar"; status = "‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô"; }
                    else if(bal < -1) { color = "bg-red-50 text-red-700 border-red-100"; icon = "fa-money-bill-wave"; status = "‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏ô"; }
                    const card = document.createElement('div');
                    card.className = `p-4 rounded-2xl border flex flex-col items-center text-center cursor-pointer transition-all active:scale-95 ${color}`;
                    card.onclick = () => this.showMemberDetails(m);
                    card.innerHTML = `<i class="fa-solid ${icon} mb-1 opacity-70"></i><span class="text-xs font-bold">${m}</span><span class="text-[9px] uppercase tracking-tighter opacity-60 mb-1">${status}</span><span class="text-base font-bold">${bal === 0 ? '-' : Math.abs(bal).toLocaleString() + ' ‡∏ø'}</span>`;
                    grid.appendChild(card);
                });
                const debtors = [], creditors = [];
                this.data.members.forEach(m => {
                    const b = Math.round(balances[m]);
                    if(b < -1) debtors.push({ name: m, amount: Math.abs(b) });
                    if(b > 1) creditors.push({ name: m, amount: b });
                });
                const plan = document.getElementById('settlement-plan');
                plan.innerHTML = "";
                let i=0, j=0;
                while(i < debtors.length && j < creditors.length) {
                    const d = debtors[i], c = creditors[j], pay = Math.min(d.amount, c.amount);
                    plan.innerHTML += `<div class="flex items-center justify-between bg-white p-3 rounded-xl border text-sm"><div class="font-bold text-slate-700">${d.name} <i class="fa-solid fa-arrow-right text-[10px] mx-1 text-slate-300"></i> ${c.name}</div><div class="font-bold text-red-500">${pay.toLocaleString()} ‡∏ø</div></div>`;
                    d.amount -= pay; c.amount -= pay;
                    if(d.amount <= 1) i++;
                    if(c.amount <= 1) j++;
                }
                if(!plan.innerHTML) plan.innerHTML = `<div class="text-center py-4 text-slate-300 text-xs italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>`;
            },

            showMemberDetails(member) {
                const target = member.toUpperCase();
                const filtered = this.data.transactions.filter(t => t.date.startsWith(this.data.currentMonth))
                                 .filter(t => (t.payer || "").toUpperCase() === target || Object.keys(t.splits || {}).some(k => k.toUpperCase() === target));
                const list = document.getElementById('member-detail-list');
                list.innerHTML = ""; let totalSpent = 0;
                filtered.forEach(t => {
                    let myShare = 0;
                    const matchKey = Object.keys(t.splits || {}).find(k => k.toUpperCase() === target);
                    if(matchKey) myShare = Number(t.splits[matchKey]);
                    totalSpent += myShare;
                    const isPayer = (t.payer || "").toUpperCase() === target;
                    list.innerHTML += `<div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex justify-between items-center"><div class="flex flex-col"><span class="text-[10px] font-bold text-slate-400 uppercase">${new Date(t.date).toLocaleDateString('th-TH',{day:'numeric',month:'short'})}</span><span class="text-xs font-bold text-slate-700">${t.desc}</span><span class="text-[9px] text-slate-400">${isPayer ? '‡∏Ñ‡∏∏‡∏ì‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô' : '‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢ ' + t.payer} ‚Ä¢ ‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏° ${t.amount}</span></div><div class="text-right"><div class="text-sm font-bold text-slate-800">-${myShare.toLocaleString()}</div><div class="text-[8px] font-bold text-slate-400 uppercase tracking-tighter">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div></div></div>`;
                });
                document.getElementById('member-detail-title').textContent = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á ${target}`;
                document.getElementById('member-detail-total').textContent = `${totalSpent.toLocaleString()} ‡∏ø`;
                document.getElementById('member-detail-modal').classList.remove('hidden');
            },

            renderDashboard() {
                const filtered = this.data.transactions.filter(t => t.date.startsWith(this.data.currentMonth));
                const total = filtered.reduce((acc, t) => acc + Number(t.amount), 0);
                document.getElementById('total-expense').textContent = total.toLocaleString() + ' ‡∏ø';
                this.renderMonthlyTrendChart();
                const payers = {};
                filtered.forEach(t => { const p = (t.payer || "N/A").toUpperCase(); payers[p] = (payers[p] || 0) + Number(t.amount); });
                this.renderPayerChart(payers);
            },

            renderMonthlyTrendChart() {
                const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
                if(this.charts.monthlyTrend) this.charts.monthlyTrend.destroy();
                const months = [], amounts = [], d = new Date();
                for(let i=0; i<12; i++) {
                    const key = d.toISOString().slice(0, 7);
                    months.unshift(d.toLocaleString('th-TH', {month:'short'}));
                    amounts.unshift(this.data.transactions.filter(t => t.date.startsWith(key)).reduce((a, t) => a + Number(t.amount), 0));
                    d.setMonth(d.getMonth() - 1);
                }
                this.charts.monthlyTrend = new Chart(ctx, { type: 'bar', data: { labels: months, datasets: [{ data: amounts, backgroundColor: months.map((_,i) => i === 11 ? '#1e293b' : '#cbd5e1'), borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 9 } } } } } });
            },

            renderPayerChart(data) {
                const ctx = document.getElementById('payerChart').getContext('2d');
                if(this.charts.payer) this.charts.payer.destroy();
                this.charts.payer = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }, datalabels: { color: '#fff', font: { weight: 'bold', size: 10 }, formatter: (v) => v > 0 ? v.toLocaleString() : "" } } } });
            },

            // --- UPDATED CRUD ---
            openModal(id) { 
                this.data.editingId = null;
                this.data.selectedGroupId = null;
                document.getElementById('modal-title').textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
                document.getElementById('t-amount').value = "";
                document.getElementById('t-desc').value = "";
                this.selectIcon('fa-utensils');
                document.getElementById(id).classList.remove('hidden'); 
                this.renderSplitParticipants(); 
            },

            closeModal(id) { document.getElementById(id).classList.add('hidden'); },
            
            toggleInstallment() { document.getElementById('t-installment-wrapper').classList.toggle('hidden', document.getElementById('t-payment-type').value !== 'installment'); },
            
            selectIcon(iconName) {
                document.getElementById('t-icon').value = iconName;
                document.querySelectorAll('.icon-opt').forEach(btn => {
                    btn.classList.toggle('border-slate-800', btn.dataset.icon === iconName);
                    btn.classList.toggle('bg-slate-100', btn.dataset.icon === iconName);
                });
            },

            setSplitMode(m) {
                this.data.splitMode = m;
                this.renderSplitParticipants();
            },

            renderSplitParticipants() {
                const container = document.getElementById('split-participants');
                container.innerHTML = this.data.members.map(m => `
                    <div class="flex items-center justify-between text-xs py-1 border-b border-white/50 last:border-0">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" checked value="${m}" class="participant-check rounded text-slate-800 w-4 h-4">
                            <span class="text-slate-700 font-medium">${m}</span>
                        </label>
                        ${this.data.splitMode === 'custom' ? `<input type="number" step="0.01" data-member="${m}" class="participant-amount w-16 p-1 border rounded text-right text-[10px]">` : ''}
                    </div>
                `).join('');
            },

            editTransaction(id) {
                const t = this.data.transactions.find(x => x.id === id);
                if(!t) return;
                this.data.editingId = id;
                this.data.selectedGroupId = t.groupId || null;
                
                document.getElementById('modal-title').textContent = t.groupId ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°)" : "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
                document.getElementById('t-date').value = t.date;
                document.getElementById('t-payment-type').value = t.paymentType || 'normal';
                document.getElementById('t-desc').value = t.desc.split(' (')[0]; // Remove installment no if any
                document.getElementById('t-amount').value = t.amount;
                document.getElementById('t-payer').value = t.payer;
                this.selectIcon(t.icon || 'fa-utensils');
                this.toggleInstallment();
                
                document.getElementById('transaction-modal').classList.remove('hidden');
                // Re-render splits (simplified: default to equal for edit, or customize further)
                this.renderSplitParticipants();
            },

            async saveTransaction() {
                document.getElementById('loading-overlay').classList.remove('hidden');
                const amount = Number(document.getElementById('t-amount').value);
                const desc = document.getElementById('t-desc').value || "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
                const payer = document.getElementById('t-payer').value;
                const type = document.getElementById('t-payment-type').value;
                const date = document.getElementById('t-date').value;
                const icon = document.getElementById('t-icon').value;
                if(!amount || !date) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');

                const splits = {};
                const checked = Array.from(document.querySelectorAll('.participant-check:checked')).map(c => c.value);
                if(this.data.splitMode === 'equal') {
                    const share = amount / checked.length;
                    checked.forEach(m => splits[m] = share);
                } else {
                    document.querySelectorAll('.participant-amount').forEach(i => {
                        const val = Number(i.value);
                        if(val > 0) splits[i.dataset.member] = val;
                    });
                }

                const batch = writeBatch(db);

                // EDITING LOGIC
                if(this.data.editingId) {
                    if(this.data.selectedGroupId) {
                        // Find all in group
                        const groupQuery = query(collection(db, "transactions"), where("groupId", "==", this.data.selectedGroupId));
                        const groupSnap = await getDocs(groupQuery);
                        groupSnap.forEach(snap => {
                            batch.update(snap.ref, { desc, payer, icon, splits }); // Note: Keep dates and amounts specific to installments
                        });
                    } else {
                        batch.update(doc(db, "transactions", this.data.editingId), { desc, payer, amount, splits, date, icon });
                    }
                } else {
                    // ADDING LOGIC
                    const installments = type === 'installment' ? Number(document.getElementById('t-installments').value) || 1 : 1;
                    const groupId = type === 'installment' ? "grp_" + Date.now() : null;
                    const baseDate = new Date(date);

                    for(let i=0; i<installments; i++) {
                        const currentInstallmentDate = new Date(baseDate);
                        currentInstallmentDate.setMonth(baseDate.getMonth() + i);
                        const txn = {
                            date: currentInstallmentDate.toISOString().slice(0, 10),
                            desc: installments > 1 ? `${desc} (${i+1}/${installments})` : desc,
                            amount: amount / installments,
                            payer,
                            splits: Object.fromEntries(Object.entries(splits).map(([k,v]) => [k, v/installments])),
                            paymentType: type,
                            icon,
                            groupId,
                            timestamp: Date.now() + i
                        };
                        batch.set(doc(collection(db, "transactions")), txn);
                    }
                }

                await batch.commit();
                this.closeModal('transaction-modal');
                document.getElementById('loading-overlay').classList.add('hidden');
            },

            async deleteTransaction(id) {
                if(this.data.userRole !== 'admin') return;
                const t = this.data.transactions.find(x => x.id === id);
                if(!t) return;

                if(t.groupId) {
                    const choice = confirm('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞\n‡∏ï‡∏Å‡∏•‡∏á: ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ\n‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å: ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                    if(choice) {
                        const cascade = confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
                        document.getElementById('loading-overlay').classList.remove('hidden');
                        const batch = writeBatch(db);
                        if(cascade) {
                            const q = query(collection(db, "transactions"), where("groupId", "==", t.groupId));
                            const snap = await getDocs(q);
                            snap.forEach(d => {
                                if(d.data().date >= t.date) batch.delete(d.ref);
                            });
                        } else {
                            batch.delete(doc(db, "transactions", id));
                        }
                        await batch.commit();
                        document.getElementById('loading-overlay').classList.add('hidden');
                    }
                } else {
                    if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) await deleteDoc(doc(db, "transactions", id));
                }
            },

            renderHistory() {
                const filtered = this.data.transactions.filter(t => t.date.startsWith(this.data.currentMonth)).sort((a,b) => b.date.localeCompare(a.date));
                const container = document.getElementById('transaction-list-mobile');
                const empty = document.getElementById('empty-state');
                container.innerHTML = "";
                if(filtered.length === 0) return empty.classList.remove('hidden');
                empty.classList.add('hidden');

                filtered.forEach(t => {
                    const isAdmin = this.data.userRole === 'admin';
                    const iconClass = t.icon || 'fa-utensils';
                    container.innerHTML += `
                        <div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 border">
                                    <i class="fa-solid ${iconClass}"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-700 text-sm">${t.desc}</p>
                                    <p class="text-[10px] text-slate-400 uppercase font-bold">${t.payer} ‚Ä¢ ${new Date(t.date).toLocaleDateString('th-TH')}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-slate-800">${Number(t.amount).toLocaleString()}</span>
                                <div class="flex gap-1">
                                    ${isAdmin ? `<button onclick="window.app.editTransaction('${t.id}')" class="text-blue-300 hover:text-blue-500 p-1"><i class="fa-solid fa-pen"></i></button>` : ''}
                                    ${isAdmin ? `<button onclick="window.app.deleteTransaction('${t.id}')" class="text-red-300 hover:text-red-500 p-1"><i class="fa-solid fa-trash-can"></i></button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
            },

            async clearMonthData() {
                if(this.data.userRole !== 'admin') return;
                const m = document.getElementById('delete-month-selector').value;
                if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${m}?`)) {
                    const toDelete = this.data.transactions.filter(t => t.date.startsWith(m));
                    const batch = writeBatch(db);
                    toDelete.forEach(t => batch.delete(doc(db, "transactions", t.id)));
                    await batch.commit();
                }
            }
        };

        window.app = app;
        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
