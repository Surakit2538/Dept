<!-- 
    Mobile-First Expense Tracker (V39 - Robust Case-Insensitive Matching)
    Project: deptmoney-6682a
    Fixes:
    1. Member Details: Fixed issue where data from LINE (uppercase) wouldn't show up due to case sensitivity.
    2. Data Mapping: Normalizes names to Uppercase during filtering and calculation.
    3. UI Sync: Ensures settlement cards and details modal work seamlessly with LINE data.
-->

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Dept Money</title>
    
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png"> 
    <link rel="apple-touch-icon" href="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js & DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Noto Sans Thai -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans Thai', sans-serif;
            background-color: #f8fafc;
            color: #334155;
            -webkit-tap-highlight-color: transparent;
            height: 100dvh;
            overflow: hidden;
            position: relative;
        }
        
        .particle {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            pointer-events: none;
            animation: floatUp linear infinite;
            z-index: 0;
        }

        @keyframes floatUp {
            0% { transform: translateY(100vh) scale(0.5); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-10vh) scale(1.2); opacity: 0; }
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 220px;
        }

        @media (min-width: 768px) {
            .chart-container { height: 350px; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        .bottom-nav-item.active { color: #1e293b; }
        .bottom-nav-item.active::after {
            content: '';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background-color: #1e293b;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        .fade-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col md:flex-row">

    <div id="bg-particles" class="fixed inset-0 pointer-events-none z-0 overflow-hidden"></div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-[200] bg-black/30 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-4 rounded-full shadow-lg flex flex-col items-center justify-center gap-2">
            <i class="fa-solid fa-circle-notch fa-spin text-slate-800 text-2xl"></i>
            <span class="text-xs text-slate-600 font-medium">กำลังดำเนินการ...</span>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[60] bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 space-y-6">
            <div class="text-center">
                <img src="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png" alt="Logo" class="w-16 h-16 mx-auto mb-2">
                <h1 class="text-xl font-bold text-slate-800">Dept Money</h1>
            </div>
            <div class="space-y-3">
                <button onclick="window.app.completeLogin('member')" class="w-full py-3 bg-white border border-slate-200 rounded-xl font-bold text-slate-700 shadow-sm active:scale-95 transition-all">เข้าสู่ระบบ (Member)</button>
                <button onclick="window.app.showAdminLogin()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-all">ผู้ดูแล (Admin)</button>
                <a href="https://lin.ee/1FMnsom" target="_blank" class="w-full py-3 bg-[#06C755] text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-md">
                    <i class="fa-brands fa-line text-xl"></i> ติดต่อ LINE Official
                </a>
            </div>
            <div id="admin-login-form" class="hidden space-y-3 bg-slate-50 p-4 rounded-xl border border-slate-200">
                <input type="text" id="admin-user" placeholder="Username" class="w-full px-3 py-2 border rounded-lg text-sm">
                <input type="password" id="admin-pass" placeholder="Password" class="w-full px-3 py-2 border rounded-lg text-sm">
                <button onclick="window.app.loginAsAdmin()" class="w-full py-2 bg-slate-800 text-white rounded-lg text-sm font-bold">ยืนยัน</button>
            </div>
        </div>
    </div>

    <!-- MOBILE TOP BAR -->
    <header class="md:hidden fixed top-0 left-0 w-full h-16 bg-white/80 backdrop-blur-md border-b px-4 flex items-center justify-between z-50">
        <div class="flex items-center gap-2">
            <img src="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png" class="w-8 h-8">
            <span class="font-bold text-slate-800">Dept Money</span>
        </div>
        <div id="mobile-role-badge" class="text-[10px] bg-slate-100 px-2 py-1 rounded-full font-bold text-slate-500">GUEST</div>
    </header>

    <!-- SIDEBAR (Desktop) -->
    <aside class="hidden md:flex w-64 bg-white border-r flex-col z-20 shadow-sm">
        <div class="p-6 border-b flex items-center gap-3">
            <img src="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768919170/icon_jsaxxj.png" class="w-8 h-8">
            <span class="font-bold text-lg">Dept Money</span>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <button onclick="window.app.navigate('dashboard')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium hover:bg-slate-50" id="nav-dashboard">
                <i class="fa-solid fa-chart-pie"></i> ภาพรวม
            </button>
            <button onclick="window.app.navigate('history')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium hover:bg-slate-50" id="nav-history">
                <i class="fa-solid fa-list-ul"></i> รายการ
            </button>
            <button onclick="window.app.navigate('settlement')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium hover:bg-slate-50" id="nav-settlement">
                <i class="fa-solid fa-hand-holding-dollar"></i> เคลียร์หนี้
            </button>
            <button onclick="window.app.navigate('settings')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium hover:bg-slate-50" id="nav-settings">
                <i class="fa-solid fa-users-gear"></i> จัดการ
            </button>
        </nav>
        <div class="p-4 border-t">
            <button onclick="location.reload()" class="w-full text-xs text-red-500 hover:underline">ออกจากระบบ</button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto pt-16 pb-20 md:pt-0 md:pb-0 h-full relative z-10" id="main-content">
        
        <!-- DASHBOARD -->
        <section id="view-dashboard" class="p-4 md:p-8 max-w-5xl mx-auto space-y-6 fade-in">
            <div class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border">
                <h2 class="font-bold text-slate-700 text-sm">ตัวเลือกเดือน</h2>
                <select onchange="window.app.setMonth(this.value)" class="global-month-selector bg-slate-50 border text-sm rounded-lg px-2 py-1 outline-none font-medium"></select>
            </div>

            <div class="bg-gradient-to-r from-slate-800 to-slate-700 rounded-2xl p-6 shadow-lg text-white">
                <p class="text-slate-300 text-xs font-medium uppercase tracking-wider">ยอดใช้จ่ายรวมเดือนนี้</p>
                <h3 class="text-4xl font-bold mt-1" id="total-expense">0 ฿</h3>
            </div>

            <button onclick="window.app.openModal('transaction-modal')" class="w-full bg-white border p-4 rounded-xl shadow-sm flex items-center justify-center gap-2 text-slate-700 font-bold active:scale-[0.98] transition-all">
                <i class="fa-solid fa-plus-circle"></i> บันทึกรายการใหม่
            </button>

            <div class="grid grid-cols-1 gap-4">
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <h3 class="font-bold text-slate-700 text-sm mb-4">แนวโน้มการใช้จ่าย (12 เดือน)</h3>
                    <div class="chart-container">
                        <canvas id="monthlyTrendChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <h3 class="font-bold text-slate-700 text-sm mb-4">สัดส่วนคนจ่ายเงิน</h3>
                    <div class="chart-container">
                        <canvas id="payerChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- HISTORY -->
        <section id="view-history" class="hidden p-4 md:p-8 max-w-5xl mx-auto space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800">ประวัติรายการ</h2>
                <select onchange="window.app.setMonth(this.value)" class="global-month-selector bg-white border text-sm rounded-lg px-2 py-1 outline-none font-medium"></select>
            </div>
            <div id="transaction-list-mobile" class="space-y-3"></div>
            <div id="empty-state" class="hidden py-10 text-center text-slate-400">
                <i class="fa-regular fa-folder-open text-3xl mb-2"></i>
                <p class="text-sm">ไม่มีรายการในเดือนนี้</p>
            </div>
        </section>

        <!-- SETTLEMENT -->
        <section id="view-settlement" class="hidden p-4 md:p-8 max-w-5xl mx-auto space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800">เคลียร์ยอดเงิน</h2>
                <select onchange="window.app.setMonth(this.value)" class="global-month-selector bg-white border text-sm rounded-lg px-2 py-1 outline-none font-medium"></select>
            </div>
            
            <p class="text-[10px] text-slate-400"><i class="fa-solid fa-circle-info"></i> แตะที่ชื่อสมาชิกเพื่อดูรายละเอียดรายการ</p>
            
            <div id="settlement-status-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4"></div>

            <h3 class="font-bold text-slate-700 text-sm border-b pb-2">สรุปการโอนเงิน</h3>
            <div id="settlement-plan" class="space-y-2"></div>

            <div id="settlement-admin-actions" class="hidden mt-6">
                <button onclick="window.app.sendLineNotify()" class="w-full bg-[#06C755] text-white py-3 rounded-xl font-bold flex justify-center items-center gap-2 shadow-lg">
                    <i class="fa-brands fa-line text-2xl"></i> ส่งสรุปยอดเข้า LINE
                </button>
            </div>
        </section>

        <!-- SETTINGS -->
        <section id="view-settings" class="hidden p-4 md:p-8 max-w-5xl mx-auto space-y-6">
            <h2 class="text-xl font-bold text-slate-800">ตั้งค่าระบบ</h2>
            <div class="bg-white rounded-xl p-4 shadow-sm border space-y-4">
                <h3 class="font-bold text-slate-700 text-sm">จัดการรายชื่อสมาชิก</h3>
                <div class="flex gap-2">
                    <input type="text" id="new-member-name" placeholder="ชื่อภาษาอังกฤษ..." class="flex-1 px-3 py-2 border rounded-lg text-sm">
                    <button onclick="window.app.addMember()" class="bg-slate-800 text-white px-4 rounded-lg text-sm font-bold">เพิ่ม</button>
                </div>
                <div id="member-list" class="flex flex-wrap gap-2"></div>
            </div>
            
            <button id="btn-export-csv" onclick="window.app.exportCSV()" class="hidden w-full bg-white border text-slate-700 py-3 rounded-xl font-bold text-sm shadow-sm">
                Export ข้อมูลเป็น CSV
            </button>

            <div id="admin-danger-zone" class="hidden bg-red-50 p-4 rounded-xl border border-red-100 space-y-3">
                <h3 class="font-bold text-red-700 text-sm">จัดการข้อมูล (Admin Only)</h3>
                <div class="flex gap-2">
                    <select id="delete-month-selector" class="flex-1 bg-white border text-sm rounded-lg px-2 outline-none"></select>
                    <button onclick="window.app.clearMonthData()" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-bold">ลบเดือนนี้</button>
                </div>
            </div>
        </section>

    </main>

    <!-- MOBILE NAV -->
    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur border-t h-16 grid grid-cols-4 z-40">
        <button onclick="window.app.navigate('dashboard')" class="bottom-nav-item flex flex-col items-center justify-center gap-1 text-slate-400" id="mob-nav-dashboard">
            <i class="fa-solid fa-chart-pie"></i><span class="text-[10px]">ภาพรวม</span>
        </button>
        <button onclick="window.app.navigate('history')" class="bottom-nav-item flex flex-col items-center justify-center gap-1 text-slate-400" id="mob-nav-history">
            <i class="fa-solid fa-list"></i><span class="text-[10px]">รายการ</span>
        </button>
        <button onclick="window.app.navigate('settlement')" class="bottom-nav-item flex flex-col items-center justify-center gap-1 text-slate-400" id="mob-nav-settlement">
            <i class="fa-solid fa-money-bill-transfer"></i><span class="text-[10px]">เคลียร์</span>
        </button>
        <button onclick="window.app.navigate('settings')" class="bottom-nav-item flex flex-col items-center justify-center gap-1 text-slate-400" id="mob-nav-settings">
            <i class="fa-solid fa-gear"></i><span class="text-[10px]">ตั้งค่า</span>
        </button>
    </nav>

    <!-- MODAL: MEMBER DETAIL (CRITICAL FIX) -->
    <div id="member-detail-modal" class="hidden fixed inset-0 z-[80] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md max-h-[80vh] rounded-2xl flex flex-col shadow-2xl overflow-hidden">
            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                <span id="member-detail-title" class="font-bold text-slate-800">รายละเอียด</span>
                <button onclick="window.app.closeModal('member-detail-modal')" class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center text-slate-500">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar" id="member-detail-list"></div>
            <div class="p-4 border-t bg-slate-50 flex justify-between items-center">
                <span class="text-xs text-slate-500 font-bold uppercase tracking-widest">ยอดรวมทั้งหมด</span>
                <span id="member-detail-total" class="text-lg font-bold text-slate-800 underline decoration-slate-300">0 ฿</span>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD TRANSACTION -->
    <div id="transaction-modal" class="hidden fixed inset-0 z-[70] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md max-h-[85vh] rounded-2xl flex flex-col shadow-2xl overflow-hidden">
            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                <span id="modal-title" class="font-bold text-slate-800">บันทึกรายการ</span>
                <button onclick="window.app.closeModal('transaction-modal')" class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center text-slate-500">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">วันที่</label>
                        <input type="date" id="t-date" class="w-full border rounded-lg p-2 text-sm outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">รูปแบบ</label>
                        <select id="t-payment-type" onchange="window.app.toggleInstallment()" class="w-full border rounded-lg p-2 text-sm outline-none">
                            <option value="normal">จ่ายเต็ม</option>
                            <option value="installment">ผ่อนชำระ</option>
                        </select>
                    </div>
                </div>
                <div id="t-installment-wrapper" class="hidden bg-orange-50 p-3 rounded-lg border border-orange-100">
                    <label class="text-[10px] font-bold text-orange-400 uppercase">จำนวนงวด</label>
                    <input type="number" id="t-installments" placeholder="เช่น 3" class="w-full border rounded p-2 text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">รายการ</label>
                    <input type="text" id="t-desc" placeholder="มื้อเที่ยง, ค่าไฟ..." class="w-full border rounded-lg p-2 text-sm outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">ยอดเงินรวม</label>
                    <input type="number" id="t-amount" placeholder="0.00" class="w-full border rounded-lg p-3 text-xl font-bold bg-slate-50">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">คนจ่าย</label>
                    <select id="t-payer" class="w-full border rounded-lg p-2 text-sm bg-white"></select>
                </div>
                <div class="bg-slate-50 p-3 rounded-xl border">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">การหารเงิน</span>
                        <div class="flex bg-white rounded-lg p-0.5 border">
                            <button onclick="window.app.setSplitMode('equal')" id="btn-split-equal" class="px-3 py-1 rounded-md text-[10px] font-bold bg-slate-800 text-white">หารเท่า</button>
                            <button onclick="window.app.setSplitMode('custom')" id="btn-split-custom" class="px-3 py-1 rounded-md text-[10px] font-bold text-slate-400">ระบุยอด</button>
                        </div>
                    </div>
                    <div id="split-participants" class="space-y-2 max-h-32 overflow-y-auto pr-1 custom-scrollbar"></div>
                </div>
            </div>
            <div class="p-4 border-t">
                <button id="btn-save-transaction" onclick="window.app.saveTransaction()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        Chart.register(ChartDataLabels);

        const firebaseConfig = {
            apiKey: "AIzaSyDD_3oEFAFgZyUdW2n6S36P_Ln47DIeNpc",
            authDomain: "deptmoney-6682a.firebaseapp.com",
            projectId: "deptmoney-6682a",
            storageBucket: "deptmoney-6682a.firebasestorage.app",
            messagingSenderId: "6714403201",
            appId: "1:6714403201:web:a98a2cefcebef5c63b6080"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, writeBatch, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const fApp = initializeApp(firebaseConfig);
        const db = getFirestore(fApp);

        const app = {
            data: {
                userRole: 'guest',
                members: [],
                transactions: [],
                splitMode: 'equal',
                currentView: 'dashboard',
                currentMonth: new Date().toISOString().slice(0, 7),
                editingId: null
            },
            charts: { monthlyTrend: null, payer: null },

            async init() {
                this.initBackground();
                this.populateMonthSelectors();
                
                // Realtime Listeners
                onSnapshot(collection(db, "members"), (snap) => {
                    this.data.members = snap.docs.map(d => d.data().name.toUpperCase()).sort();
                    this.renderMemberList();
                    this.populatePayerSelector();
                });

                onSnapshot(collection(db, "transactions"), (snap) => {
                    this.data.transactions = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                    this.refreshCurrentView();
                    document.getElementById('loading-overlay').classList.add('hidden');
                });
            },

            initBackground() {
                const container = document.getElementById('bg-particles');
                for(let i=0; i<15; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    p.style.width = p.style.height = (Math.random()*20 + 5) + 'px';
                    p.style.left = Math.random()*100 + 'vw';
                    p.style.animationDuration = (Math.random()*10 + 10) + 's';
                    p.style.animationDelay = Math.random()*5 + 's';
                    container.appendChild(p);
                }
            },

            navigate(viewId) {
                this.data.currentView = viewId;
                document.querySelectorAll('section[id^="view-"]').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                
                // Desktop UI
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-slate-100', 'text-slate-900'));
                document.getElementById(`nav-${viewId}`).classList.add('bg-slate-100', 'text-slate-900');
                
                // Mobile UI
                document.querySelectorAll('.bottom-nav-item').forEach(b => b.classList.remove('active'));
                document.getElementById(`mob-nav-${viewId}`).classList.add('active');

                this.refreshCurrentView();
            },

            refreshCurrentView() {
                if (this.data.currentView === 'dashboard') this.renderDashboard();
                if (this.data.currentView === 'history') this.renderHistory();
                if (this.data.currentView === 'settlement') this.calculateSettlement();
            },

            // --- LOGIN LOGIC ---
            showAdminLogin() {
                document.getElementById('admin-login-form').classList.toggle('hidden');
            },
            loginAsAdmin() {
                const u = document.getElementById('admin-user').value;
                const p = document.getElementById('admin-pass').value;
                if(u.toLowerCase() === 'admin' && p === '0000') this.completeLogin('admin');
                else alert('รหัสผ่านไม่ถูกต้อง');
            },
            completeLogin(role) {
                this.data.userRole = role;
                document.getElementById('login-screen').classList.add('hidden');
                const badge = document.getElementById('mobile-role-badge');
                badge.textContent = role.toUpperCase();
                if(role === 'admin') {
                    badge.className = "text-[10px] bg-slate-800 px-2 py-1 rounded-full font-bold text-white";
                    document.getElementById('admin-danger-zone').classList.remove('hidden');
                    document.getElementById('settlement-admin-actions').classList.remove('hidden');
                    document.getElementById('btn-export-csv').classList.remove('hidden');
                }
                this.navigate('dashboard');
            },

            // --- DATA HELPERS ---
            populateMonthSelectors() {
                const date = new Date();
                let html = "";
                for(let i=0; i<12; i++) {
                    const val = date.toISOString().slice(0, 7);
                    const label = date.toLocaleString('th-TH', { month: 'long', year: 'numeric' });
                    html += `<option value="${val}">${label}</option>`;
                    date.setMonth(date.getMonth() - 1);
                }
                document.querySelectorAll('.global-month-selector, #delete-month-selector').forEach(s => s.innerHTML = html);
            },

            setMonth(val) {
                this.data.currentMonth = val;
                document.querySelectorAll('.global-month-selector').forEach(s => s.value = val);
                this.refreshCurrentView();
            },

            populatePayerSelector() {
                const sel = document.getElementById('t-payer');
                sel.innerHTML = this.data.members.map(m => `<option value="${m}">${m}</option>`).join('');
            },

            renderMemberList() {
                const container = document.getElementById('member-list');
                container.innerHTML = this.data.members.map(m => `<span class="px-3 py-1 bg-slate-100 border rounded-full text-xs font-bold text-slate-600">${m}</span>`).join('');
            },

            async addMember() {
                const input = document.getElementById('new-member-name');
                const name = input.value.trim().toUpperCase();
                if(!name || this.data.members.includes(name)) return;
                await addDoc(collection(db, "members"), { name });
                input.value = "";
            },

            // --- SETTLEMENT (THE CRITICAL FIX) ---
            calculateSettlement() {
                const filtered = this.data.transactions.filter(t => t.date.startsWith(this.data.currentMonth));
                const balances = {};
                this.data.members.forEach(m => balances[m] = 0);

                filtered.forEach(t => {
                    const payer = (t.payer || "").toUpperCase();
                    if(balances.hasOwnProperty(payer)) balances[payer] += Number(t.amount);
                    
                    if(t.splits) {
                        Object.keys(t.splits).forEach(k => {
                            const memberKey = k.toUpperCase();
                            if(balances.hasOwnProperty(memberKey)) {
                                balances[memberKey] -= Number(t.splits[k]);
                            }
                        });
                    }
                });

                const grid = document.getElementById('settlement-status-grid');
                grid.innerHTML = "";
                this.data.members.forEach(m => {
                    const bal = Math.round(balances[m]);
                    let color = "bg-slate-50 text-slate-400";
                    let icon = "fa-circle-check";
                    let status = "เคลียร์แล้ว";

                    if(bal > 1) { color = "bg-emerald-50 text-emerald-700 border-emerald-100"; icon = "fa-hand-holding-dollar"; status = "รอรับเงิน"; }
                    else if(bal < -1) { color = "bg-red-50 text-red-700 border-red-100"; icon = "fa-money-bill-wave"; status = "ต้องจ่ายคืน"; }

                    const card = document.createElement('div');
                    card.className = `p-4 rounded-2xl border flex flex-col items-center text-center cursor-pointer transition-all active:scale-95 ${color}`;
                    card.onclick = () => this.showMemberDetails(m);
                    card.innerHTML = `
                        <i class="fa-solid ${icon} mb-1 opacity-70"></i>
                        <span class="text-xs font-bold">${m}</span>
                        <span class="text-[9px] uppercase tracking-tighter opacity-60 mb-1">${status}</span>
                        <span class="text-base font-bold">${bal === 0 ? '-' : Math.abs(bal).toLocaleString() + ' ฿'}</span>
                    `;
                    grid.appendChild(card);
                });

                // Simple Debt Plan
                const debtors = [], creditors = [];
                this.data.members.forEach(m => {
                    const b = Math.round(balances[m]);
                    if(b < -1) debtors.push({ name: m, amount: Math.abs(b) });
                    if(b > 1) creditors.push({ name: m, amount: b });
                });

                const plan = document.getElementById('settlement-plan');
                plan.innerHTML = "";
                
                let i=0, j=0;
                while(i < debtors.length && j < creditors.length) {
                    const d = debtors[i], c = creditors[j];
                    const pay = Math.min(d.amount, c.amount);
                    plan.innerHTML += `
                        <div class="flex items-center justify-between bg-white p-3 rounded-xl border text-sm">
                            <div class="font-bold text-slate-700">${d.name} <i class="fa-solid fa-arrow-right text-[10px] mx-1 text-slate-300"></i> ${c.name}</div>
                            <div class="font-bold text-red-500">${pay.toLocaleString()} ฿</div>
                        </div>
                    `;
                    d.amount -= pay; c.amount -= pay;
                    if(d.amount <= 1) i++;
                    if(c.amount <= 1) j++;
                }
                if(!plan.innerHTML) plan.innerHTML = `<div class="text-center py-4 text-slate-300 text-xs italic">ไม่มีรายการค้างชำระ</div>`;
            },

            showMemberDetails(member) {
                const target = member.toUpperCase();
                const filtered = this.data.transactions.filter(t => t.date.startsWith(this.data.currentMonth))
                                 .filter(t => {
                                    const isPayer = (t.payer || "").toUpperCase() === target;
                                    const isSharer = Object.keys(t.splits || {}).some(k => k.toUpperCase() === target);
                                    return isPayer || isSharer;
                                 });

                const list = document.getElementById('member-detail-list');
                list.innerHTML = "";
                let totalSpent = 0;

                filtered.forEach(t => {
                    // Find split amount for this member (Case-Insensitive)
                    let myShare = 0;
                    const splitKeys = Object.keys(t.splits || {});
                    const matchKey = splitKeys.find(k => k.toUpperCase() === target);
                    if(matchKey) myShare = Number(t.splits[matchKey]);

                    totalSpent += myShare;
                    const isPayer = (t.payer || "").toUpperCase() === target;
                    const dateShort = new Date(t.date).toLocaleDateString('th-TH', {day:'numeric', month:'short'});

                    list.innerHTML += `
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex justify-between items-center">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">${dateShort}</span>
                                <span class="text-xs font-bold text-slate-700">${t.desc}</span>
                                <span class="text-[9px] text-slate-400">${isPayer ? 'คุณจ่ายเงิน' : 'จ่ายโดย ' + t.payer} • ยอดเต็ม ${t.amount}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-slate-800">-${myShare.toLocaleString()}</div>
                                <div class="text-[8px] font-bold text-slate-400 uppercase tracking-tighter">ยอดสุทธิ</div>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('member-detail-title').textContent = `ประวัติของ ${target}`;
                document.getElementById('member-detail-total').textContent = `${totalSpent.toLocaleString()} ฿`;
                document.getElementById('member-detail-modal').classList.remove('hidden');
            },

            // --- DASHBOARD CHARTS ---
            renderDashboard() {
                const filtered = this.data.transactions.filter(t => t.date.startsWith(this.data.currentMonth));
                const total = filtered.reduce((acc, t) => acc + Number(t.amount), 0);
                document.getElementById('total-expense').textContent = total.toLocaleString() + ' ฿';
                
                this.renderMonthlyTrendChart();
                
                const payers = {};
                filtered.forEach(t => {
                    const p = (t.payer || "N/A").toUpperCase();
                    payers[p] = (payers[p] || 0) + Number(t.amount);
                });
                this.renderPayerChart(payers);
            },

            renderMonthlyTrendChart() {
                const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
                if(this.charts.monthlyTrend) this.charts.monthlyTrend.destroy();
                
                const months = [], amounts = [];
                const d = new Date();
                for(let i=0; i<12; i++) {
                    const key = d.toISOString().slice(0, 7);
                    months.unshift(d.toLocaleString('th-TH', {month:'short'}));
                    const monthTotal = this.data.transactions.filter(t => t.date.startsWith(key)).reduce((a, t) => a + Number(t.amount), 0);
                    amounts.unshift(monthTotal);
                    d.setMonth(d.getMonth() - 1);
                }

                this.charts.monthlyTrend = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{ data: amounts, backgroundColor: months.map((_,i) => i === 11 ? '#1e293b' : '#cbd5e1'), borderRadius: 5 }]
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false, 
                        plugins: { legend: { display: false } },
                        scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 9 } } } }
                    }
                });
            },

            renderPayerChart(data) {
                const ctx = document.getElementById('payerChart').getContext('2d');
                if(this.charts.payer) this.charts.payer.destroy();
                this.charts.payer = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data),
                        datasets: [{ data: Object.values(data), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'], borderWidth: 0 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, cutout: '65%',
                        plugins: { 
                            legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } },
                            datalabels: { color: '#fff', font: { weight: 'bold', size: 10 }, formatter: (v) => v > 0 ? v.toLocaleString() : "" }
                        }
                    }
                });
            },

            // --- CRUD ---
            openModal(id) { document.getElementById(id).classList.remove('hidden'); this.renderSplitParticipants(); },
            closeModal(id) { document.getElementById(id).classList.add('hidden'); },
            toggleInstallment() { document.getElementById('t-installment-wrapper').classList.toggle('hidden', document.getElementById('t-payment-type').value !== 'installment'); },
            setSplitMode(m) {
                this.data.splitMode = m;
                document.getElementById('btn-split-equal').className = m === 'equal' ? 'px-3 py-1 rounded-md text-[10px] font-bold bg-slate-800 text-white' : 'px-3 py-1 rounded-md text-[10px] font-bold text-slate-400';
                document.getElementById('btn-split-custom').className = m === 'custom' ? 'px-3 py-1 rounded-md text-[10px] font-bold bg-slate-800 text-white' : 'px-3 py-1 rounded-md text-[10px] font-bold text-slate-400';
                this.renderSplitParticipants();
            },
            renderSplitParticipants() {
                const container = document.getElementById('split-participants');
                container.innerHTML = this.data.members.map(m => `
                    <div class="flex items-center justify-between text-xs py-1 border-b border-white/50 last:border-0">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" checked value="${m}" class="participant-check rounded text-slate-800 w-4 h-4">
                            <span class="text-slate-700 font-medium">${m}</span>
                        </label>
                        ${this.data.splitMode === 'custom' ? `<input type="number" step="0.01" data-member="${m}" class="participant-amount w-16 p-1 border rounded text-right text-[10px]">` : ''}
                    </div>
                `).join('');
            },

            async saveTransaction() {
                const amount = Number(document.getElementById('t-amount').value);
                const desc = document.getElementById('t-desc').value || "ทั่วไป";
                const payer = document.getElementById('t-payer').value;
                const type = document.getElementById('t-payment-type').value;
                const date = document.getElementById('t-date').value;
                if(!amount || !date) return alert('กรอกข้อมูลไม่ครบ');

                const splits = {};
                if(this.data.splitMode === 'equal') {
                    const checked = Array.from(document.querySelectorAll('.participant-check:checked')).map(c => c.value);
                    const share = amount / checked.length;
                    checked.forEach(m => splits[m] = share);
                } else {
                    document.querySelectorAll('.participant-amount').forEach(i => {
                        const val = Number(i.value);
                        if(val > 0) splits[i.dataset.member] = val;
                    });
                }

                const batch = writeBatch(db);
                const installments = type === 'installment' ? Number(document.getElementById('t-installments').value) || 1 : 1;
                const baseDate = new Date(date);

                for(let i=0; i<installments; i++) {
                    const currentInstallmentDate = new Date(baseDate);
                    currentInstallmentDate.setMonth(baseDate.getMonth() + i);
                    const txn = {
                        date: currentInstallmentDate.toISOString().slice(0, 10),
                        desc: installments > 1 ? `${desc} (${i+1}/${installments})` : desc,
                        amount: amount / installments,
                        payer,
                        splits: Object.fromEntries(Object.entries(splits).map(([k,v]) => [k, v/installments])),
                        paymentType: type,
                        timestamp: Date.now() + i
                    };
                    batch.set(doc(collection(db, "transactions")), txn);
                }
                await batch.commit();
                this.closeModal('transaction-modal');
            },

            async deleteTransaction(id) {
                if(this.data.userRole !== 'admin') return;
                if(confirm('ยืนยันลบรายการนี้?')) {
                    await deleteDoc(doc(db, "transactions", id.trim()));
                }
            },

            renderHistory() {
                const filtered = this.data.transactions.filter(t => t.date.startsWith(this.data.currentMonth)).sort((a,b) => b.date.localeCompare(a.date));
                const container = document.getElementById('transaction-list-mobile');
                const empty = document.getElementById('empty-state');
                container.innerHTML = "";
                
                if(filtered.length === 0) return empty.classList.remove('hidden');
                empty.classList.add('hidden');

                filtered.forEach(t => {
                    const isAdmin = this.data.userRole === 'admin';
                    container.innerHTML += `
                        <div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 border">
                                    <i class="fa-solid fa-utensils"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-700 text-sm">${t.desc}</p>
                                    <p class="text-[10px] text-slate-400 uppercase font-bold">${t.payer} • ${new Date(t.date).toLocaleDateString('th-TH')}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-slate-800">${Number(t.amount).toLocaleString()}</span>
                                ${isAdmin ? `<button onclick="window.app.deleteTransaction('${t.id}')" class="text-red-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>` : ''}
                            </div>
                        </div>
                    `;
                });
            },

            async clearMonthData() {
                if(this.data.userRole !== 'admin') return;
                const m = document.getElementById('delete-month-selector').value;
                if(confirm(`ยืนยันลบข้อมูลทั้งหมดของเดือน ${m}?`)) {
                    const toDelete = this.data.transactions.filter(t => t.date.startsWith(m));
                    const batch = writeBatch(db);
                    toDelete.forEach(t => batch.delete(doc(db, "transactions", t.id)));
                    await batch.commit();
                    alert('ลบข้อมูลเรียบร้อย');
                }
            }
        };

        window.app = app;
        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
